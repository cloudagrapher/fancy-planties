efc18663d4f3e3916de262cd6f04cb4e
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: Object.getOwnPropertyDescriptor(all, name).get
    });
}
_export(exports, {
    get DELETE () {
        return DELETE;
    },
    get GET () {
        return GET;
    },
    get PUT () {
        return PUT;
    }
});
const _server = require("next/server");
const _zod = require("zod");
const _plantinstances = require("../../../../lib/db/queries/plant-instances");
const _plantschemas = require("../../../../lib/validation/plant-schemas");
const _server1 = require("../../../../lib/auth/server");
async function GET(request, { params }) {
    try {
        const { user } = await (0, _server1.validateRequest)();
        if (!user) {
            return _server.NextResponse.json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        const resolvedParams = await params;
        const id = parseInt(resolvedParams.id, 10);
        if (isNaN(id)) {
            return _server.NextResponse.json({
                error: 'Invalid plant instance ID'
            }, {
                status: 400
            });
        }
        const plantInstance = await _plantinstances.PlantInstanceQueries.getEnhancedById(id);
        if (!plantInstance) {
            return _server.NextResponse.json({
                error: 'Plant instance not found'
            }, {
                status: 404
            });
        }
        // Check if the plant instance belongs to the current user
        if (plantInstance.userId !== user.id) {
            return _server.NextResponse.json({
                error: 'Forbidden'
            }, {
                status: 403
            });
        }
        return _server.NextResponse.json(plantInstance);
    } catch (error) {
        console.error('Failed to get plant instance:', error);
        return _server.NextResponse.json({
            error: 'Failed to get plant instance'
        }, {
            status: 500
        });
    }
}
async function PUT(request, { params }) {
    try {
        const { user } = await (0, _server1.validateRequest)();
        if (!user) {
            return _server.NextResponse.json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        const resolvedParams = await params;
        const id = parseInt(resolvedParams.id, 10);
        if (isNaN(id)) {
            return _server.NextResponse.json({
                error: 'Invalid plant instance ID'
            }, {
                status: 400
            });
        }
        // Check if the plant instance exists and belongs to the user
        const existingInstance = await _plantinstances.PlantInstanceQueries.getEnhancedById(id);
        if (!existingInstance) {
            return _server.NextResponse.json({
                error: 'Plant instance not found'
            }, {
                status: 404
            });
        }
        if (existingInstance.userId !== user.id) {
            return _server.NextResponse.json({
                error: 'Forbidden'
            }, {
                status: 403
            });
        }
        // Check if request is FormData or JSON
        const contentType = request.headers.get('content-type');
        let body;
        if (contentType?.includes('multipart/form-data')) {
            // Handle FormData for file uploads
            const formData = await request.formData();
            // Helper function to convert file to base64
            const fileToBase64 = async (file)=>{
                const bytes = await file.arrayBuffer();
                const buffer = Buffer.from(bytes);
                const base64 = buffer.toString('base64');
                return `data:${file.type};base64,${base64}`;
            };
            // Extract form fields
            body = {};
            const imageFiles = [];
            const existingImages = [];
            for (const [key, value] of formData.entries()){
                if (key.startsWith('existingImages[')) {
                    // Handle existing images array
                    existingImages.push(value);
                } else if (key.startsWith('imageFiles[')) {
                    // Handle new image files
                    if (value instanceof File) {
                        imageFiles.push(value);
                    }
                } else {
                    // Handle regular form fields
                    if (key === 'plantId') {
                        body[key] = parseInt(value, 10);
                    } else if (key === 'isActive') {
                        body[key] = value === 'true';
                    } else {
                        body[key] = value;
                    }
                }
            }
            // Convert new image files to base64
            const newImageBase64s = await Promise.all(imageFiles.map((file)=>fileToBase64(file)));
            // Combine existing images with new images
            body.images = [
                ...existingImages,
                ...newImageBase64s
            ];
        } else {
            // Handle JSON
            try {
                body = await request.json();
            } catch (jsonError) {
                return _server.NextResponse.json({
                    error: 'Invalid request format'
                }, {
                    status: 400
                });
            }
        }
        // Convert date strings to Date objects if they exist and are not empty
        const processedBody = {
            ...body,
            lastFertilized: body.lastFertilized && body.lastFertilized !== '' ? new Date(body.lastFertilized) : null,
            lastRepot: body.lastRepot && body.lastRepot !== '' ? new Date(body.lastRepot) : null
        };
        // Validate the update data
        const updateData = _plantschemas.updatePlantInstanceSchema.parse({
            ...processedBody,
            id,
            userId: user.id
        });
        // Remove id and userId from update data as they shouldn't be updated
        const { id: _, userId: __, ...dataToUpdate } = updateData;
        // Update the plant instance
        const updatedInstance = await _plantinstances.PlantInstanceQueries.update(id, dataToUpdate);
        // Get the enhanced plant instance with plant data
        const enhancedInstance = await _plantinstances.PlantInstanceQueries.getEnhancedById(updatedInstance.id);
        return _server.NextResponse.json(enhancedInstance);
    } catch (error) {
        console.error('Failed to update plant instance:', error);
        if (error instanceof _zod.z.ZodError) {
            return _server.NextResponse.json({
                error: 'Invalid plant instance data',
                details: error.issues
            }, {
                status: 400
            });
        }
        if (error instanceof Error && error.message.includes('validation')) {
            return _server.NextResponse.json({
                error: 'Invalid plant instance data',
                details: error.message
            }, {
                status: 400
            });
        }
        return _server.NextResponse.json({
            error: 'Failed to update plant instance'
        }, {
            status: 500
        });
    }
}
async function DELETE(request, { params }) {
    try {
        const { user } = await (0, _server1.validateRequest)();
        if (!user) {
            return _server.NextResponse.json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        const resolvedParams = await params;
        const id = parseInt(resolvedParams.id, 10);
        if (isNaN(id)) {
            return _server.NextResponse.json({
                error: 'Invalid plant instance ID'
            }, {
                status: 400
            });
        }
        // Check if the plant instance exists and belongs to the user
        const existingInstance = await _plantinstances.PlantInstanceQueries.getEnhancedById(id);
        if (!existingInstance) {
            return _server.NextResponse.json({
                error: 'Plant instance not found'
            }, {
                status: 404
            });
        }
        if (existingInstance.userId !== user.id) {
            return _server.NextResponse.json({
                error: 'Forbidden'
            }, {
                status: 403
            });
        }
        // Delete the plant instance
        const deleted = await _plantinstances.PlantInstanceQueries.delete(id);
        if (!deleted) {
            return _server.NextResponse.json({
                error: 'Failed to delete plant instance'
            }, {
                status: 500
            });
        }
        return _server.NextResponse.json({
            success: true,
            message: 'Plant instance deleted successfully'
        });
    } catch (error) {
        console.error('Failed to delete plant instance:', error);
        return _server.NextResponse.json({
            error: 'Failed to delete plant instance'
        }, {
            status: 500
        });
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9zdGVmYW5iZWtrZXIvcHJvamVjdHMvZmFuY3ktcGxhbnRpZXMvc3JjL2FwcC9hcGkvcGxhbnQtaW5zdGFuY2VzL1tpZF0vcm91dGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmV4dFJlcXVlc3QsIE5leHRSZXNwb25zZSB9IGZyb20gJ25leHQvc2VydmVyJztcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xuaW1wb3J0IHsgUGxhbnRJbnN0YW5jZVF1ZXJpZXMgfSBmcm9tICdAL2xpYi9kYi9xdWVyaWVzL3BsYW50LWluc3RhbmNlcyc7XG5pbXBvcnQgeyB1cGRhdGVQbGFudEluc3RhbmNlU2NoZW1hIH0gZnJvbSAnQC9saWIvdmFsaWRhdGlvbi9wbGFudC1zY2hlbWFzJztcbmltcG9ydCB7IHZhbGlkYXRlUmVxdWVzdCB9IGZyb20gJ0AvbGliL2F1dGgvc2VydmVyJztcblxuLy8gR0VUIC9hcGkvcGxhbnQtaW5zdGFuY2VzL1tpZF0gLSBHZXQgYSBzcGVjaWZpYyBwbGFudCBpbnN0YW5jZVxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIEdFVChcbiAgcmVxdWVzdDogTmV4dFJlcXVlc3QsXG4gIHsgcGFyYW1zIH06IHsgcGFyYW1zOiBQcm9taXNlPHsgaWQ6IHN0cmluZyB9PiB9XG4pIHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IHVzZXIgfSA9IGF3YWl0IHZhbGlkYXRlUmVxdWVzdCgpO1xuICAgIGlmICghdXNlcikge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0sIHsgc3RhdHVzOiA0MDEgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzb2x2ZWRQYXJhbXMgPSBhd2FpdCBwYXJhbXM7XG4gICAgY29uc3QgaWQgPSBwYXJzZUludChyZXNvbHZlZFBhcmFtcy5pZCwgMTApO1xuICAgIGlmIChpc05hTihpZCkpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnSW52YWxpZCBwbGFudCBpbnN0YW5jZSBJRCcgfSwgeyBzdGF0dXM6IDQwMCB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBwbGFudEluc3RhbmNlID0gYXdhaXQgUGxhbnRJbnN0YW5jZVF1ZXJpZXMuZ2V0RW5oYW5jZWRCeUlkKGlkKTtcblxuICAgIGlmICghcGxhbnRJbnN0YW5jZSkge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6ICdQbGFudCBpbnN0YW5jZSBub3QgZm91bmQnIH0sIHsgc3RhdHVzOiA0MDQgfSk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdGhlIHBsYW50IGluc3RhbmNlIGJlbG9uZ3MgdG8gdGhlIGN1cnJlbnQgdXNlclxuICAgIGlmIChwbGFudEluc3RhbmNlLnVzZXJJZCAhPT0gdXNlci5pZCkge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6ICdGb3JiaWRkZW4nIH0sIHsgc3RhdHVzOiA0MDMgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHBsYW50SW5zdGFuY2UpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBnZXQgcGxhbnQgaW5zdGFuY2U6JywgZXJyb3IpO1xuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgIHsgZXJyb3I6ICdGYWlsZWQgdG8gZ2V0IHBsYW50IGluc3RhbmNlJyB9LFxuICAgICAgeyBzdGF0dXM6IDUwMCB9XG4gICAgKTtcbiAgfVxufVxuXG4vLyBQVVQgL2FwaS9wbGFudC1pbnN0YW5jZXMvW2lkXSAtIFVwZGF0ZSBhIHBsYW50IGluc3RhbmNlXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gUFVUKFxuICByZXF1ZXN0OiBOZXh0UmVxdWVzdCxcbiAgeyBwYXJhbXMgfTogeyBwYXJhbXM6IFByb21pc2U8eyBpZDogc3RyaW5nIH0+IH1cbikge1xuICB0cnkge1xuICAgIGNvbnN0IHsgdXNlciB9ID0gYXdhaXQgdmFsaWRhdGVSZXF1ZXN0KCk7XG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSwgeyBzdGF0dXM6IDQwMSB9KTtcbiAgICB9XG5cbiAgICBjb25zdCByZXNvbHZlZFBhcmFtcyA9IGF3YWl0IHBhcmFtcztcbiAgICBjb25zdCBpZCA9IHBhcnNlSW50KHJlc29sdmVkUGFyYW1zLmlkLCAxMCk7XG4gICAgaWYgKGlzTmFOKGlkKSkge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6ICdJbnZhbGlkIHBsYW50IGluc3RhbmNlIElEJyB9LCB7IHN0YXR1czogNDAwIH0pO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHRoZSBwbGFudCBpbnN0YW5jZSBleGlzdHMgYW5kIGJlbG9uZ3MgdG8gdGhlIHVzZXJcbiAgICBjb25zdCBleGlzdGluZ0luc3RhbmNlID0gYXdhaXQgUGxhbnRJbnN0YW5jZVF1ZXJpZXMuZ2V0RW5oYW5jZWRCeUlkKGlkKTtcbiAgICBpZiAoIWV4aXN0aW5nSW5zdGFuY2UpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnUGxhbnQgaW5zdGFuY2Ugbm90IGZvdW5kJyB9LCB7IHN0YXR1czogNDA0IH0pO1xuICAgIH1cblxuICAgIGlmIChleGlzdGluZ0luc3RhbmNlLnVzZXJJZCAhPT0gdXNlci5pZCkge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6ICdGb3JiaWRkZW4nIH0sIHsgc3RhdHVzOiA0MDMgfSk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgcmVxdWVzdCBpcyBGb3JtRGF0YSBvciBKU09OXG4gICAgY29uc3QgY29udGVudFR5cGUgPSByZXF1ZXN0LmhlYWRlcnMuZ2V0KCdjb250ZW50LXR5cGUnKTtcbiAgICBsZXQgYm9keTogYW55O1xuXG4gICAgaWYgKGNvbnRlbnRUeXBlPy5pbmNsdWRlcygnbXVsdGlwYXJ0L2Zvcm0tZGF0YScpKSB7XG4gICAgICAvLyBIYW5kbGUgRm9ybURhdGEgZm9yIGZpbGUgdXBsb2Fkc1xuICAgICAgY29uc3QgZm9ybURhdGEgPSBhd2FpdCByZXF1ZXN0LmZvcm1EYXRhKCk7XG5cbiAgICAgIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb252ZXJ0IGZpbGUgdG8gYmFzZTY0XG4gICAgICBjb25zdCBmaWxlVG9CYXNlNjQgPSBhc3luYyAoZmlsZTogRmlsZSk6IFByb21pc2U8c3RyaW5nPiA9PiB7XG4gICAgICAgIGNvbnN0IGJ5dGVzID0gYXdhaXQgZmlsZS5hcnJheUJ1ZmZlcigpO1xuICAgICAgICBjb25zdCBidWZmZXIgPSBCdWZmZXIuZnJvbShieXRlcyk7XG4gICAgICAgIGNvbnN0IGJhc2U2NCA9IGJ1ZmZlci50b1N0cmluZygnYmFzZTY0Jyk7XG4gICAgICAgIHJldHVybiBgZGF0YToke2ZpbGUudHlwZX07YmFzZTY0LCR7YmFzZTY0fWA7XG4gICAgICB9O1xuXG4gICAgICAvLyBFeHRyYWN0IGZvcm0gZmllbGRzXG4gICAgICBib2R5ID0ge307XG4gICAgICBjb25zdCBpbWFnZUZpbGVzOiBGaWxlW10gPSBbXTtcbiAgICAgIGNvbnN0IGV4aXN0aW5nSW1hZ2VzOiAoc3RyaW5nIHwgRm9ybURhdGFFbnRyeVZhbHVlKVtdID0gW107XG5cbiAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIGZvcm1EYXRhLmVudHJpZXMoKSkge1xuICAgICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoJ2V4aXN0aW5nSW1hZ2VzWycpKSB7XG4gICAgICAgICAgLy8gSGFuZGxlIGV4aXN0aW5nIGltYWdlcyBhcnJheVxuICAgICAgICAgIGV4aXN0aW5nSW1hZ2VzLnB1c2godmFsdWUpO1xuICAgICAgICB9IGVsc2UgaWYgKGtleS5zdGFydHNXaXRoKCdpbWFnZUZpbGVzWycpKSB7XG4gICAgICAgICAgLy8gSGFuZGxlIG5ldyBpbWFnZSBmaWxlc1xuICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEZpbGUpIHtcbiAgICAgICAgICAgIGltYWdlRmlsZXMucHVzaCh2YWx1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIEhhbmRsZSByZWd1bGFyIGZvcm0gZmllbGRzXG4gICAgICAgICAgaWYgKGtleSA9PT0gJ3BsYW50SWQnKSB7XG4gICAgICAgICAgICBib2R5W2tleV0gPSBwYXJzZUludCh2YWx1ZSBhcyBzdHJpbmcsIDEwKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ2lzQWN0aXZlJykge1xuICAgICAgICAgICAgYm9keVtrZXldID0gdmFsdWUgPT09ICd0cnVlJztcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYm9keVtrZXldID0gdmFsdWU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIENvbnZlcnQgbmV3IGltYWdlIGZpbGVzIHRvIGJhc2U2NFxuICAgICAgY29uc3QgbmV3SW1hZ2VCYXNlNjRzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgIGltYWdlRmlsZXMubWFwKGZpbGUgPT4gZmlsZVRvQmFzZTY0KGZpbGUpKVxuICAgICAgKTtcblxuICAgICAgLy8gQ29tYmluZSBleGlzdGluZyBpbWFnZXMgd2l0aCBuZXcgaW1hZ2VzXG4gICAgICBib2R5LmltYWdlcyA9IFsuLi5leGlzdGluZ0ltYWdlcywgLi4ubmV3SW1hZ2VCYXNlNjRzXTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gSGFuZGxlIEpTT05cbiAgICAgIHRyeSB7XG4gICAgICAgIGJvZHkgPSBhd2FpdCByZXF1ZXN0Lmpzb24oKTtcbiAgICAgIH0gY2F0Y2ggKGpzb25FcnJvcikge1xuICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgICAgeyBlcnJvcjogJ0ludmFsaWQgcmVxdWVzdCBmb3JtYXQnIH0sXG4gICAgICAgICAgeyBzdGF0dXM6IDQwMCB9XG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ29udmVydCBkYXRlIHN0cmluZ3MgdG8gRGF0ZSBvYmplY3RzIGlmIHRoZXkgZXhpc3QgYW5kIGFyZSBub3QgZW1wdHlcbiAgICBjb25zdCBwcm9jZXNzZWRCb2R5ID0ge1xuICAgICAgLi4uYm9keSxcbiAgICAgIGxhc3RGZXJ0aWxpemVkOiBib2R5Lmxhc3RGZXJ0aWxpemVkICYmIGJvZHkubGFzdEZlcnRpbGl6ZWQgIT09ICcnID8gbmV3IERhdGUoYm9keS5sYXN0RmVydGlsaXplZCkgOiBudWxsLFxuICAgICAgbGFzdFJlcG90OiBib2R5Lmxhc3RSZXBvdCAmJiBib2R5Lmxhc3RSZXBvdCAhPT0gJycgPyBuZXcgRGF0ZShib2R5Lmxhc3RSZXBvdCkgOiBudWxsLFxuICAgIH07XG5cbiAgICAvLyBWYWxpZGF0ZSB0aGUgdXBkYXRlIGRhdGFcbiAgICBjb25zdCB1cGRhdGVEYXRhID0gdXBkYXRlUGxhbnRJbnN0YW5jZVNjaGVtYS5wYXJzZSh7XG4gICAgICAuLi5wcm9jZXNzZWRCb2R5LFxuICAgICAgaWQsXG4gICAgICB1c2VySWQ6IHVzZXIuaWQsXG4gICAgfSk7XG5cbiAgICAvLyBSZW1vdmUgaWQgYW5kIHVzZXJJZCBmcm9tIHVwZGF0ZSBkYXRhIGFzIHRoZXkgc2hvdWxkbid0IGJlIHVwZGF0ZWRcbiAgICBjb25zdCB7IGlkOiBfLCB1c2VySWQ6IF9fLCAuLi5kYXRhVG9VcGRhdGUgfSA9IHVwZGF0ZURhdGE7XG5cbiAgICAvLyBVcGRhdGUgdGhlIHBsYW50IGluc3RhbmNlXG4gICAgY29uc3QgdXBkYXRlZEluc3RhbmNlID0gYXdhaXQgUGxhbnRJbnN0YW5jZVF1ZXJpZXMudXBkYXRlKGlkLCBkYXRhVG9VcGRhdGUpO1xuXG4gICAgLy8gR2V0IHRoZSBlbmhhbmNlZCBwbGFudCBpbnN0YW5jZSB3aXRoIHBsYW50IGRhdGFcbiAgICBjb25zdCBlbmhhbmNlZEluc3RhbmNlID0gYXdhaXQgUGxhbnRJbnN0YW5jZVF1ZXJpZXMuZ2V0RW5oYW5jZWRCeUlkKHVwZGF0ZWRJbnN0YW5jZS5pZCk7XG5cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oZW5oYW5jZWRJbnN0YW5jZSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHVwZGF0ZSBwbGFudCBpbnN0YW5jZTonLCBlcnJvcik7XG5cbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiB6LlpvZEVycm9yKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgZXJyb3I6ICdJbnZhbGlkIHBsYW50IGluc3RhbmNlIGRhdGEnLCBkZXRhaWxzOiBlcnJvci5pc3N1ZXMgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yICYmIGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ3ZhbGlkYXRpb24nKSkge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IGVycm9yOiAnSW52YWxpZCBwbGFudCBpbnN0YW5jZSBkYXRhJywgZGV0YWlsczogZXJyb3IubWVzc2FnZSB9LFxuICAgICAgICB7IHN0YXR1czogNDAwIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgeyBlcnJvcjogJ0ZhaWxlZCB0byB1cGRhdGUgcGxhbnQgaW5zdGFuY2UnIH0sXG4gICAgICB7IHN0YXR1czogNTAwIH1cbiAgICApO1xuICB9XG59XG5cbi8vIERFTEVURSAvYXBpL3BsYW50LWluc3RhbmNlcy9baWRdIC0gRGVsZXRlIGEgcGxhbnQgaW5zdGFuY2VcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBERUxFVEUoXG4gIHJlcXVlc3Q6IE5leHRSZXF1ZXN0LFxuICB7IHBhcmFtcyB9OiB7IHBhcmFtczogUHJvbWlzZTx7IGlkOiBzdHJpbmcgfT4gfVxuKSB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyB1c2VyIH0gPSBhd2FpdCB2YWxpZGF0ZVJlcXVlc3QoKTtcbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9LCB7IHN0YXR1czogNDAxIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHJlc29sdmVkUGFyYW1zID0gYXdhaXQgcGFyYW1zO1xuICAgIGNvbnN0IGlkID0gcGFyc2VJbnQocmVzb2x2ZWRQYXJhbXMuaWQsIDEwKTtcbiAgICBpZiAoaXNOYU4oaWQpKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgcGxhbnQgaW5zdGFuY2UgSUQnIH0sIHsgc3RhdHVzOiA0MDAgfSk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdGhlIHBsYW50IGluc3RhbmNlIGV4aXN0cyBhbmQgYmVsb25ncyB0byB0aGUgdXNlclxuICAgIGNvbnN0IGV4aXN0aW5nSW5zdGFuY2UgPSBhd2FpdCBQbGFudEluc3RhbmNlUXVlcmllcy5nZXRFbmhhbmNlZEJ5SWQoaWQpO1xuICAgIGlmICghZXhpc3RpbmdJbnN0YW5jZSkge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6ICdQbGFudCBpbnN0YW5jZSBub3QgZm91bmQnIH0sIHsgc3RhdHVzOiA0MDQgfSk7XG4gICAgfVxuXG4gICAgaWYgKGV4aXN0aW5nSW5zdGFuY2UudXNlcklkICE9PSB1c2VyLmlkKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ0ZvcmJpZGRlbicgfSwgeyBzdGF0dXM6IDQwMyB9KTtcbiAgICB9XG5cbiAgICAvLyBEZWxldGUgdGhlIHBsYW50IGluc3RhbmNlXG4gICAgY29uc3QgZGVsZXRlZCA9IGF3YWl0IFBsYW50SW5zdGFuY2VRdWVyaWVzLmRlbGV0ZShpZCk7XG5cbiAgICBpZiAoIWRlbGV0ZWQpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnRmFpbGVkIHRvIGRlbGV0ZSBwbGFudCBpbnN0YW5jZScgfSwgeyBzdGF0dXM6IDUwMCB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBzdWNjZXNzOiB0cnVlLCBtZXNzYWdlOiAnUGxhbnQgaW5zdGFuY2UgZGVsZXRlZCBzdWNjZXNzZnVsbHknIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBkZWxldGUgcGxhbnQgaW5zdGFuY2U6JywgZXJyb3IpO1xuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgIHsgZXJyb3I6ICdGYWlsZWQgdG8gZGVsZXRlIHBsYW50IGluc3RhbmNlJyB9LFxuICAgICAgeyBzdGF0dXM6IDUwMCB9XG4gICAgKTtcbiAgfVxufSJdLCJuYW1lcyI6WyJERUxFVEUiLCJHRVQiLCJQVVQiLCJyZXF1ZXN0IiwicGFyYW1zIiwidXNlciIsInZhbGlkYXRlUmVxdWVzdCIsIk5leHRSZXNwb25zZSIsImpzb24iLCJlcnJvciIsInN0YXR1cyIsInJlc29sdmVkUGFyYW1zIiwiaWQiLCJwYXJzZUludCIsImlzTmFOIiwicGxhbnRJbnN0YW5jZSIsIlBsYW50SW5zdGFuY2VRdWVyaWVzIiwiZ2V0RW5oYW5jZWRCeUlkIiwidXNlcklkIiwiY29uc29sZSIsImV4aXN0aW5nSW5zdGFuY2UiLCJjb250ZW50VHlwZSIsImhlYWRlcnMiLCJnZXQiLCJib2R5IiwiaW5jbHVkZXMiLCJmb3JtRGF0YSIsImZpbGVUb0Jhc2U2NCIsImZpbGUiLCJieXRlcyIsImFycmF5QnVmZmVyIiwiYnVmZmVyIiwiQnVmZmVyIiwiZnJvbSIsImJhc2U2NCIsInRvU3RyaW5nIiwidHlwZSIsImltYWdlRmlsZXMiLCJleGlzdGluZ0ltYWdlcyIsImtleSIsInZhbHVlIiwiZW50cmllcyIsInN0YXJ0c1dpdGgiLCJwdXNoIiwiRmlsZSIsIm5ld0ltYWdlQmFzZTY0cyIsIlByb21pc2UiLCJhbGwiLCJtYXAiLCJpbWFnZXMiLCJqc29uRXJyb3IiLCJwcm9jZXNzZWRCb2R5IiwibGFzdEZlcnRpbGl6ZWQiLCJEYXRlIiwibGFzdFJlcG90IiwidXBkYXRlRGF0YSIsInVwZGF0ZVBsYW50SW5zdGFuY2VTY2hlbWEiLCJwYXJzZSIsIl8iLCJfXyIsImRhdGFUb1VwZGF0ZSIsInVwZGF0ZWRJbnN0YW5jZSIsInVwZGF0ZSIsImVuaGFuY2VkSW5zdGFuY2UiLCJ6IiwiWm9kRXJyb3IiLCJkZXRhaWxzIiwiaXNzdWVzIiwiRXJyb3IiLCJtZXNzYWdlIiwiZGVsZXRlZCIsImRlbGV0ZSIsInN1Y2Nlc3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O1FBcUxzQkE7ZUFBQUE7O1FBOUtBQztlQUFBQTs7UUFzQ0FDO2VBQUFBOzs7d0JBN0NvQjtxQkFDeEI7Z0NBQ21COzhCQUNLO3lCQUNWO0FBR3pCLGVBQWVELElBQ3BCRSxPQUFvQixFQUNwQixFQUFFQyxNQUFNLEVBQXVDO0lBRS9DLElBQUk7UUFDRixNQUFNLEVBQUVDLElBQUksRUFBRSxHQUFHLE1BQU1DLElBQUFBLHdCQUFlO1FBQ3RDLElBQUksQ0FBQ0QsTUFBTTtZQUNULE9BQU9FLG9CQUFZLENBQUNDLElBQUksQ0FBQztnQkFBRUMsT0FBTztZQUFlLEdBQUc7Z0JBQUVDLFFBQVE7WUFBSTtRQUNwRTtRQUVBLE1BQU1DLGlCQUFpQixNQUFNUDtRQUM3QixNQUFNUSxLQUFLQyxTQUFTRixlQUFlQyxFQUFFLEVBQUU7UUFDdkMsSUFBSUUsTUFBTUYsS0FBSztZQUNiLE9BQU9MLG9CQUFZLENBQUNDLElBQUksQ0FBQztnQkFBRUMsT0FBTztZQUE0QixHQUFHO2dCQUFFQyxRQUFRO1lBQUk7UUFDakY7UUFFQSxNQUFNSyxnQkFBZ0IsTUFBTUMsb0NBQW9CLENBQUNDLGVBQWUsQ0FBQ0w7UUFFakUsSUFBSSxDQUFDRyxlQUFlO1lBQ2xCLE9BQU9SLG9CQUFZLENBQUNDLElBQUksQ0FBQztnQkFBRUMsT0FB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