162379957e499e865cac1ddd94d9caeb
"use strict";
// Mock Resend
jest.mock('resend', ()=>({
        Resend: jest.fn().mockImplementation(()=>({
                emails: {
                    send: jest.fn()
                }
            }))
    }));
Object.defineProperty(exports, "__esModule", {
    value: true
});
const _email = require("../email");
describe('ResendEmailService', ()=>{
    let emailService;
    let mockResend;
    beforeEach(()=>{
        const { Resend } = require('resend');
        mockResend = {
            emails: {
                send: jest.fn()
            }
        };
        Resend.mockImplementation(()=>mockResend);
        emailService = new _email.ResendEmailService({
            apiKey: 'test-api-key',
            fromEmail: 'test@example.com',
            fromName: 'Test App'
        });
    });
    afterEach(()=>{
        jest.clearAllMocks();
    });
    describe('sendVerificationEmail', ()=>{
        it('should send email successfully', async ()=>{
            mockResend.emails.send.mockResolvedValue({
                data: {
                    id: 'email-id-123'
                },
                error: null
            });
            const result = await emailService.sendVerificationEmail('user@example.com', '123456', 'John Doe');
            expect(result).toBe(true);
            expect(mockResend.emails.send).toHaveBeenCalledWith({
                from: 'Test App <test@example.com>',
                to: [
                    'user@example.com'
                ],
                subject: 'Verify your email address',
                html: expect.stringContaining('123456')
            });
        });
        it('should include user name in email template', async ()=>{
            mockResend.emails.send.mockResolvedValue({
                data: {
                    id: 'email-id-123'
                },
                error: null
            });
            await emailService.sendVerificationEmail('user@example.com', '123456', 'John Doe');
            const callArgs = mockResend.emails.send.mock.calls[0][0];
            expect(callArgs.html).toContain('Hi John Doe,');
            expect(callArgs.html).toContain('123456');
        });
        it('should retry on API errors', async ()=>{
            mockResend.emails.send.mockRejectedValueOnce(new Error('Network error')).mockResolvedValue({
                data: {
                    id: 'email-id-123'
                },
                error: null
            });
            const result = await emailService.sendVerificationEmail('user@example.com', '123456', 'John Doe');
            expect(result).toBe(true);
            expect(mockResend.emails.send).toHaveBeenCalledTimes(2);
        });
        it('should throw EmailServiceError on Resend API error', async ()=>{
            mockResend.emails.send.mockResolvedValue({
                data: null,
                error: {
                    message: 'Invalid email address'
                }
            });
            await expect(emailService.sendVerificationEmail('invalid-email', '123456', 'John Doe')).rejects.toThrow(_email.EmailServiceError);
        });
        it('should not retry on invalid email error', async ()=>{
            mockResend.emails.send.mockResolvedValue({
                data: null,
                error: {
                    message: 'Invalid email address'
                }
            });
            await expect(emailService.sendVerificationEmail('invalid-email', '123456', 'John Doe')).rejects.toThrow(_email.EmailServiceError);
            expect(mockResend.emails.send).toHaveBeenCalledTimes(1);
        });
        it('should throw error after max retries', async ()=>{
            mockResend.emails.send.mockRejectedValue(new Error('Network error'));
            await expect(emailService.sendVerificationEmail('user@example.com', '123456', 'John Doe')).rejects.toThrow('Network error');
            expect(mockResend.emails.send).toHaveBeenCalledTimes(3);
        });
    });
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9zdGVmYW5iZWtrZXIvcHJvamVjdHMvZmFuY3ktcGxhbnRpZXMvc3JjL2xpYi9zZXJ2aWNlcy9fX3Rlc3RzX18vZW1haWwudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXNlbmRFbWFpbFNlcnZpY2UsIEVtYWlsU2VydmljZUVycm9yIH0gZnJvbSAnLi4vZW1haWwnO1xuXG4vLyBNb2NrIFJlc2VuZFxuamVzdC5tb2NrKCdyZXNlbmQnLCAoKSA9PiAoe1xuICBSZXNlbmQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gKHtcbiAgICBlbWFpbHM6IHtcbiAgICAgIHNlbmQ6IGplc3QuZm4oKSxcbiAgICB9LFxuICB9KSksXG59KSk7XG5cbmRlc2NyaWJlKCdSZXNlbmRFbWFpbFNlcnZpY2UnLCAoKSA9PiB7XG4gIGxldCBlbWFpbFNlcnZpY2U6IFJlc2VuZEVtYWlsU2VydmljZTtcbiAgbGV0IG1vY2tSZXNlbmQ6IGFueTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBjb25zdCB7IFJlc2VuZCB9ID0gcmVxdWlyZSgncmVzZW5kJyk7XG4gICAgbW9ja1Jlc2VuZCA9IHtcbiAgICAgIGVtYWlsczoge1xuICAgICAgICBzZW5kOiBqZXN0LmZuKCksXG4gICAgICB9LFxuICAgIH07XG4gICAgUmVzZW5kLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBtb2NrUmVzZW5kKTtcblxuICAgIGVtYWlsU2VydmljZSA9IG5ldyBSZXNlbmRFbWFpbFNlcnZpY2Uoe1xuICAgICAgYXBpS2V5OiAndGVzdC1hcGkta2V5JyxcbiAgICAgIGZyb21FbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxuICAgICAgZnJvbU5hbWU6ICdUZXN0IEFwcCcsXG4gICAgfSk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdzZW5kVmVyaWZpY2F0aW9uRW1haWwnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzZW5kIGVtYWlsIHN1Y2Nlc3NmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tSZXNlbmQuZW1haWxzLnNlbmQubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBkYXRhOiB7IGlkOiAnZW1haWwtaWQtMTIzJyB9LFxuICAgICAgICBlcnJvcjogbnVsbCxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBlbWFpbFNlcnZpY2Uuc2VuZFZlcmlmaWNhdGlvbkVtYWlsKFxuICAgICAgICAndXNlckBleGFtcGxlLmNvbScsXG4gICAgICAgICcxMjM0NTYnLFxuICAgICAgICAnSm9obiBEb2UnXG4gICAgICApO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KG1vY2tSZXNlbmQuZW1haWxzLnNlbmQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgICAgZnJvbTogJ1Rlc3QgQXBwIDx0ZXN0QGV4YW1wbGUuY29tPicsXG4gICAgICAgIHRvOiBbJ3VzZXJAZXhhbXBsZS5jb20nXSxcbiAgICAgICAgc3ViamVjdDogJ1ZlcmlmeSB5b3VyIGVtYWlsIGFkZHJlc3MnLFxuICAgICAgICBodG1sOiBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnMTIzNDU2JyksXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaW5jbHVkZSB1c2VyIG5hbWUgaW4gZW1haWwgdGVtcGxhdGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrUmVzZW5kLmVtYWlscy5zZW5kLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgZGF0YTogeyBpZDogJ2VtYWlsLWlkLTEyMycgfSxcbiAgICAgICAgZXJyb3I6IG51bGwsXG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgZW1haWxTZXJ2aWNlLnNlbmRWZXJpZmljYXRpb25FbWFpbChcbiAgICAgICAgJ3VzZXJAZXhhbXBsZS5jb20nLFxuICAgICAgICAnMTIzNDU2JyxcbiAgICAgICAgJ0pvaG4gRG9lJ1xuICAgICAgKTtcblxuICAgICAgY29uc3QgY2FsbEFyZ3MgPSBtb2NrUmVzZW5kLmVtYWlscy5zZW5kLm1vY2suY2FsbHNbMF1bMF07XG4gICAgICBleHBlY3QoY2FsbEFyZ3MuaHRtbCkudG9Db250YWluKCdIaSBKb2huIERvZSwnKTtcbiAgICAgIGV4cGVjdChjYWxsQXJncy5odG1sKS50b0NvbnRhaW4oJzEyMzQ1NicpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXRyeSBvbiBBUEkgZXJyb3JzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbW9ja1Jlc2VuZC5lbWFpbHMuc2VuZFxuICAgICAgICAubW9ja1JlamVjdGVkVmFsdWVPbmNlKG5ldyBFcnJvcignTmV0d29yayBlcnJvcicpKVxuICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICAgIGRhdGE6IHsgaWQ6ICdlbWFpbC1pZC0xMjMnIH0sXG4gICAgICAgICAgZXJyb3I6IG51bGwsXG4gICAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBlbWFpbFNlcnZpY2Uuc2VuZFZlcmlmaWNhdGlvbkVtYWlsKFxuICAgICAgICAndXNlckBleGFtcGxlLmNvbScsXG4gICAgICAgICcxMjM0NTYnLFxuICAgICAgICAnSm9obiBEb2UnXG4gICAgICApO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KG1vY2tSZXNlbmQuZW1haWxzLnNlbmQpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygyKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgRW1haWxTZXJ2aWNlRXJyb3Igb24gUmVzZW5kIEFQSSBlcnJvcicsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tSZXNlbmQuZW1haWxzLnNlbmQubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBkYXRhOiBudWxsLFxuICAgICAgICBlcnJvcjogeyBtZXNzYWdlOiAnSW52YWxpZCBlbWFpbCBhZGRyZXNzJyB9LFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgZW1haWxTZXJ2aWNlLnNlbmRWZXJpZmljYXRpb25FbWFpbCgnaW52YWxpZC1lbWFpbCcsICcxMjM0NTYnLCAnSm9obiBEb2UnKVxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coRW1haWxTZXJ2aWNlRXJyb3IpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBub3QgcmV0cnkgb24gaW52YWxpZCBlbWFpbCBlcnJvcicsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tSZXNlbmQuZW1haWxzLnNlbmQubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBkYXRhOiBudWxsLFxuICAgICAgICBlcnJvcjogeyBtZXNzYWdlOiAnSW52YWxpZCBlbWFpbCBhZGRyZXNzJyB9LFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgZW1haWxTZXJ2aWNlLnNlbmRWZXJpZmljYXRpb25FbWFpbCgnaW52YWxpZC1lbWFpbCcsICcxMjM0NTYnLCAnSm9obiBEb2UnKVxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coRW1haWxTZXJ2aWNlRXJyb3IpO1xuXG4gICAgICBleHBlY3QobW9ja1Jlc2VuZC5lbWFpbHMuc2VuZCkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBlcnJvciBhZnRlciBtYXggcmV0cmllcycsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tSZXNlbmQuZW1haWxzLnNlbmQubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdOZXR3b3JrIGVycm9yJykpO1xuXG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIGVtYWlsU2VydmljZS5zZW5kVmVyaWZpY2F0aW9uRW1haWwoJ3VzZXJAZXhhbXBsZS5jb20nLCAnMTIzNDU2JywgJ0pvaG4gRG9lJylcbiAgICAgICkucmVqZWN0cy50b1Rocm93KCdOZXR3b3JrIGVycm9yJyk7XG5cbiAgICAgIGV4cGVjdChtb2NrUmVzZW5kLmVtYWlscy5zZW5kKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMyk7XG4gICAgfSk7XG4gIH0pO1xufSk7Il0sIm5hbWVzIjpbImplc3QiLCJtb2NrIiwiUmVzZW5kIiwiZm4iLCJtb2NrSW1wbGVtZW50YXRpb24iLCJlbWFpbHMiLCJzZW5kIiwiZGVzY3JpYmUiLCJlbWFpbFNlcnZpY2UiLCJtb2NrUmVzZW5kIiwiYmVmb3JlRWFjaCIsInJlcXVpcmUiLCJSZXNlbmRFbWFpbFNlcnZpY2UiLCJhcGlLZXkiLCJmcm9tRW1haWwiLCJmcm9tTmFtZSIsImFmdGVyRWFjaCIsImNsZWFyQWxsTW9ja3MiLCJpdCIsIm1vY2tSZXNvbHZlZFZhbHVlIiwiZGF0YSIsImlkIiwiZXJyb3IiLCJyZXN1bHQiLCJzZW5kVmVyaWZpY2F0aW9uRW1haWwiLCJleHBlY3QiLCJ0b0JlIiwidG9IYXZlQmVlbkNhbGxlZFdpdGgiLCJmcm9tIiwidG8iLCJzdWJqZWN0IiwiaHRtbCIsInN0cmluZ0NvbnRhaW5pbmciLCJjYWxsQXJncyIsImNhbGxzIiwidG9Db250YWluIiwibW9ja1JlamVjdGVkVmFsdWVPbmNlIiwiRXJyb3IiLCJ0b0hhdmVCZWVuQ2FsbGVkVGltZXMiLCJtZXNzYWdlIiwicmVqZWN0cyIsInRvVGhyb3ciLCJFbWFpbFNlcnZpY2VFcnJvciIsIm1vY2tSZWplY3RlZFZhbHVlIl0sIm1hcHBpbmdzIjoiO0FBRUEsY0FBYztBQUNkQSxLQUFLQyxJQUFJLENBQUMsVUFBVSxJQUFPLENBQUE7UUFDekJDLFFBQVFGLEtBQUtHLEVBQUUsR0FBR0Msa0JBQWtCLENBQUMsSUFBTyxDQUFBO2dCQUMxQ0MsUUFBUTtvQkFDTkMsTUFBTU4sS0FBS0csRUFBRTtnQkFDZjtZQUNGLENBQUE7SUFDRixDQUFBOzs7O3VCQVRzRDtBQVd0REksU0FBUyxzQkFBc0I7SUFDN0IsSUFBSUM7SUFDSixJQUFJ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