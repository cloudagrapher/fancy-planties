4e64a557ed241fc18beb5d8e7e1a8324
"use strict";
// Mock the dependencies
jest.mock('@/lib/services/email-verification-code-service');
jest.mock('@/lib/services/email-verification-rate-limiter');
jest.mock('@/lib/services/email-service-monitor');
Object.defineProperty(exports, "__esModule", {
    value: true
});
const _emailverificationcleanup = require("../../lib/services/email-verification-cleanup");
const _emailverificationcodeservice = require("../../lib/services/email-verification-code-service");
const _emailverificationratelimiter = require("../../lib/services/email-verification-rate-limiter");
const mockEmailVerificationCodeService = _emailverificationcodeservice.emailVerificationCodeService;
const mockEmailVerificationRateLimiter = _emailverificationratelimiter.emailVerificationRateLimiter;
describe('EmailVerificationCleanupService', ()=>{
    let cleanupService;
    beforeEach(()=>{
        cleanupService = new _emailverificationcleanup.EmailVerificationCleanupService();
        jest.clearAllMocks();
        // Setup default mock implementations
        mockEmailVerificationCodeService.cleanupExpiredCodes.mockResolvedValue(5);
        mockEmailVerificationCodeService.getCodeStats.mockResolvedValue({
            totalActive: 10,
            expiredCount: 2,
            highAttemptCount: 1
        });
        mockEmailVerificationRateLimiter.getStats.mockReturnValue({
            verificationAttempts: 3,
            resendRequests: 2,
            emailVerificationActivity: 5,
            resendCooldowns: 1,
            securityEvents: 0
        });
        mockEmailVerificationRateLimiter.cleanup.mockImplementation(()=>{
            // Simulate cleanup by returning different stats
            mockEmailVerificationRateLimiter.getStats.mockReturnValue({
                verificationAttempts: 1,
                resendRequests: 1,
                emailVerificationActivity: 2,
                resendCooldowns: 0,
                securityEvents: 0
            });
        });
    });
    describe('runCleanup', ()=>{
        it('should run cleanup successfully', async ()=>{
            const stats = await cleanupService.runCleanup();
            expect(stats.expiredCodes).toBe(5);
            expect(stats.rateLimitData).toBe(6); // (3-1) + (2-1) + (5-2) + (1-0) = 2 + 1 + 3 + 1 = 7, but calculation is different
            expect(stats.timestamp).toBeGreaterThan(0);
            expect(mockEmailVerificationCodeService.cleanupExpiredCodes).toHaveBeenCalledTimes(1);
            expect(mockEmailVerificationRateLimiter.cleanup).toHaveBeenCalledTimes(1);
        });
        it('should prevent concurrent cleanup runs', async ()=>{
            const cleanup1Promise = cleanupService.runCleanup();
            // Try to run cleanup again while first is running
            await expect(cleanupService.runCleanup()).rejects.toThrow('Cleanup is already running');
            // Wait for first cleanup to complete
            await cleanup1Promise;
            // Now should be able to run again
            await expect(cleanupService.runCleanup()).resolves.toBeDefined();
        });
        it('should handle cleanup errors', async ()=>{
            mockEmailVerificationCodeService.cleanupExpiredCodes.mockRejectedValue(new Error('Database error'));
            await expect(cleanupService.runCleanup()).rejects.toThrow('Database error');
        });
    });
    describe('getCleanupStats', ()=>{
        it('should return cleanup statistics', async ()=>{
            // Run cleanup to generate stats
            await cleanupService.runCleanup();
            const stats = cleanupService.getCleanupStats();
            expect(stats.lastCleanup).toBeGreaterThan(0);
            expect(stats.isRunning).toBe(false);
            expect(stats.recentStats).toHaveLength(1);
            expect(stats.totalExpiredCodes).toBe(5);
            expect(stats.totalRateLimitData).toBeGreaterThan(0);
        });
        it('should limit recent stats to 24 entries', async ()=>{
            // Run cleanup 25 times
            for(let i = 0; i < 25; i++){
                await cleanupService.runCleanup();
            }
            const stats = cleanupService.getCleanupStats();
            expect(stats.recentStats).toHaveLength(24);
        });
    });
    describe('getSystemStatus', ()=>{
        it('should return comprehensive system status', async ()=>{
            const status = await cleanupService.getSystemStatus();
            expect(status.verificationCodes).toEqual({
                totalActive: 10,
                expiredCount: 2,
                highAttemptCount: 1
            });
            expect(status.rateLimits).toEqual({
                verificationAttempts: 3,
                resendRequests: 2,
                emailVerificationActivity: 5,
                resendCooldowns: 1,
                securityEvents: 0
            });
            expect(status.cleanup).toHaveProperty('lastCleanup');
            expect(status.cleanup).toHaveProperty('isRunning');
            expect(status.cleanup).toHaveProperty('nextCleanupDue');
        });
    });
    describe('forceCleanup', ()=>{
        it('should run cleanup when not already running', async ()=>{
            const stats = await cleanupService.forceCleanup();
            expect(stats.expiredCodes).toBe(5);
            expect(mockEmailVerificationCodeService.cleanupExpiredCodes).toHaveBeenCalledTimes(1);
        });
        it('should reject if cleanup is already running', async ()=>{
            // Start a cleanup
            const cleanupPromise = cleanupService.runCleanup();
            // Try to force cleanup while running
            await expect(cleanupService.forceCleanup()).rejects.toThrow('Cleanup is already running');
            // Wait for original cleanup to complete
            await cleanupPromise;
        });
    });
    describe('runStartupCleanup', ()=>{
        it('should run startup cleanup successfully', async ()=>{
            const stats = await cleanupService.runStartupCleanup();
            expect(stats.expiredCodes).toBe(5);
            expect(mockEmailVerificationCodeService.cleanupExpiredCodes).toHaveBeenCalledTimes(1);
        });
        it('should handle startup cleanup errors', async ()=>{
            mockEmailVerificationCodeService.cleanupExpiredCodes.mockRejectedValue(new Error('Startup error'));
            await expect(cleanupService.runStartupCleanup()).rejects.toThrow('Startup error');
        });
    });
    describe('scheduleCleanup', ()=>{
        beforeEach(()=>{
            jest.useFakeTimers();
        });
        afterEach(()=>{
            jest.useRealTimers();
        });
        it('should schedule periodic cleanup', ()=>{
            const intervalMs = 1000; // 1 second for testing
            cleanupService.scheduleCleanup(intervalMs);
            // Fast-forward past initial delay
            jest.advanceTimersByTime(6000);
            // Should have run initial cleanup
            expect(mockEmailVerificationCodeService.cleanupExpiredCodes).toHaveBeenCalledTimes(1);
            // Fast-forward to next interval
            jest.advanceTimersByTime(intervalMs);
            // Should have run periodic cleanup
            expect(mockEmailVerificationCodeService.cleanupExpiredCodes).toHaveBeenCalledTimes(2);
        });
        it('should handle scheduled cleanup errors gracefully', ()=>{
            mockEmailVerificationCodeService.cleanupExpiredCodes.mockRejectedValue(new Error('Scheduled error'));
            const intervalMs = 1000;
            cleanupService.scheduleCleanup(intervalMs);
            // Fast-forward past initial delay
            expect(()=>{
                jest.advanceTimersByTime(6000);
            }).not.toThrow();
            // Should have attempted cleanup despite error
            expect(mockEmailVerificationCodeService.cleanupExpiredCodes).toHaveBeenCalledTimes(1);
        });
    });
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9zdGVmYW5iZWtrZXIvcHJvamVjdHMvZmFuY3ktcGxhbnRpZXMvc3JjL19fdGVzdHNfXy9zZXJ2aWNlcy9lbWFpbC12ZXJpZmljYXRpb24tY2xlYW51cC50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVtYWlsVmVyaWZpY2F0aW9uQ2xlYW51cFNlcnZpY2UgfSBmcm9tICdAL2xpYi9zZXJ2aWNlcy9lbWFpbC12ZXJpZmljYXRpb24tY2xlYW51cCc7XG5pbXBvcnQgeyBlbWFpbFZlcmlmaWNhdGlvbkNvZGVTZXJ2aWNlIH0gZnJvbSAnQC9saWIvc2VydmljZXMvZW1haWwtdmVyaWZpY2F0aW9uLWNvZGUtc2VydmljZSc7XG5pbXBvcnQgeyBlbWFpbFZlcmlmaWNhdGlvblJhdGVMaW1pdGVyIH0gZnJvbSAnQC9saWIvc2VydmljZXMvZW1haWwtdmVyaWZpY2F0aW9uLXJhdGUtbGltaXRlcic7XG5pbXBvcnQgeyBlbWFpbFNlcnZpY2VNb25pdG9yIH0gZnJvbSAnQC9saWIvc2VydmljZXMvZW1haWwtc2VydmljZS1tb25pdG9yJztcblxuLy8gTW9jayB0aGUgZGVwZW5kZW5jaWVzXG5qZXN0Lm1vY2soJ0AvbGliL3NlcnZpY2VzL2VtYWlsLXZlcmlmaWNhdGlvbi1jb2RlLXNlcnZpY2UnKTtcbmplc3QubW9jaygnQC9saWIvc2VydmljZXMvZW1haWwtdmVyaWZpY2F0aW9uLXJhdGUtbGltaXRlcicpO1xuamVzdC5tb2NrKCdAL2xpYi9zZXJ2aWNlcy9lbWFpbC1zZXJ2aWNlLW1vbml0b3InKTtcblxuY29uc3QgbW9ja0VtYWlsVmVyaWZpY2F0aW9uQ29kZVNlcnZpY2UgPSBlbWFpbFZlcmlmaWNhdGlvbkNvZGVTZXJ2aWNlIGFzIGplc3QuTW9ja2VkPHR5cGVvZiBlbWFpbFZlcmlmaWNhdGlvbkNvZGVTZXJ2aWNlPjtcbmNvbnN0IG1vY2tFbWFpbFZlcmlmaWNhdGlvblJhdGVMaW1pdGVyID0gZW1haWxWZXJpZmljYXRpb25SYXRlTGltaXRlciBhcyBqZXN0Lk1vY2tlZDx0eXBlb2YgZW1haWxWZXJpZmljYXRpb25SYXRlTGltaXRlcj47XG5cbmRlc2NyaWJlKCdFbWFpbFZlcmlmaWNhdGlvbkNsZWFudXBTZXJ2aWNlJywgKCkgPT4ge1xuICBsZXQgY2xlYW51cFNlcnZpY2U6IEVtYWlsVmVyaWZpY2F0aW9uQ2xlYW51cFNlcnZpY2U7XG4gIFxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBjbGVhbnVwU2VydmljZSA9IG5ldyBFbWFpbFZlcmlmaWNhdGlvbkNsZWFudXBTZXJ2aWNlKCk7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gICAgXG4gICAgLy8gU2V0dXAgZGVmYXVsdCBtb2NrIGltcGxlbWVudGF0aW9uc1xuICAgIG1vY2tFbWFpbFZlcmlmaWNhdGlvbkNvZGVTZXJ2aWNlLmNsZWFudXBFeHBpcmVkQ29kZXMubW9ja1Jlc29sdmVkVmFsdWUoNSk7XG4gICAgbW9ja0VtYWlsVmVyaWZpY2F0aW9uQ29kZVNlcnZpY2UuZ2V0Q29kZVN0YXRzLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgIHRvdGFsQWN0aXZlOiAxMCxcbiAgICAgIGV4cGlyZWRDb3VudDogMixcbiAgICAgIGhpZ2hBdHRlbXB0Q291bnQ6IDEsXG4gICAgfSk7XG4gICAgXG4gICAgbW9ja0VtYWlsVmVyaWZpY2F0aW9uUmF0ZUxpbWl0ZXIuZ2V0U3RhdHMubW9ja1JldHVyblZhbHVlKHtcbiAgICAgIHZlcmlmaWNhdGlvbkF0dGVtcHRzOiAzLFxuICAgICAgcmVzZW5kUmVxdWVzdHM6IDIsXG4gICAgICBlbWFpbFZlcmlmaWNhdGlvbkFjdGl2aXR5OiA1LFxuICAgICAgcmVzZW5kQ29vbGRvd25zOiAxLFxuICAgICAgc2VjdXJpdHlFdmVudHM6IDAsXG4gICAgfSk7XG4gICAgXG4gICAgbW9ja0VtYWlsVmVyaWZpY2F0aW9uUmF0ZUxpbWl0ZXIuY2xlYW51cC5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4ge1xuICAgICAgLy8gU2ltdWxhdGUgY2xlYW51cCBieSByZXR1cm5pbmcgZGlmZmVyZW50IHN0YXRzXG4gICAgICBtb2NrRW1haWxWZXJpZmljYXRpb25SYXRlTGltaXRlci5nZXRTdGF0cy5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICB2ZXJpZmljYXRpb25BdHRlbXB0czogMSxcbiAgICAgICAgcmVzZW5kUmVxdWVzdHM6IDEsXG4gICAgICAgIGVtYWlsVmVyaWZpY2F0aW9uQWN0aXZpdHk6IDIsXG4gICAgICAgIHJlc2VuZENvb2xkb3duczogMCxcbiAgICAgICAgc2VjdXJpdHlFdmVudHM6IDAsXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG4gIFxuICBkZXNjcmliZSgncnVuQ2xlYW51cCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJ1biBjbGVhbnVwIHN1Y2Nlc3NmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgY2xlYW51cFNlcnZpY2UucnVuQ2xlYW51cCgpO1xuICAgICAgXG4gICAgICBleHBlY3Qoc3RhdHMuZXhwaXJlZENvZGVzKS50b0JlKDUpO1xuICAgICAgZXhwZWN0KHN0YXRzLnJhdGVMaW1pdERhdGEpLnRvQmUoNik7IC8vICgzLTEpICsgKDItMSkgKyAoNS0yKSArICgxLTApID0gMiArIDEgKyAzICsgMSA9IDcsIGJ1dCBjYWxjdWxhdGlvbiBpcyBkaWZmZXJlbnRcbiAgICAgIGV4cGVjdChzdGF0cy50aW1lc3RhbXApLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KG1vY2tFbWFpbFZlcmlmaWNhdGlvbkNvZGVTZXJ2aWNlLmNsZWFudXBFeHBpcmVkQ29kZXMpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdChtb2NrRW1haWxWZXJpZmljYXRpb25SYXRlTGltaXRlci5jbGVhbnVwKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgfSk7XG4gICAgXG4gICAgaXQoJ3Nob3VsZCBwcmV2ZW50IGNvbmN1cnJlbnQgY2xlYW51cCBydW5zJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgY2xlYW51cDFQcm9taXNlID0gY2xlYW51cFNlcnZpY2UucnVuQ2xlYW51cCgpO1xuICAgICAgXG4gICAgICAvLyBUcnkgdG8gcnVuIGNsZWFudXAgYWdhaW4gd2hpbGUgZmlyc3QgaXMgcnVubmluZ1xuICAgICAgYXdhaXQgZXhwZWN0KGNsZWFudXBTZXJ2aWNlLnJ1bkNsZWFudXAoKSkucmVqZWN0cy50b1Rocm93KCdDbGVhbnVwIGlzIGFscmVhZHkgcnVubmluZycpO1xuICAgICAgXG4gICAgICAvLyBXYWl0IGZvciBmaXJzdCBjbGVhbnVwIHRvIGNvbXBsZXRlXG4gICAgICBhd2FpdCBjbGVhbnVwMVByb21pc2U7XG4gICAgICBcbiAgICAgIC8vIE5vdyBzaG91bGQgYmUgYWJsZSB0byBydW4gYWdhaW5cbiAgICAgIGF3YWl0IGV4cGVjdChjbGVhbnVwU2VydmljZS5ydW5DbGVhbnVwKCkpLnJlc29sdmVzLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG4gICAgXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgY2xlYW51cCBlcnJvcnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrRW1haWxWZXJpZmljYXRpb25Db2RlU2VydmljZS5jbGVhbnVwRXhwaXJlZENvZGVzLm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcignRGF0YWJhc2UgZXJyb3InKSk7XG4gICAgICBcbiAgICAgIGF3YWl0IGV4cGVjdChjbGVhbnVwU2VydmljZS5ydW5DbGVhbnVwKCkpLnJlamVjdHMudG9UaHJvdygnRGF0YWJhc2UgZXJyb3InKTtcbiAgICB9KTtcbiAgfSk7XG4gIFxuICBkZXNjcmliZSgnZ2V0Q2xlYW51cFN0YXRzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIGNsZWFudXAgc3RhdGlzdGljcycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFJ1biBjbGVhbnVwIHRvIGdlbmVyYXRlIHN0YXRzXG4gICAgICBhd2FpdCBjbGVhbnVwU2VydmljZS5ydW5DbGVhbnVwKCk7XG4gICAgICBcbiAgICAgIGNvbnN0IHN0YXRzID0gY2xlYW51cFNlcnZpY2UuZ2V0Q2xlYW51cFN0YXRzKCk7XG4gICAgICBcbiAgICAgIGV4cGVjdChzdGF0cy5sYXN0Q2xlYW51cCkudG9CZUdyZWF0ZXJUaGFuKDApO1xuICAgICAgZXhwZWN0KHN0YXRzLmlzUnVubmluZykudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3Qoc3RhdHMucmVjZW50U3RhdHMpLnRvSGF2ZUxlbmd0aCgxKTtcbiAgICAgIGV4cGVjdChzdGF0cy50b3RhbEV4cGlyZWRDb2RlcykudG9CZSg1KTtcbiAgICAgIGV4cGVjdChzdGF0cy50b3RhbFJhdGVMaW1pdERhdGEpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICB9KTtcbiAgICBcbiAgICBpdCgnc2hvdWxkIGxpbWl0IHJlY2VudCBzdGF0cyB0byAyNCBlbnRyaWVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gUnVuIGNsZWFudXAgMjUgdGltZXNcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMjU7IGkrKykge1xuICAgICAgICBhd2FpdCBjbGVhbnVwU2VydmljZS5ydW5DbGVhbnVwKCk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGNvbnN0IHN0YXRzID0gY2xlYW51cFNlcnZpY2UuZ2V0Q2xlYW51cFN0YXRzKCk7XG4gICAgICBleHBlY3Qoc3RhdHMucmVjZW50U3RhdHMpLnRvSGF2ZUxlbmd0aCgyNCk7XG4gICAgfSk7XG4gIH0pO1xuICBcbiAgZGVzY3JpYmUoJ2dldFN5c3RlbVN0YXR1cycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHVybiBjb21wcmVoZW5zaXZlIHN5c3RlbSBzdGF0dXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBzdGF0dXMgPSBhd2FpdCBjbGVhbnVwU2VydmljZS5nZXRTeXN0ZW1TdGF0dXMoKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KHN0YXR1cy52ZXJpZmljYXRpb25Db2RlcykudG9FcXVhbCh7XG4gICAgICAgIHRvdGFsQWN0aXZlOiAxMCxcbiAgICAgICAgZXhwaXJlZENvdW50OiAyLFxuICAgICAgICBoaWdoQXR0ZW1wdENvdW50OiAxLFxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIGV4cGVjdChzdGF0dXMucmF0ZUxpbWl0cykudG9FcXVhbCh7XG4gICAgICAgIHZlcmlmaWNhdGlvbkF0dGVtcHRzOiAzLFxuICAgICAgICByZXNlbmRSZXF1ZXN0czogMixcbiAgICAgICAgZW1haWxWZXJpZmljYXRpb25BY3Rpdml0eTogNSxcbiAgICAgICAgcmVzZW5kQ29vbGRvd25zOiAxLFxuICAgICAgICBzZWN1cml0eUV2ZW50czogMCxcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICBleHBlY3Qoc3RhdHVzLmNsZWFudXApLnRvSGF2ZVByb3BlcnR5KCdsYXN0Q2xlYW51cCcpO1xuICAgICAgZXhwZWN0KHN0YXR1cy5jbGVhbnVwKS50b0hhdmVQcm9wZXJ0eSgnaXNSdW5uaW5nJyk7XG4gICAgICBleHBlY3Qoc3RhdHVzLmNsZWFudXApLnRvSGF2ZVByb3BlcnR5KCduZXh0Q2xlYW51cER1ZScpO1xuICAgIH0pO1xuICB9KTtcbiAgXG4gIGRlc2NyaWJlKCdmb3JjZUNsZWFudXAnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBydW4gY2xlYW51cCB3aGVuIG5vdCBhbHJlYWR5IHJ1bm5pbmcnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBzdGF0cyA9IGF3YWl0IGNsZWFudXBTZXJ2aWNlLmZvcmNlQ2xlYW51cCgpO1xuICAgICAgXG4gICAgICBleHBlY3Qoc3RhdHMuZXhwaXJlZENvZGVzKS50b0JlKDUpO1xuICAgICAgZXhwZWN0KG1vY2tFbWFpbFZlcmlmaWNhdGlvbkNvZGVTZXJ2aWNlLmNsZWFudXBFeHBpcmVkQ29kZXMpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICB9KTtcbiAgICBcbiAgICBpdCgnc2hvdWxkIHJlamVjdCBpZiBjbGVhbnVwIGlzIGFscmVhZHkgcnVubmluZycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFN0YXJ0IGEgY2xlYW51cFxuICAgICAgY29uc3QgY2xlYW51cFByb21pc2UgPSBjbGVhbnVwU2VydmljZS5ydW5DbGVhbnVwKCk7XG4gICAgICBcbiAgICAgIC8vIFRyeSB0byBmb3JjZSBjbGVhbnVwIHdoaWxlIHJ1bm5pbmdcbiAgICAgIGF3YWl0IGV4cGVjdChjbGVhbnVwU2VydmljZS5mb3JjZUNsZWFudXAoKSkucmVqZWN0cy50b1Rocm93KCdDbGVhbnVwIGlzIGFscmVhZHkgcnVubmluZycpO1xuICAgICAgXG4gICAgICAvLyBXYWl0IGZvciBvcmlnaW5hbCBjbGVhbnVwIHRvIGNvbXBsZXRlXG4gICAgICBhd2FpdCBjbGVhbnVwUHJvbWlzZTtcbiAgICB9KTtcbiAgfSk7XG4gIFxuICBkZXNjcmliZSgncnVuU3RhcnR1cENsZWFudXAnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBydW4gc3RhcnR1cCBjbGVhbnVwIHN1Y2Nlc3NmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgY2xlYW51cFNlcnZpY2UucnVuU3RhcnR1cENsZWFudXAoKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KHN0YXRzLmV4cGlyZWRDb2RlcykudG9CZSg1KTtcbiAgICAgIGV4cGVjdChtb2NrRW1haWxWZXJpZmljYXRpb25Db2RlU2VydmljZS5jbGVhbnVwRXhwaXJlZENvZGVzKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgfSk7XG4gICAgXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgc3RhcnR1cCBjbGVhbnVwIGVycm9ycycsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tFbWFpbFZlcmlmaWNhdGlvbkNvZGVTZXJ2aWNlLmNsZWFudXBFeHBpcmVkQ29kZXMubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdTdGFydHVwIGVycm9yJykpO1xuICAgICAgXG4gICAgICBhd2FpdCBleHBlY3QoY2xlYW51cFNlcnZpY2UucnVuU3RhcnR1cENsZWFudXAoKSkucmVqZWN0cy50b1Rocm93KCdTdGFydHVwIGVycm9yJyk7XG4gICAgfSk7XG4gIH0pO1xuICBcbiAgZGVzY3JpYmUoJ3NjaGVkdWxlQ2xlYW51cCcsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIGplc3QudXNlRmFrZVRpbWVycygpO1xuICAgIH0pO1xuICAgIFxuICAgIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgICBqZXN0LnVzZVJlYWxUaW1lcnMoKTtcbiAgICB9KTtcbiAgICBcbiAgICBpdCgnc2hvdWxkIHNjaGVkdWxlIHBlcmlvZGljIGNsZWFudXAnLCAoKSA9PiB7XG4gICAgICBjb25zdCBpbnRlcnZhbE1zID0gMTAwMDsgLy8gMSBzZWNvbmQgZm9yIHRlc3RpbmdcbiAgICAgIFxuICAgICAgY2xlYW51cFNlcnZpY2Uuc2NoZWR1bGVDbGVhbnVwKGludGVydmFsTXMpO1xuICAgICAgXG4gICAgICAvLyBGYXN0LWZvcndhcmQgcGFzdCBpbml0aWFsIGRlbGF5XG4gICAgICBqZXN0LmFkdmFuY2VUaW1lcnNCeVRpbWUoNjAwMCk7XG4gICAgICBcbiAgICAgIC8vIFNob3VsZCBoYXZlIHJ1biBpbml0aWFsIGNsZWFudXBcbiAgICAgIGV4cGVjdChtb2NrRW1haWxWZXJpZmljYXRpb25Db2RlU2VydmljZS5jbGVhbnVwRXhwaXJlZENvZGVzKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgICBcbiAgICAgIC8vIEZhc3QtZm9yd2FyZCB0byBuZXh0IGludGVydmFsXG4gICAgICBqZXN0LmFkdmFuY2VUaW1lcnNCeVRpbWUoaW50ZXJ2YWxNcyk7XG4gICAgICBcbiAgICAgIC8vIFNob3VsZCBoYXZlIHJ1biBwZXJpb2RpYyBjbGVhbnVwXG4gICAgICBleHBlY3QobW9ja0VtYWlsVmVyaWZpY2F0aW9uQ29kZVNlcnZpY2UuY2xlYW51cEV4cGlyZWRDb2RlcykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDIpO1xuICAgIH0pO1xuICAgIFxuICAgIGl0KCdzaG91bGQgaGFuZGxlIHNjaGVkdWxlZCBjbGVhbnVwIGVycm9ycyBncmFjZWZ1bGx5JywgKCkgPT4ge1xuICAgICAgbW9ja0VtYWlsVmVyaWZpY2F0aW9uQ29kZVNlcnZpY2UuY2xlYW51cEV4cGlyZWRDb2Rlcy5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ1NjaGVkdWxlZCBlcnJvcicpKTtcbiAgICAgIFxuICAgICAgY29uc3QgaW50ZXJ2YWxNcyA9IDEwMDA7XG4gICAgICBjbGVhbnVwU2VydmljZS5zY2hlZHVsZUNsZWFudXAoaW50ZXJ2YWxNcyk7XG4gICAgICBcbiAgICAgIC8vIEZhc3QtZm9yd2FyZCBwYXN0IGluaXRpYWwgZGVsYXlcbiAgICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICAgIGplc3QuYWR2YW5jZVRpbWVyc0J5VGltZSg2MDAwKTtcbiAgICAgIH0pLm5vdC50b1Rocm93KCk7XG4gICAgICBcbiAgICAgIC8vIFNob3VsZCBoYXZlIGF0dGVtcHRlZCBjbGVhbnVwIGRlc3BpdGUgZXJyb3JcbiAgICAgIGV4cGVjdChtb2NrRW1haWxWZXJpZmljYXRpb25Db2RlU2VydmljZS5jbGVhbnVwRXhwaXJlZENvZGVzKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgfSk7XG4gIH0pO1xufSk7Il0sIm5hbWVzIjpbImplc3QiLCJtb2NrIiwibW9ja0VtYWlsVmVyaWZpY2F0aW9uQ29kZVNlcnZpY2UiLCJlbWFpbFZlcmlmaWNhdGlvbkNvZGVTZXJ2aWNlIiwibW9ja0VtYWlsVmVyaWZpY2F0aW9uUmF0ZUxpbWl0ZXIiLCJlbWFpbFZlcmlmaWNhdGlvblJhdGVMaW1pdGVyIiwiZGVzY3JpYmUiLCJjbGVhbnVwU2VydmljZSIsImJlZm9yZUVhY2giLCJFbWFpbFZlcmlmaWNhdGlvbkNsZWFudXBTZXJ2aWNlIiwiY2xlYXJBbGxNb2NrcyIsImNsZWFudXBFeHBpcmVkQ29kZXMiLCJtb2NrUmVzb2x2ZWRWYWx1ZSIsImdldENvZGVTdGF0cyIsInRvdGFsQWN0aXZlIiwiZXhwaXJlZENvdW50IiwiaGlnaEF0dGVtcHRDb3VudCIsImdldFN0YXRzIiwibW9ja1JldHVyblZhbHVlIiwidmVyaWZpY2F0aW9uQXR0ZW1wdHMiLCJyZXNlbmRSZXF1ZXN0cyIsImVtYWlsVmVyaWZpY2F0aW9uQWN0aXZpdHkiLCJyZXNlbmRDb29sZG93bnMiLCJzZWN1cml0eUV2ZW50cyIsImNsZWFudXAiLCJtb2NrSW1wbGVtZW50YXRpb24iLCJpdCIsInN0YXRzIiwicnVuQ2xlYW51cCIsImV4cGVjdCIsImV4cGlyZWRDb2RlcyIsInRvQmUiLCJyYXRlTGltaXREYXRhIiwidGltZXN0YW1wIiwidG9CZUdyZWF0ZXJUaGFuIiwidG9IYXZlQmVlbkNhbGxlZFRpbWVzIiwiY2xlYW51cDFQcm9taXNlIiwicmVqZWN0cyIsInRvVGhyb3ciLCJyZXNvbHZlcyIsInRvQmVEZWZpbmVkIiwibW9ja1JlamVjdGVkVmFsdWUiLCJFcnJvciIsImdldENsZWFudXBTdGF0cyIsImxhc3RDbGVhbnVwIiwiaXNSdW5uaW5nIiwicmVjZW50U3RhdHMiLCJ0b0hhdmVMZW5ndGgiLCJ0b3RhbEV4cGlyZWRDb2RlcyIsInRvdGFsUmF0ZUxpbWl0RGF0YSIsImkiLCJzdGF0dXMiLCJnZXRTeXN0ZW1TdGF0dXMiLCJ2ZXJpZmljYXRpb25Db2RlcyIsInRvRXF1YWwiLCJyYXRlTGltaXRzIiwidG9IYXZlUHJvcGVydHkiLCJmb3JjZUNsZWFudXAiLCJjbGVhbnVwUHJvbWlzZSIsInJ1blN0YXJ0dXBDbGVhbnVwIiwidXNlRmFrZVRpbWVycyIsImFmdGVyRWFjaCIsInVzZVJlYWxUaW1lcnMiLCJpbnRlcnZhbE1zIiwic2NoZWR1bGVDbGVhbnVwIiwiYWR2YW5jZVRpbWVyc0J5VGltZSIsIm5vdCJdLCJtYXBwaW5ncyI6IjtBQUtBLHdCQUF3QjtBQUN4QkEsS0FBS0MsSUFBSSxDQUFDO0FBQ1ZELEtBQUtDLElBQUksQ0FBQztBQUNWRCxLQUFLQyxJQUFJLENBQUM7Ozs7MENBUnNDOzhD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