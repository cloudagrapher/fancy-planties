5f7f977018465332dfc2d36dc731bf16
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: Object.getOwnPropertyDescriptor(all, name).get
    });
}
_export(exports, {
    get DELETE () {
        return DELETE;
    },
    get GET () {
        return GET;
    },
    get PUT () {
        return PUT;
    }
});
const _server = require("next/server");
const _plantinstances = require("../../../../lib/db/queries/plant-instances");
const _plantschemas = require("../../../../lib/validation/plant-schemas");
const _server1 = require("../../../../lib/auth/server");
async function GET(request, { params }) {
    try {
        const { user } = await (0, _server1.validateRequest)();
        if (!user) {
            return _server.NextResponse.json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        const resolvedParams = await params;
        const id = parseInt(resolvedParams.id, 10);
        if (isNaN(id)) {
            return _server.NextResponse.json({
                error: 'Invalid plant instance ID'
            }, {
                status: 400
            });
        }
        const plantInstance = await _plantinstances.PlantInstanceQueries.getEnhancedById(id);
        if (!plantInstance) {
            return _server.NextResponse.json({
                error: 'Plant instance not found'
            }, {
                status: 404
            });
        }
        // Check if the plant instance belongs to the current user
        if (plantInstance.userId !== user.id) {
            return _server.NextResponse.json({
                error: 'Forbidden'
            }, {
                status: 403
            });
        }
        return _server.NextResponse.json(plantInstance);
    } catch (error) {
        console.error('Failed to get plant instance:', error);
        return _server.NextResponse.json({
            error: 'Failed to get plant instance'
        }, {
            status: 500
        });
    }
}
async function PUT(request, { params }) {
    try {
        const { user } = await (0, _server1.validateRequest)();
        if (!user) {
            return _server.NextResponse.json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        const resolvedParams = await params;
        const id = parseInt(resolvedParams.id, 10);
        if (isNaN(id)) {
            return _server.NextResponse.json({
                error: 'Invalid plant instance ID'
            }, {
                status: 400
            });
        }
        // Check if the plant instance exists and belongs to the user
        const existingInstance = await _plantinstances.PlantInstanceQueries.getEnhancedById(id);
        if (!existingInstance) {
            return _server.NextResponse.json({
                error: 'Plant instance not found'
            }, {
                status: 404
            });
        }
        if (existingInstance.userId !== user.id) {
            return _server.NextResponse.json({
                error: 'Forbidden'
            }, {
                status: 403
            });
        }
        // Check if request is FormData or JSON
        const contentType = request.headers.get('content-type');
        let body;
        if (contentType?.includes('multipart/form-data')) {
            // Handle FormData for file uploads
            const formData = await request.formData();
            // Helper function to convert file to base64
            const fileToBase64 = async (file)=>{
                const bytes = await file.arrayBuffer();
                const buffer = Buffer.from(bytes);
                const base64 = buffer.toString('base64');
                return `data:${file.type};base64,${base64}`;
            };
            // Extract form fields
            body = {};
            const imageFiles = [];
            const existingImages = [];
            for (const [key, value] of formData.entries()){
                if (key.startsWith('existingImages[')) {
                    // Handle existing images array
                    existingImages.push(value);
                } else if (key.startsWith('imageFiles[')) {
                    // Handle new image files
                    if (value instanceof File) {
                        imageFiles.push(value);
                    }
                } else {
                    // Handle regular form fields
                    if (key === 'plantId') {
                        body[key] = parseInt(value, 10);
                    } else if (key === 'isActive') {
                        body[key] = value === 'true';
                    } else {
                        body[key] = value;
                    }
                }
            }
            // Convert new image files to base64
            const newImageBase64s = await Promise.all(imageFiles.map((file)=>fileToBase64(file)));
            // Combine existing images with new images
            body.images = [
                ...existingImages,
                ...newImageBase64s
            ];
        } else {
            // Handle JSON
            try {
                body = await request.json();
            } catch (jsonError) {
                return _server.NextResponse.json({
                    error: 'Invalid request format'
                }, {
                    status: 400
                });
            }
        }
        // Convert date strings to Date objects if they exist and are not empty
        const processedBody = {
            ...body,
            lastFertilized: body.lastFertilized && body.lastFertilized !== '' ? new Date(body.lastFertilized) : null,
            lastRepot: body.lastRepot && body.lastRepot !== '' ? new Date(body.lastRepot) : null
        };
        // Validate the update data
        const updateData = _plantschemas.updatePlantInstanceSchema.parse({
            ...processedBody,
            id,
            userId: user.id
        });
        // Remove id and userId from update data as they shouldn't be updated
        const { id: _, userId: __, ...dataToUpdate } = updateData;
        // Update the plant instance
        const updatedInstance = await _plantinstances.PlantInstanceQueries.update(id, dataToUpdate);
        // Get the enhanced plant instance with plant data
        const enhancedInstance = await _plantinstances.PlantInstanceQueries.getEnhancedById(updatedInstance.id);
        return _server.NextResponse.json(enhancedInstance);
    } catch (error) {
        console.error('Failed to update plant instance:', error);
        if (error instanceof z.ZodError) {
            return _server.NextResponse.json({
                error: 'Invalid plant instance data',
                details: error.issues
            }, {
                status: 400
            });
        }
        if (error instanceof Error && error.message.includes('validation')) {
            return _server.NextResponse.json({
                error: 'Invalid plant instance data',
                details: error.message
            }, {
                status: 400
            });
        }
        return _server.NextResponse.json({
            error: 'Failed to update plant instance'
        }, {
            status: 500
        });
    }
}
async function DELETE(request, { params }) {
    try {
        const { user } = await (0, _server1.validateRequest)();
        if (!user) {
            return _server.NextResponse.json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        const resolvedParams = await params;
        const id = parseInt(resolvedParams.id, 10);
        if (isNaN(id)) {
            return _server.NextResponse.json({
                error: 'Invalid plant instance ID'
            }, {
                status: 400
            });
        }
        // Check if the plant instance exists and belongs to the user
        const existingInstance = await _plantinstances.PlantInstanceQueries.getEnhancedById(id);
        if (!existingInstance) {
            return _server.NextResponse.json({
                error: 'Plant instance not found'
            }, {
                status: 404
            });
        }
        if (existingInstance.userId !== user.id) {
            return _server.NextResponse.json({
                error: 'Forbidden'
            }, {
                status: 403
            });
        }
        // Delete the plant instance
        const deleted = await _plantinstances.PlantInstanceQueries.delete(id);
        if (!deleted) {
            return _server.NextResponse.json({
                error: 'Failed to delete plant instance'
            }, {
                status: 500
            });
        }
        return _server.NextResponse.json({
            success: true,
            message: 'Plant instance deleted successfully'
        });
    } catch (error) {
        console.error('Failed to delete plant instance:', error);
        return _server.NextResponse.json({
            error: 'Failed to delete plant instance'
        }, {
            status: 500
        });
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9zdGVmYW5iZWtrZXIvcHJvamVjdHMvZmFuY3ktcGxhbnRpZXMvc3JjL2FwcC9hcGkvcGxhbnQtaW5zdGFuY2VzL1tpZF0vcm91dGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmV4dFJlcXVlc3QsIE5leHRSZXNwb25zZSB9IGZyb20gJ25leHQvc2VydmVyJztcbmltcG9ydCB7IFBsYW50SW5zdGFuY2VRdWVyaWVzIH0gZnJvbSAnQC9saWIvZGIvcXVlcmllcy9wbGFudC1pbnN0YW5jZXMnO1xuaW1wb3J0IHsgdXBkYXRlUGxhbnRJbnN0YW5jZVNjaGVtYSB9IGZyb20gJ0AvbGliL3ZhbGlkYXRpb24vcGxhbnQtc2NoZW1hcyc7XG5pbXBvcnQgeyB2YWxpZGF0ZVJlcXVlc3QgfSBmcm9tICdAL2xpYi9hdXRoL3NlcnZlcic7XG5cbi8vIEdFVCAvYXBpL3BsYW50LWluc3RhbmNlcy9baWRdIC0gR2V0IGEgc3BlY2lmaWMgcGxhbnQgaW5zdGFuY2VcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBHRVQoXG4gIHJlcXVlc3Q6IE5leHRSZXF1ZXN0LFxuICB7IHBhcmFtcyB9OiB7IHBhcmFtczogUHJvbWlzZTx7IGlkOiBzdHJpbmcgfT4gfVxuKSB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyB1c2VyIH0gPSBhd2FpdCB2YWxpZGF0ZVJlcXVlc3QoKTtcbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9LCB7IHN0YXR1czogNDAxIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHJlc29sdmVkUGFyYW1zID0gYXdhaXQgcGFyYW1zO1xuICAgIGNvbnN0IGlkID0gcGFyc2VJbnQocmVzb2x2ZWRQYXJhbXMuaWQsIDEwKTtcbiAgICBpZiAoaXNOYU4oaWQpKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgcGxhbnQgaW5zdGFuY2UgSUQnIH0sIHsgc3RhdHVzOiA0MDAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgcGxhbnRJbnN0YW5jZSA9IGF3YWl0IFBsYW50SW5zdGFuY2VRdWVyaWVzLmdldEVuaGFuY2VkQnlJZChpZCk7XG5cbiAgICBpZiAoIXBsYW50SW5zdGFuY2UpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnUGxhbnQgaW5zdGFuY2Ugbm90IGZvdW5kJyB9LCB7IHN0YXR1czogNDA0IH0pO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHRoZSBwbGFudCBpbnN0YW5jZSBiZWxvbmdzIHRvIHRoZSBjdXJyZW50IHVzZXJcbiAgICBpZiAocGxhbnRJbnN0YW5jZS51c2VySWQgIT09IHVzZXIuaWQpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnRm9yYmlkZGVuJyB9LCB7IHN0YXR1czogNDAzIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihwbGFudEluc3RhbmNlKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gZ2V0IHBsYW50IGluc3RhbmNlOicsIGVycm9yKTtcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICB7IGVycm9yOiAnRmFpbGVkIHRvIGdldCBwbGFudCBpbnN0YW5jZScgfSxcbiAgICAgIHsgc3RhdHVzOiA1MDAgfVxuICAgICk7XG4gIH1cbn1cblxuLy8gUFVUIC9hcGkvcGxhbnQtaW5zdGFuY2VzL1tpZF0gLSBVcGRhdGUgYSBwbGFudCBpbnN0YW5jZVxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIFBVVChcbiAgcmVxdWVzdDogTmV4dFJlcXVlc3QsXG4gIHsgcGFyYW1zIH06IHsgcGFyYW1zOiBQcm9taXNlPHsgaWQ6IHN0cmluZyB9PiB9XG4pIHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IHVzZXIgfSA9IGF3YWl0IHZhbGlkYXRlUmVxdWVzdCgpO1xuICAgIGlmICghdXNlcikge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0sIHsgc3RhdHVzOiA0MDEgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzb2x2ZWRQYXJhbXMgPSBhd2FpdCBwYXJhbXM7XG4gICAgY29uc3QgaWQgPSBwYXJzZUludChyZXNvbHZlZFBhcmFtcy5pZCwgMTApO1xuICAgIGlmIChpc05hTihpZCkpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnSW52YWxpZCBwbGFudCBpbnN0YW5jZSBJRCcgfSwgeyBzdGF0dXM6IDQwMCB9KTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiB0aGUgcGxhbnQgaW5zdGFuY2UgZXhpc3RzIGFuZCBiZWxvbmdzIHRvIHRoZSB1c2VyXG4gICAgY29uc3QgZXhpc3RpbmdJbnN0YW5jZSA9IGF3YWl0IFBsYW50SW5zdGFuY2VRdWVyaWVzLmdldEVuaGFuY2VkQnlJZChpZCk7XG4gICAgaWYgKCFleGlzdGluZ0luc3RhbmNlKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ1BsYW50IGluc3RhbmNlIG5vdCBmb3VuZCcgfSwgeyBzdGF0dXM6IDQwNCB9KTtcbiAgICB9XG5cbiAgICBpZiAoZXhpc3RpbmdJbnN0YW5jZS51c2VySWQgIT09IHVzZXIuaWQpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnRm9yYmlkZGVuJyB9LCB7IHN0YXR1czogNDAzIH0pO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHJlcXVlc3QgaXMgRm9ybURhdGEgb3IgSlNPTlxuICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gcmVxdWVzdC5oZWFkZXJzLmdldCgnY29udGVudC10eXBlJyk7XG4gICAgbGV0IGJvZHk6IGFueTtcblxuICAgIGlmIChjb250ZW50VHlwZT8uaW5jbHVkZXMoJ211bHRpcGFydC9mb3JtLWRhdGEnKSkge1xuICAgICAgLy8gSGFuZGxlIEZvcm1EYXRhIGZvciBmaWxlIHVwbG9hZHNcbiAgICAgIGNvbnN0IGZvcm1EYXRhID0gYXdhaXQgcmVxdWVzdC5mb3JtRGF0YSgpO1xuXG4gICAgICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29udmVydCBmaWxlIHRvIGJhc2U2NFxuICAgICAgY29uc3QgZmlsZVRvQmFzZTY0ID0gYXN5bmMgKGZpbGU6IEZpbGUpOiBQcm9taXNlPHN0cmluZz4gPT4ge1xuICAgICAgICBjb25zdCBieXRlcyA9IGF3YWl0IGZpbGUuYXJyYXlCdWZmZXIoKTtcbiAgICAgICAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmZyb20oYnl0ZXMpO1xuICAgICAgICBjb25zdCBiYXNlNjQgPSBidWZmZXIudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuICAgICAgICByZXR1cm4gYGRhdGE6JHtmaWxlLnR5cGV9O2Jhc2U2NCwke2Jhc2U2NH1gO1xuICAgICAgfTtcblxuICAgICAgLy8gRXh0cmFjdCBmb3JtIGZpZWxkc1xuICAgICAgYm9keSA9IHt9O1xuICAgICAgY29uc3QgaW1hZ2VGaWxlczogRmlsZVtdID0gW107XG4gICAgICBjb25zdCBleGlzdGluZ0ltYWdlczogKHN0cmluZyB8IEZvcm1EYXRhRW50cnlWYWx1ZSlbXSA9IFtdO1xuXG4gICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBmb3JtRGF0YS5lbnRyaWVzKCkpIHtcbiAgICAgICAgaWYgKGtleS5zdGFydHNXaXRoKCdleGlzdGluZ0ltYWdlc1snKSkge1xuICAgICAgICAgIC8vIEhhbmRsZSBleGlzdGluZyBpbWFnZXMgYXJyYXlcbiAgICAgICAgICBleGlzdGluZ0ltYWdlcy5wdXNoKHZhbHVlKTtcbiAgICAgICAgfSBlbHNlIGlmIChrZXkuc3RhcnRzV2l0aCgnaW1hZ2VGaWxlc1snKSkge1xuICAgICAgICAgIC8vIEhhbmRsZSBuZXcgaW1hZ2UgZmlsZXNcbiAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBGaWxlKSB7XG4gICAgICAgICAgICBpbWFnZUZpbGVzLnB1c2godmFsdWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBIYW5kbGUgcmVndWxhciBmb3JtIGZpZWxkc1xuICAgICAgICAgIGlmIChrZXkgPT09ICdwbGFudElkJykge1xuICAgICAgICAgICAgYm9keVtrZXldID0gcGFyc2VJbnQodmFsdWUgYXMgc3RyaW5nLCAxMCk7XG4gICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICdpc0FjdGl2ZScpIHtcbiAgICAgICAgICAgIGJvZHlba2V5XSA9IHZhbHVlID09PSAndHJ1ZSc7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGJvZHlba2V5XSA9IHZhbHVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBDb252ZXJ0IG5ldyBpbWFnZSBmaWxlcyB0byBiYXNlNjRcbiAgICAgIGNvbnN0IG5ld0ltYWdlQmFzZTY0cyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICBpbWFnZUZpbGVzLm1hcChmaWxlID0+IGZpbGVUb0Jhc2U2NChmaWxlKSlcbiAgICAgICk7XG5cbiAgICAgIC8vIENvbWJpbmUgZXhpc3RpbmcgaW1hZ2VzIHdpdGggbmV3IGltYWdlc1xuICAgICAgYm9keS5pbWFnZXMgPSBbLi4uZXhpc3RpbmdJbWFnZXMsIC4uLm5ld0ltYWdlQmFzZTY0c107XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEhhbmRsZSBKU09OXG4gICAgICB0cnkge1xuICAgICAgICBib2R5ID0gYXdhaXQgcmVxdWVzdC5qc29uKCk7XG4gICAgICB9IGNhdGNoIChqc29uRXJyb3IpIHtcbiAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICAgIHsgZXJyb3I6ICdJbnZhbGlkIHJlcXVlc3QgZm9ybWF0JyB9LFxuICAgICAgICAgIHsgc3RhdHVzOiA0MDAgfVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENvbnZlcnQgZGF0ZSBzdHJpbmdzIHRvIERhdGUgb2JqZWN0cyBpZiB0aGV5IGV4aXN0IGFuZCBhcmUgbm90IGVtcHR5XG4gICAgY29uc3QgcHJvY2Vzc2VkQm9keSA9IHtcbiAgICAgIC4uLmJvZHksXG4gICAgICBsYXN0RmVydGlsaXplZDogYm9keS5sYXN0RmVydGlsaXplZCAmJiBib2R5Lmxhc3RGZXJ0aWxpemVkICE9PSAnJyA/IG5ldyBEYXRlKGJvZHkubGFzdEZlcnRpbGl6ZWQpIDogbnVsbCxcbiAgICAgIGxhc3RSZXBvdDogYm9keS5sYXN0UmVwb3QgJiYgYm9keS5sYXN0UmVwb3QgIT09ICcnID8gbmV3IERhdGUoYm9keS5sYXN0UmVwb3QpIDogbnVsbCxcbiAgICB9O1xuXG4gICAgLy8gVmFsaWRhdGUgdGhlIHVwZGF0ZSBkYXRhXG4gICAgY29uc3QgdXBkYXRlRGF0YSA9IHVwZGF0ZVBsYW50SW5zdGFuY2VTY2hlbWEucGFyc2Uoe1xuICAgICAgLi4ucHJvY2Vzc2VkQm9keSxcbiAgICAgIGlkLFxuICAgICAgdXNlcklkOiB1c2VyLmlkLFxuICAgIH0pO1xuXG4gICAgLy8gUmVtb3ZlIGlkIGFuZCB1c2VySWQgZnJvbSB1cGRhdGUgZGF0YSBhcyB0aGV5IHNob3VsZG4ndCBiZSB1cGRhdGVkXG4gICAgY29uc3QgeyBpZDogXywgdXNlcklkOiBfXywgLi4uZGF0YVRvVXBkYXRlIH0gPSB1cGRhdGVEYXRhO1xuXG4gICAgLy8gVXBkYXRlIHRoZSBwbGFudCBpbnN0YW5jZVxuICAgIGNvbnN0IHVwZGF0ZWRJbnN0YW5jZSA9IGF3YWl0IFBsYW50SW5zdGFuY2VRdWVyaWVzLnVwZGF0ZShpZCwgZGF0YVRvVXBkYXRlKTtcblxuICAgIC8vIEdldCB0aGUgZW5oYW5jZWQgcGxhbnQgaW5zdGFuY2Ugd2l0aCBwbGFudCBkYXRhXG4gICAgY29uc3QgZW5oYW5jZWRJbnN0YW5jZSA9IGF3YWl0IFBsYW50SW5zdGFuY2VRdWVyaWVzLmdldEVuaGFuY2VkQnlJZCh1cGRhdGVkSW5zdGFuY2UuaWQpO1xuXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKGVuaGFuY2VkSW5zdGFuY2UpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byB1cGRhdGUgcGxhbnQgaW5zdGFuY2U6JywgZXJyb3IpO1xuXG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2Ygei5ab2RFcnJvcikge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IGVycm9yOiAnSW52YWxpZCBwbGFudCBpbnN0YW5jZSBkYXRhJywgZGV0YWlsczogZXJyb3IuaXNzdWVzIH0sXG4gICAgICAgIHsgc3RhdHVzOiA0MDAgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvciAmJiBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCd2YWxpZGF0aW9uJykpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBlcnJvcjogJ0ludmFsaWQgcGxhbnQgaW5zdGFuY2UgZGF0YScsIGRldGFpbHM6IGVycm9yLm1lc3NhZ2UgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgIHsgZXJyb3I6ICdGYWlsZWQgdG8gdXBkYXRlIHBsYW50IGluc3RhbmNlJyB9LFxuICAgICAgeyBzdGF0dXM6IDUwMCB9XG4gICAgKTtcbiAgfVxufVxuXG4vLyBERUxFVEUgL2FwaS9wbGFudC1pbnN0YW5jZXMvW2lkXSAtIERlbGV0ZSBhIHBsYW50IGluc3RhbmNlXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gREVMRVRFKFxuICByZXF1ZXN0OiBOZXh0UmVxdWVzdCxcbiAgeyBwYXJhbXMgfTogeyBwYXJhbXM6IFByb21pc2U8eyBpZDogc3RyaW5nIH0+IH1cbikge1xuICB0cnkge1xuICAgIGNvbnN0IHsgdXNlciB9ID0gYXdhaXQgdmFsaWRhdGVSZXF1ZXN0KCk7XG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSwgeyBzdGF0dXM6IDQwMSB9KTtcbiAgICB9XG5cbiAgICBjb25zdCByZXNvbHZlZFBhcmFtcyA9IGF3YWl0IHBhcmFtcztcbiAgICBjb25zdCBpZCA9IHBhcnNlSW50KHJlc29sdmVkUGFyYW1zLmlkLCAxMCk7XG4gICAgaWYgKGlzTmFOKGlkKSkge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6ICdJbnZhbGlkIHBsYW50IGluc3RhbmNlIElEJyB9LCB7IHN0YXR1czogNDAwIH0pO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHRoZSBwbGFudCBpbnN0YW5jZSBleGlzdHMgYW5kIGJlbG9uZ3MgdG8gdGhlIHVzZXJcbiAgICBjb25zdCBleGlzdGluZ0luc3RhbmNlID0gYXdhaXQgUGxhbnRJbnN0YW5jZVF1ZXJpZXMuZ2V0RW5oYW5jZWRCeUlkKGlkKTtcbiAgICBpZiAoIWV4aXN0aW5nSW5zdGFuY2UpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiAnUGxhbnQgaW5zdGFuY2Ugbm90IGZvdW5kJyB9LCB7IHN0YXR1czogNDA0IH0pO1xuICAgIH1cblxuICAgIGlmIChleGlzdGluZ0luc3RhbmNlLnVzZXJJZCAhPT0gdXNlci5pZCkge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6ICdGb3JiaWRkZW4nIH0sIHsgc3RhdHVzOiA0MDMgfSk7XG4gICAgfVxuXG4gICAgLy8gRGVsZXRlIHRoZSBwbGFudCBpbnN0YW5jZVxuICAgIGNvbnN0IGRlbGV0ZWQgPSBhd2FpdCBQbGFudEluc3RhbmNlUXVlcmllcy5kZWxldGUoaWQpO1xuXG4gICAgaWYgKCFkZWxldGVkKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogJ0ZhaWxlZCB0byBkZWxldGUgcGxhbnQgaW5zdGFuY2UnIH0sIHsgc3RhdHVzOiA1MDAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgc3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ1BsYW50IGluc3RhbmNlIGRlbGV0ZWQgc3VjY2Vzc2Z1bGx5JyB9KTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gZGVsZXRlIHBsYW50IGluc3RhbmNlOicsIGVycm9yKTtcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICB7IGVycm9yOiAnRmFpbGVkIHRvIGRlbGV0ZSBwbGFudCBpbnN0YW5jZScgfSxcbiAgICAgIHsgc3RhdHVzOiA1MDAgfVxuICAgICk7XG4gIH1cbn0iXSwibmFtZXMiOlsiREVMRVRFIiwiR0VUIiwiUFVUIiwicmVxdWVzdCIsInBhcmFtcyIsInVzZXIiLCJ2YWxpZGF0ZVJlcXVlc3QiLCJOZXh0UmVzcG9uc2UiLCJqc29uIiwiZXJyb3IiLCJzdGF0dXMiLCJyZXNvbHZlZFBhcmFtcyIsImlkIiwicGFyc2VJbnQiLCJpc05hTiIsInBsYW50SW5zdGFuY2UiLCJQbGFudEluc3RhbmNlUXVlcmllcyIsImdldEVuaGFuY2VkQnlJZCIsInVzZXJJZCIsImNvbnNvbGUiLCJleGlzdGluZ0luc3RhbmNlIiwiY29udGVudFR5cGUiLCJoZWFkZXJzIiwiZ2V0IiwiYm9keSIsImluY2x1ZGVzIiwiZm9ybURhdGEiLCJmaWxlVG9CYXNlNjQiLCJmaWxlIiwiYnl0ZXMiLCJhcnJheUJ1ZmZlciIsImJ1ZmZlciIsIkJ1ZmZlciIsImZyb20iLCJiYXNlNjQiLCJ0b1N0cmluZyIsInR5cGUiLCJpbWFnZUZpbGVzIiwiZXhpc3RpbmdJbWFnZXMiLCJrZXkiLCJ2YWx1ZSIsImVudHJpZXMiLCJzdGFydHNXaXRoIiwicHVzaCIsIkZpbGUiLCJuZXdJbWFnZUJhc2U2NHMiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwiaW1hZ2VzIiwianNvbkVycm9yIiwicHJvY2Vzc2VkQm9keSIsImxhc3RGZXJ0aWxpemVkIiwiRGF0ZSIsImxhc3RSZXBvdCIsInVwZGF0ZURhdGEiLCJ1cGRhdGVQbGFudEluc3RhbmNlU2NoZW1hIiwicGFyc2UiLCJfIiwiX18iLCJkYXRhVG9VcGRhdGUiLCJ1cGRhdGVkSW5zdGFuY2UiLCJ1cGRhdGUiLCJlbmhhbmNlZEluc3RhbmNlIiwieiIsIlpvZEVycm9yIiwiZGV0YWlscyIsImlzc3VlcyIsIkVycm9yIiwibWVzc2FnZSIsImRlbGV0ZWQiLCJkZWxldGUiLCJzdWNjZXNzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztRQW9Mc0JBO2VBQUFBOztRQTlLQUM7ZUFBQUE7O1FBc0NBQztlQUFBQTs7O3dCQTVDb0I7Z0NBQ0w7OEJBQ0s7eUJBQ1Y7QUFHekIsZUFBZUQsSUFDcEJFLE9BQW9CLEVBQ3BCLEVBQUVDLE1BQU0sRUFBdUM7SUFFL0MsSUFBSTtRQUNGLE1BQU0sRUFBRUMsSUFBSSxFQUFFLEdBQUcsTUFBTUMsSUFBQUEsd0JBQWU7UUFDdEMsSUFBSSxDQUFDRCxNQUFNO1lBQ1QsT0FBT0Usb0JBQVksQ0FBQ0MsSUFBSSxDQUFDO2dCQUFFQyxPQUFPO1lBQWUsR0FBRztnQkFBRUMsUUFBUTtZQUFJO1FBQ3BFO1FBRUEsTUFBTUMsaUJBQWlCLE1BQU1QO1FBQzdCLE1BQU1RLEtBQUtDLFNBQVNGLGVBQWVDLEVBQUUsRUFBRTtRQUN2QyxJQUFJRSxNQUFNRixLQUFLO1lBQ2IsT0FBT0wsb0JBQVksQ0FBQ0MsSUFBSSxDQUFDO2dCQUFFQyxPQUFPO1lBQTRCLEdBQUc7Z0JBQUVDLFFBQVE7WUFBSTtRQUNqRjtRQUVBLE1BQU1LLGdCQUFnQixNQUFNQyxvQ0FBb0IsQ0FBQ0MsZUFBZSxDQUFDTDtRQUVqRSxJQUFJLENBQUNHLGVBQWU7WUFDbEIsT0FBT1Isb0JBQVksQ0FBQ0MsSUFBSSxDQUFDO2dCQUFFQyxPQUFPO1lBQTJCLEdBQUc7Z0JBQUVDLFFBQVE7WUFBSTtRQUNo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