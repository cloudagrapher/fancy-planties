{"version":3,"sources":["/Users/stefanbekker/projects/fancy-planties/src/__tests__/integration/email-verification-flow.test.ts"],"sourcesContent":["/**\n * Email Verification Flow Integration Tests\n * Tests complete signup and verification process, resend functionality, and rate limiting\n * Requirements: 1.1, 1.4, 2.1, 2.2\n */\n\nimport { emailVerificationCodeService } from '@/lib/services/email-verification-code-service';\nimport { createEmailService } from '@/lib/services/resend-email-service';\n\n// Mock email service\njest.mock('@/lib/services/resend-email-service');\njest.mock('@/lib/services/email-service');\n\n// Mock database\njest.mock('@/lib/db', () => ({\n  db: {\n    select: jest.fn().mockReturnThis(),\n    from: jest.fn().mockReturnThis(),\n    where: jest.fn().mockReturnThis(),\n    insert: jest.fn().mockReturnThis(),\n    values: jest.fn().mockReturnThis(),\n    update: jest.fn().mockReturnThis(),\n    set: jest.fn().mockReturnThis(),\n    delete: jest.fn().mockReturnThis(),\n    returning: jest.fn(),\n    execute: jest.fn(),\n  },\n}));\n\n// Mock auth functions\njest.mock('@/lib/auth', () => ({\n  getUserByEmail: jest.fn(),\n  getUserById: jest.fn(),\n}));\n\nconst mockEmailService = {\n  sendVerificationEmail: jest.fn(),\n};\n\nconst mockCreateEmailService = createEmailService as jest.MockedFunction<typeof createEmailService>;\nconst mockSendEmailWithRetry = require('@/lib/services/email-service').sendEmailWithRetry as jest.MockedFunction<any>;\nconst mockDb = require('@/lib/db').db;\nconst mockGetUserByEmail = require('@/lib/auth').getUserByEmail as jest.MockedFunction<any>;\nconst mockGetUserById = require('@/lib/auth').getUserById as jest.MockedFunction<any>;\n\n// Mock environment variables\nconst originalEnv = process.env;\n\nbeforeAll(() => {\n  process.env = {\n    ...originalEnv,\n    RESEND_API_KEY: 'test-api-key',\n    FROM_EMAIL: 'test@example.com',\n    FROM_NAME: 'Test App',\n    VERIFICATION_CODE_EXPIRY_MINUTES: '10',\n    MAX_VERIFICATION_ATTEMPTS: '5',\n    RESEND_COOLDOWN_SECONDS: '60',\n    MAX_RESEND_PER_HOUR: '5',\n    NODE_ENV: 'test',\n  };\n});\n\nafterAll(() => {\n  process.env = originalEnv;\n});\n\ndescribe('Email Verification Flow Integration Tests', () => {\n  beforeEach(async () => {\n    jest.clearAllMocks();\n    \n    // Mock email service to always succeed\n    mockCreateEmailService.mockReturnValue(mockEmailService);\n    mockSendEmailWithRetry.mockResolvedValue(true);\n    mockEmailService.sendVerificationEmail.mockResolvedValue(true);\n\n    // Setup default database mocks\n    mockDb.returning.mockResolvedValue([]);\n    mockDb.execute.mockResolvedValue([]);\n  });\n\n  describe('Complete Signup and Verification Process', () => {\n    it('should complete full signup and verification workflow', async () => {\n      // Mock user data\n      const mockUser = {\n        id: 1,\n        email: 'test@example.com',\n        name: 'Test User',\n        isEmailVerified: false,\n      };\n\n      // Mock database responses for user lookup\n      mockGetUserByEmail.mockResolvedValue(mockUser);\n      mockGetUserById.mockResolvedValue(mockUser);\n\n      // Mock code insertion\n      mockDb.returning.mockResolvedValueOnce([{ id: 1, code: '123456', userId: 1 }]);\n\n      // Step 1: Generate verification code\n      const verificationCode = await emailVerificationCodeService.generateCode(mockUser.id);\n      expect(verificationCode).toMatch(/^\\d{6}$/);\n\n      // Step 2: Mock successful validation\n      mockDb.returning.mockResolvedValueOnce([{ \n        id: 1, \n        code: verificationCode, \n        userId: 1, \n        expiresAt: new Date(Date.now() + 600000),\n        attemptsUsed: 0 \n      }]);\n      \n      // Mock user update to verified\n      mockGetUserById.mockResolvedValueOnce({ ...mockUser, isEmailVerified: true });\n\n      // Step 3: Validate the verification code\n      const isValid = await emailVerificationCodeService.validateCode('test@example.com', verificationCode);\n      expect(isValid).toBe(true);\n\n      // Verify database operations were called\n      expect(mockDb.insert).toHaveBeenCalled();\n      expect(mockDb.update).toHaveBeenCalled();\n      expect(mockDb.delete).toHaveBeenCalled();\n    });\n\n    it('should handle email service failure gracefully during code generation', async () => {\n      // Mock user data\n      const mockUser = {\n        id: 1,\n        email: 'test@example.com',\n        name: 'Test User',\n        isEmailVerified: false,\n      };\n\n      // Mock user lookup\n      mockGetUserById.mockResolvedValue(mockUser);\n\n      // Mock code insertion\n      mockDb.returning.mockResolvedValueOnce([{ id: 1, code: '123456', userId: 1 }]);\n\n      // Generate verification code (this should work even if email fails)\n      const verificationCode = await emailVerificationCodeService.generateCode(mockUser.id);\n      expect(verificationCode).toMatch(/^\\d{6}$/);\n\n      // Verify database insert was called\n      expect(mockDb.insert).toHaveBeenCalled();\n      expect(mockDb.values).toHaveBeenCalled();\n    });\n\n    it('should reject verification with invalid code', async () => {\n      // Mock user data\n      const mockUser = {\n        id: 1,\n        email: 'test@example.com',\n        name: 'Test User',\n        isEmailVerified: false,\n      };\n\n      // Mock user lookup\n      mockGetUserByEmail.mockResolvedValue(mockUser);\n\n      // Mock code lookup - return empty array (no matching code)\n      mockDb.returning.mockResolvedValueOnce([]);\n\n      // Try to verify with wrong code using service directly\n      try {\n        await emailVerificationCodeService.validateCode('test@example.com', '654321');\n        fail('Should have thrown an error for invalid code');\n      } catch (error: any) {\n        expect(error.code).toBe('CODE_INVALID');\n      }\n    });\n\n    it('should reject verification with expired code', async () => {\n      // Mock user data\n      const mockUser = {\n        id: 1,\n        email: 'test@example.com',\n        name: 'Test User',\n        isEmailVerified: false,\n      };\n\n      // Mock user lookup\n      mockGetUserByEmail.mockResolvedValue(mockUser);\n\n      // Mock expired code lookup\n      mockDb.returning.mockResolvedValueOnce([{\n        id: 1,\n        code: '123456',\n        userId: 1,\n        expiresAt: new Date(Date.now() - 1000), // Expired 1 second ago\n        attemptsUsed: 0,\n      }]);\n\n      // Try to verify with expired code using service directly\n      try {\n        await emailVerificationCodeService.validateCode('test@example.com', '123456');\n        fail('Should have thrown an error for expired code');\n      } catch (error: any) {\n        expect(error.code).toBe('CODE_EXPIRED');\n      }\n    });\n  });\n\n  describe('Resend Verification Code Functionality', () => {\n    it('should resend verification code by generating new code', async () => {\n      // Mock user data\n      const mockUser = {\n        id: 1,\n        email: 'test@example.com',\n        name: 'Test User',\n        isEmailVerified: false,\n      };\n\n      // Mock user lookup\n      mockGetUserById.mockResolvedValue(mockUser);\n\n      // Mock code insertion for new code\n      mockDb.returning.mockResolvedValueOnce([{ id: 1, code: '654321', userId: 1 }]);\n\n      // Generate new verification code (simulating resend)\n      const newCode = await emailVerificationCodeService.generateCode(mockUser.id);\n      expect(newCode).toMatch(/^\\d{6}$/);\n\n      // Verify database operations were called\n      expect(mockDb.delete).toHaveBeenCalled(); // Old codes deleted\n      expect(mockDb.insert).toHaveBeenCalled(); // New code inserted\n    });\n\n    it('should handle resend for already verified user', async () => {\n      // Mock verified user\n      const mockUser = {\n        id: 1,\n        email: 'test@example.com',\n        name: 'Test User',\n        isEmailVerified: true, // Already verified\n      };\n\n      // Mock user lookup\n      mockGetUserById.mockResolvedValue(mockUser);\n\n      // Try to generate code for already verified user\n      try {\n        await emailVerificationCodeService.generateCode(mockUser.id);\n        fail('Should have thrown an error for already verified user');\n      } catch (error: any) {\n        expect(error.code).toBe('ALREADY_VERIFIED');\n      }\n    });\n\n    it('should handle resend for non-existent user', async () => {\n      // Mock user not found\n      mockGetUserByEmail.mockResolvedValue(null);\n\n      // Try to validate code for non-existent user\n      try {\n        await emailVerificationCodeService.validateCode('nonexistent@example.com', '123456');\n        fail('Should have thrown an error for non-existent user');\n      } catch (error: any) {\n        expect(error.code).toBe('USER_NOT_FOUND');\n      }\n    });\n  });\n\n  describe('Rate Limiting Enforcement', () => {\n    it('should enforce verification attempt limits', async () => {\n      // Mock user data\n      const mockUser = {\n        id: 1,\n        email: 'test@example.com',\n        name: 'Test User',\n        isEmailVerified: false,\n      };\n\n      // Mock user lookup\n      mockGetUserByEmail.mockResolvedValue(mockUser);\n\n      // Mock code with max attempts reached\n      mockDb.returning.mockResolvedValueOnce([{\n        id: 1,\n        code: '123456',\n        userId: 1,\n        expiresAt: new Date(Date.now() + 600000),\n        attemptsUsed: 5, // Max attempts reached\n      }]);\n\n      // Try to verify with max attempts reached\n      try {\n        await emailVerificationCodeService.validateCode('test@example.com', '123456');\n        fail('Should have thrown an error for too many attempts');\n      } catch (error: any) {\n        expect(error.code).toBe('TOO_MANY_ATTEMPTS');\n      }\n    });\n\n    it('should handle validation at service level', async () => {\n      // Mock user data\n      const mockUser = {\n        id: 1,\n        email: 'test@example.com',\n        name: 'Test User',\n        isEmailVerified: false,\n      };\n\n      // Mock user lookup\n      mockGetUserById.mockResolvedValue(mockUser);\n      mockGetUserByEmail.mockResolvedValue(mockUser);\n\n      // Mock code insertion\n      mockDb.returning.mockResolvedValueOnce([{ id: 1, code: '123456', userId: 1 }]);\n\n      // Generate valid code\n      const validCode = await emailVerificationCodeService.generateCode(mockUser.id);\n      expect(validCode).toMatch(/^\\d{6}$/);\n\n      // Mock successful validation\n      mockDb.returning.mockResolvedValueOnce([{\n        id: 1,\n        code: validCode,\n        userId: 1,\n        expiresAt: new Date(Date.now() + 600000),\n        attemptsUsed: 0,\n      }]);\n\n      // Test that service validates codes properly\n      const isValid = await emailVerificationCodeService.validateCode('test@example.com', validCode);\n      expect(isValid).toBe(true);\n\n      // Verify database operations were called\n      expect(mockDb.update).toHaveBeenCalled(); // User marked as verified\n      expect(mockDb.delete).toHaveBeenCalled(); // Code deleted\n    });\n  });\n\n  describe('Edge Cases and Error Scenarios', () => {\n    it('should handle duplicate verification code generation', async () => {\n      // Mock user data\n      const mockUser = {\n        id: 1,\n        email: 'test@example.com',\n        name: 'Test User',\n        isEmailVerified: false,\n      };\n\n      // Mock user lookup\n      mockGetUserById.mockResolvedValue(mockUser);\n\n      // Mock code insertions\n      mockDb.returning\n        .mockResolvedValueOnce([{ id: 1, code: '123456', userId: 1 }])\n        .mockResolvedValueOnce([{ id: 2, code: '654321', userId: 1 }]);\n\n      // Generate first code\n      const firstCode = await emailVerificationCodeService.generateCode(mockUser.id);\n      expect(firstCode).toMatch(/^\\d{6}$/);\n\n      // Generate second code (should invalidate first)\n      const secondCode = await emailVerificationCodeService.generateCode(mockUser.id);\n      expect(secondCode).toMatch(/^\\d{6}$/);\n      expect(secondCode).not.toBe(firstCode);\n\n      // Verify delete was called to remove old codes\n      expect(mockDb.delete).toHaveBeenCalled();\n    });\n\n    it('should handle service errors gracefully', async () => {\n      // Mock user not found\n      mockGetUserById.mockResolvedValue(null);\n\n      // Test with non-existent user ID\n      try {\n        await emailVerificationCodeService.generateCode(99999); // Non-existent user ID\n        fail('Should have thrown an error for non-existent user');\n      } catch (error: any) {\n        expect(error.code).toBe('USER_NOT_FOUND');\n      }\n    });\n\n    it('should handle cleanup of expired codes', async () => {\n      // Mock cleanup operation\n      mockDb.returning.mockResolvedValueOnce([\n        { id: 1, code: '123456', expiresAt: new Date(Date.now() - 60000) }\n      ]);\n\n      // Run cleanup\n      await emailVerificationCodeService.cleanupExpiredCodes();\n\n      // Verify delete was called for expired codes\n      expect(mockDb.delete).toHaveBeenCalled();\n    });\n  });\n});"],"names":["jest","mock","db","select","fn","mockReturnThis","from","where","insert","values","update","set","delete","returning","execute","getUserByEmail","getUserById","mockEmailService","sendVerificationEmail","mockCreateEmailService","createEmailService","mockSendEmailWithRetry","require","sendEmailWithRetry","mockDb","mockGetUserByEmail","mockGetUserById","originalEnv","process","env","beforeAll","RESEND_API_KEY","FROM_EMAIL","FROM_NAME","VERIFICATION_CODE_EXPIRY_MINUTES","MAX_VERIFICATION_ATTEMPTS","RESEND_COOLDOWN_SECONDS","MAX_RESEND_PER_HOUR","NODE_ENV","afterAll","describe","beforeEach","clearAllMocks","mockReturnValue","mockResolvedValue","it","mockUser","id","email","name","isEmailVerified","mockResolvedValueOnce","code","userId","verificationCode","emailVerificationCodeService","generateCode","expect","toMatch","expiresAt","Date","now","attemptsUsed","isValid","validateCode","toBe","toHaveBeenCalled","fail","error","newCode","validCode","firstCode","secondCode","not","cleanupExpiredCodes"],"mappings":"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"}