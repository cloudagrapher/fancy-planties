{"version":3,"names":["cleanupExpiredSessions","cov_3hfctc4ye","f","s","clearSessionCookie","getAuthSession","isAuthenticated","redirectIfAuthenticated","requireAuthSession","setSessionCookie","validateRequest","sessionId","sessionCookie","_lucia","lucia","createSessionCookie","_headers","cookies","set","name","value","attributes","createBlankSessionCookie","_react","cache","b","get","sessionCookieName","user","session","result","validateSession","fresh","id","fullUser","_index","getUserById","parseInt","userId","expiresAt","redirectTo","_navigation","redirect","console","log","error"],"sources":["/Users/stefanbekker/projects/fancy-planties/src/lib/auth/server.ts"],"sourcesContent":["import 'server-only';\n\nimport { cookies } from 'next/headers';\nimport { redirect } from 'next/navigation';\nimport { lucia } from './lucia';\nimport { cache } from 'react';\nimport { getUserById } from './index';\nimport type { User, Session } from '../db/schema';\n\n// Session cookie management\nexport async function setSessionCookie(sessionId: string): Promise<void> {\n  const sessionCookie = lucia.createSessionCookie(sessionId);\n  (await cookies()).set(sessionCookie.name, sessionCookie.value, sessionCookie.attributes);\n}\n\nexport async function clearSessionCookie(): Promise<void> {\n  const sessionCookie = lucia.createBlankSessionCookie();\n  (await cookies()).set(sessionCookie.name, sessionCookie.value, sessionCookie.attributes);\n}\n\n// Cached session validation for performance\nexport const validateRequest = cache(async (): Promise<{ user: User; session: Session } | { user: null; session: null }> => {\n  const sessionId = (await cookies()).get(lucia.sessionCookieName)?.value ?? null;\n  \n  if (!sessionId) {\n    return {\n      user: null,\n      session: null,\n    };\n  }\n\n  const result = await lucia.validateSession(sessionId);\n  \n  // Next.js throws when you attempt to set cookie when rendering page\n  try {\n    if (result.session && result.session.fresh) {\n      const sessionCookie = lucia.createSessionCookie(result.session.id);\n      (await cookies()).set(sessionCookie.name, sessionCookie.value, sessionCookie.attributes);\n    }\n    if (!result.session) {\n      const sessionCookie = lucia.createBlankSessionCookie();\n      (await cookies()).set(sessionCookie.name, sessionCookie.value, sessionCookie.attributes);\n    }\n  } catch {\n    // Ignore cookie setting errors in server components\n  }\n  \n  // Convert Lucia result to our expected format\n  if (result.user && result.session) {\n    // Get full user data from database\n    const fullUser = await getUserById(parseInt(result.user.id));\n    if (!fullUser) {\n      return { user: null, session: null };\n    }\n    \n    return {\n      user: fullUser,\n      session: {\n        id: result.session.id,\n        userId: parseInt(result.user.id),\n        expiresAt: result.session.expiresAt,\n      },\n    };\n  }\n  \n  return {\n    user: null,\n    session: null,\n  };\n});\n\n// Server-side session validation\nexport async function getAuthSession() {\n  return await validateRequest();\n}\n\n// Require authenticated user or redirect\nexport async function requireAuthSession(redirectTo: string = '/auth/signin') {\n  const { user, session } = await validateRequest();\n  \n  if (!user || !session) {\n    redirect(redirectTo);\n  }\n  \n  return { user, session };\n}\n\n// Check if user is authenticated (without redirect)\nexport async function isAuthenticated(): Promise<boolean> {\n  const { user, session } = await validateRequest();\n  return !!(user && session);\n}\n\n// Redirect authenticated users away from auth pages\nexport async function redirectIfAuthenticated(redirectTo: string = '/dashboard') {\n  const { user, session } = await validateRequest();\n  \n  if (user && session) {\n    redirect(redirectTo);\n  }\n}\n\n// Session cleanup utility\nexport async function cleanupExpiredSessions(): Promise<void> {\n  try {\n    // This would typically be run as a background job\n    // For now, we'll rely on Lucia's built-in cleanup\n    console.log('Session cleanup would run here');\n  } catch (error) {\n    console.error('Session cleanup error:', error);\n  }\n}"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}