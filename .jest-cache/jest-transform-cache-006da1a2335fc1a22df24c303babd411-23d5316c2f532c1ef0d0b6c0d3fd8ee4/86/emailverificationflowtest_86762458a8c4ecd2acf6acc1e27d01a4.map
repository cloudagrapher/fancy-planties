{"version":3,"sources":["/Users/stefanbekker/projects/fancy-planties/src/__tests__/integration/email-verification-flow.test.ts"],"sourcesContent":["/**\n * Email Verification Flow Integration Tests\n * Tests complete signup and verification process, resend functionality, and rate limiting\n * Requirements: 1.1, 1.4, 2.1, 2.2\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { POST as signupHandler } from '@/app/api/auth/signup/route';\nimport { POST as verifyEmailHandler } from '@/app/api/auth/verify-email/route';\nimport { POST as resendVerificationHandler } from '@/app/api/auth/resend-verification/route';\nimport { createDatabaseTestManager } from '@/test-utils/setup/database-test-manager';\nimport { createTestUser } from '@/test-utils/factories/user-factory';\nimport { emailVerificationCodeService } from '@/lib/services/email-verification-code-service';\nimport { createEmailService } from '@/lib/services/resend-email-service';\n\n// Mock email service\njest.mock('@/lib/services/resend-email-service');\njest.mock('@/lib/services/email-service');\n\nconst mockEmailService = {\n  sendVerificationEmail: jest.fn(),\n};\n\nconst mockCreateEmailService = createEmailService as jest.MockedFunction<typeof createEmailService>;\nconst mockSendEmailWithRetry = require('@/lib/services/email-service').sendEmailWithRetry as jest.MockedFunction<any>;\n\n// Mock environment variables\nconst originalEnv = process.env;\n\nbeforeAll(() => {\n  process.env = {\n    ...originalEnv,\n    RESEND_API_KEY: 'test-api-key',\n    FROM_EMAIL: 'test@example.com',\n    FROM_NAME: 'Test App',\n    VERIFICATION_CODE_EXPIRY_MINUTES: '10',\n    MAX_VERIFICATION_ATTEMPTS: '5',\n    RESEND_COOLDOWN_SECONDS: '60',\n    MAX_RESEND_PER_HOUR: '5',\n    NODE_ENV: 'test',\n  };\n});\n\nafterAll(() => {\n  process.env = originalEnv;\n});\n\ndescribe('Email Verification Flow Integration Tests', () => {\n  let dbManager: any;\n\n  beforeEach(async () => {\n    jest.clearAllMocks();\n    dbManager = createDatabaseTestManager();\n    \n    // Mock email service to always succeed\n    mockCreateEmailService.mockReturnValue(mockEmailService);\n    mockSendEmailWithRetry.mockResolvedValue(true);\n    mockEmailService.sendVerificationEmail.mockResolvedValue(true);\n  });\n\n  afterEach(async () => {\n    await dbManager.cleanup();\n  });\n\n  describe('Complete Signup and Verification Process', () => {\n    it('should complete full signup and verification workflow', async () => {\n      // Step 1: Sign up user\n      const signupRequest = new NextRequest('http://localhost/api/auth/signup', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n          password: 'SecurePass123!',\n          name: 'Test User',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const signupResponse = await signupHandler(signupRequest);\n      const signupData = await signupResponse.json();\n\n      // Assert signup success\n      expect(signupResponse.status).toBe(200);\n      expect(signupData.success).toBe(true);\n      expect(signupData.requiresVerification).toBe(true);\n      expect(signupData.user.email).toBe('test@example.com');\n      expect(signupData.user.isEmailVerified).toBe(false);\n\n      // Verify email was sent\n      expect(mockSendEmailWithRetry).toHaveBeenCalledWith(\n        mockEmailService,\n        'test@example.com',\n        expect.stringMatching(/^\\d{6}$/),\n        'Test User'\n      );\n\n      // Step 2: Get the verification code from the database\n      const user = await dbManager.getUserByEmail('test@example.com');\n      expect(user).toBeTruthy();\n      expect(user.isEmailVerified).toBe(false);\n\n      const emailCodes = await dbManager.getEmailCodesByUserId(user.id);\n      expect(emailCodes).toHaveLength(1);\n      const verificationCode = emailCodes[0].code;\n\n      // Step 3: Verify email with correct code\n      const verifyRequest = new NextRequest('http://localhost/api/auth/verify-email', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n          code: verificationCode,\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const verifyResponse = await verifyEmailHandler(verifyRequest);\n      const verifyData = await verifyResponse.json();\n\n      // Assert verification success\n      expect(verifyResponse.status).toBe(200);\n      expect(verifyData.success).toBe(true);\n      expect(verifyData.message).toContain('Email verified successfully');\n      expect(verifyData.redirectTo).toBe('/dashboard');\n\n      // Step 4: Verify user is now verified in database\n      const verifiedUser = await dbManager.getUserById(user.id);\n      expect(verifiedUser.isEmailVerified).toBe(true);\n\n      // Step 5: Verify verification code was deleted\n      const remainingCodes = await dbManager.getEmailCodesByUserId(user.id);\n      expect(remainingCodes).toHaveLength(0);\n    });\n\n    it('should handle signup with email service failure gracefully', async () => {\n      // Mock email service to fail\n      mockSendEmailWithRetry.mockRejectedValue(new Error('Email service unavailable'));\n\n      const signupRequest = new NextRequest('http://localhost/api/auth/signup', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n          password: 'SecurePass123!',\n          name: 'Test User',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const signupResponse = await signupHandler(signupRequest);\n      const signupData = await signupResponse.json();\n\n      // Assert signup still succeeds but with email error\n      expect(signupResponse.status).toBe(200);\n      expect(signupData.success).toBe(true);\n      expect(signupData.requiresVerification).toBe(true);\n      expect(signupData.emailError).toContain('Failed to send verification email');\n\n      // Verify user was created but not verified\n      const user = await dbManager.getUserByEmail('test@example.com');\n      expect(user).toBeTruthy();\n      expect(user.isEmailVerified).toBe(false);\n\n      // Verify verification code was still generated\n      const emailCodes = await dbManager.getEmailCodesByUserId(user.id);\n      expect(emailCodes).toHaveLength(1);\n    });\n\n    it('should reject verification with invalid code', async () => {\n      // Create user and verification code\n      const user = await dbManager.createTestUser({\n        email: 'test@example.com',\n        name: 'Test User',\n        passwordHash: 'hashed_password',\n        isEmailVerified: false,\n      });\n\n      await dbManager.createTestEmailCode({\n        userId: user.id,\n        code: '123456',\n        expiresAt: new Date(Date.now() + 10 * 60 * 1000), // 10 minutes from now\n        attemptsUsed: 0,\n      });\n\n      // Try to verify with wrong code\n      const verifyRequest = new NextRequest('http://localhost/api/auth/verify-email', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n          code: '654321', // Wrong code\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const verifyResponse = await verifyEmailHandler(verifyRequest);\n      const verifyData = await verifyResponse.json();\n\n      // Assert verification failure\n      expect(verifyResponse.status).toBe(400);\n      expect(verifyData.success).toBeFalsy();\n      expect(verifyData.error).toContain('Invalid verification code');\n\n      // Verify user is still not verified\n      const unverifiedUser = await dbManager.getUserById(user.id);\n      expect(unverifiedUser.isEmailVerified).toBe(false);\n    });\n\n    it('should reject verification with expired code', async () => {\n      // Create user and expired verification code\n      const user = await dbManager.createTestUser({\n        email: 'test@example.com',\n        name: 'Test User',\n        passwordHash: 'hashed_password',\n        isEmailVerified: false,\n      });\n\n      await dbManager.createTestEmailCode({\n        userId: user.id,\n        code: '123456',\n        expiresAt: new Date(Date.now() - 1000), // Expired 1 second ago\n        attemptsUsed: 0,\n      });\n\n      // Try to verify with expired code\n      const verifyRequest = new NextRequest('http://localhost/api/auth/verify-email', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n          code: '123456',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const verifyResponse = await verifyEmailHandler(verifyRequest);\n      const verifyData = await verifyResponse.json();\n\n      // Assert verification failure\n      expect(verifyResponse.status).toBe(400);\n      expect(verifyData.success).toBeFalsy();\n      expect(verifyData.error).toContain('Verification code has expired');\n\n      // Verify user is still not verified\n      const unverifiedUser = await dbManager.getUserById(user.id);\n      expect(unverifiedUser.isEmailVerified).toBe(false);\n    });\n  });\n\n  describe('Resend Verification Code Functionality', () => {\n    it('should resend verification code with proper cooldown behavior', async () => {\n      // Create unverified user\n      const user = await dbManager.createTestUser({\n        email: 'test@example.com',\n        name: 'Test User',\n        passwordHash: 'hashed_password',\n        isEmailVerified: false,\n      });\n\n      // Create existing verification code\n      await dbManager.createTestEmailCode({\n        userId: user.id,\n        code: '123456',\n        expiresAt: new Date(Date.now() + 10 * 60 * 1000),\n        attemptsUsed: 0,\n      });\n\n      // First resend request\n      const resendRequest1 = new NextRequest('http://localhost/api/auth/resend-verification', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const resendResponse1 = await resendVerificationHandler(resendRequest1);\n      const resendData1 = await resendResponse1.json();\n\n      // Assert first resend success\n      expect(resendResponse1.status).toBe(200);\n      expect(resendData1.success).toBe(true);\n      expect(resendData1.message).toContain('Verification code sent successfully');\n      expect(resendData1.cooldownSeconds).toBe(60);\n\n      // Verify new code was generated (old one should be invalidated)\n      const emailCodes = await dbManager.getEmailCodesByUserId(user.id);\n      expect(emailCodes).toHaveLength(1);\n      expect(emailCodes[0].code).not.toBe('123456'); // Should be a new code\n\n      // Verify email was sent\n      expect(mockSendEmailWithRetry).toHaveBeenCalledWith(\n        mockEmailService,\n        'test@example.com',\n        expect.stringMatching(/^\\d{6}$/),\n        'Test User'\n      );\n    });\n\n    it('should handle resend for already verified user', async () => {\n      // Create verified user\n      const user = await dbManager.createTestUser({\n        email: 'test@example.com',\n        name: 'Test User',\n        passwordHash: 'hashed_password',\n        isEmailVerified: true, // Already verified\n      });\n\n      const resendRequest = new NextRequest('http://localhost/api/auth/resend-verification', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const resendResponse = await resendVerificationHandler(resendRequest);\n      const resendData = await resendResponse.json();\n\n      // Assert appropriate response for already verified user\n      expect(resendResponse.status).toBe(400);\n      expect(resendData.error).toContain('Email is already verified');\n      expect(resendData.redirectTo).toBe('/auth/signin');\n\n      // Verify no email was sent\n      expect(mockSendEmailWithRetry).not.toHaveBeenCalled();\n    });\n\n    it('should handle resend for non-existent user', async () => {\n      const resendRequest = new NextRequest('http://localhost/api/auth/resend-verification', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'nonexistent@example.com',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const resendResponse = await resendVerificationHandler(resendRequest);\n      const resendData = await resendResponse.json();\n\n      // Assert user not found error\n      expect(resendResponse.status).toBe(404);\n      expect(resendData.error).toContain('User not found');\n\n      // Verify no email was sent\n      expect(mockSendEmailWithRetry).not.toHaveBeenCalled();\n    });\n  });\n\n  describe('Rate Limiting Enforcement', () => {\n    it('should enforce verification attempt limits', async () => {\n      // Create user and verification code\n      const user = await dbManager.createTestUser({\n        email: 'test@example.com',\n        name: 'Test User',\n        passwordHash: 'hashed_password',\n        isEmailVerified: false,\n      });\n\n      const emailCode = await dbManager.createTestEmailCode({\n        userId: user.id,\n        code: '123456',\n        expiresAt: new Date(Date.now() + 10 * 60 * 1000),\n        attemptsUsed: 4, // Already at 4 attempts (limit is 5)\n      });\n\n      // Make one more attempt (should still work)\n      const verifyRequest1 = new NextRequest('http://localhost/api/auth/verify-email', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n          code: '654321', // Wrong code\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const verifyResponse1 = await verifyEmailHandler(verifyRequest1);\n      expect(verifyResponse1.status).toBe(400);\n\n      // Make another attempt (should be rate limited)\n      const verifyRequest2 = new NextRequest('http://localhost/api/auth/verify-email', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n          code: '654321', // Wrong code\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const verifyResponse2 = await verifyEmailHandler(verifyRequest2);\n      const verifyData2 = await verifyResponse2.json();\n\n      // Assert rate limiting\n      expect(verifyResponse2.status).toBe(429);\n      expect(verifyData2.error).toContain('Too many verification attempts');\n    });\n\n    it('should handle validation errors properly', async () => {\n      // Test invalid email format\n      const verifyRequest1 = new NextRequest('http://localhost/api/auth/verify-email', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'invalid-email',\n          code: '123456',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const verifyResponse1 = await verifyEmailHandler(verifyRequest1);\n      const verifyData1 = await verifyResponse1.json();\n\n      expect(verifyResponse1.status).toBe(400);\n      expect(verifyData1.error).toBe('Validation failed');\n      expect(verifyData1.details).toEqual(\n        expect.arrayContaining([\n          expect.objectContaining({\n            field: 'email',\n            message: 'Invalid email address',\n          }),\n        ])\n      );\n\n      // Test invalid code format\n      const verifyRequest2 = new NextRequest('http://localhost/api/auth/verify-email', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n          code: '12345', // Too short\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const verifyResponse2 = await verifyEmailHandler(verifyRequest2);\n      const verifyData2 = await verifyResponse2.json();\n\n      expect(verifyResponse2.status).toBe(400);\n      expect(verifyData2.error).toBe('Validation failed');\n      expect(verifyData2.details).toEqual(\n        expect.arrayContaining([\n          expect.objectContaining({\n            field: 'code',\n            message: 'Verification code must be 6 digits',\n          }),\n        ])\n      );\n\n      // Test non-numeric code\n      const verifyRequest3 = new NextRequest('http://localhost/api/auth/verify-email', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n          code: 'ABCDEF', // Non-numeric\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const verifyResponse3 = await verifyEmailHandler(verifyRequest3);\n      const verifyData3 = await verifyResponse3.json();\n\n      expect(verifyResponse3.status).toBe(400);\n      expect(verifyData3.error).toBe('Validation failed');\n      expect(verifyData3.details).toEqual(\n        expect.arrayContaining([\n          expect.objectContaining({\n            field: 'code',\n            message: 'Verification code must contain only digits',\n          }),\n        ])\n      );\n    });\n  });\n\n  describe('Edge Cases and Error Scenarios', () => {\n    it('should handle duplicate signup attempts', async () => {\n      // First signup\n      const signupRequest1 = new NextRequest('http://localhost/api/auth/signup', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n          password: 'SecurePass123!',\n          name: 'Test User',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const signupResponse1 = await signupHandler(signupRequest1);\n      expect(signupResponse1.status).toBe(200);\n\n      // Second signup with same email\n      const signupRequest2 = new NextRequest('http://localhost/api/auth/signup', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n          password: 'AnotherPass123!',\n          name: 'Another User',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const signupResponse2 = await signupHandler(signupRequest2);\n      const signupData2 = await signupResponse2.json();\n\n      // Assert duplicate email error\n      expect(signupResponse2.status).toBe(409);\n      expect(signupData2.error).toContain('already exists');\n    });\n\n    it('should handle malformed request bodies', async () => {\n      // Test with invalid JSON\n      const verifyRequest = new NextRequest('http://localhost/api/auth/verify-email', {\n        method: 'POST',\n        body: 'invalid json',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const verifyResponse = await verifyEmailHandler(verifyRequest);\n      const verifyData = await verifyResponse.json();\n\n      expect(verifyResponse.status).toBe(500);\n      expect(verifyData.error).toBe('Internal server error');\n    });\n\n    it('should handle missing request body fields', async () => {\n      // Test with missing email\n      const verifyRequest1 = new NextRequest('http://localhost/api/auth/verify-email', {\n        method: 'POST',\n        body: JSON.stringify({\n          code: '123456',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const verifyResponse1 = await verifyEmailHandler(verifyRequest1);\n      const verifyData1 = await verifyResponse1.json();\n\n      expect(verifyResponse1.status).toBe(400);\n      expect(verifyData1.error).toBe('Validation failed');\n\n      // Test with missing code\n      const verifyRequest2 = new NextRequest('http://localhost/api/auth/verify-email', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const verifyResponse2 = await verifyEmailHandler(verifyRequest2);\n      const verifyData2 = await verifyResponse2.json();\n\n      expect(verifyResponse2.status).toBe(400);\n      expect(verifyData2.error).toBe('Validation failed');\n    });\n  });\n});"],"names":["jest","mock","mockEmailService","sendVerificationEmail","fn","mockCreateEmailService","createEmailService","mockSendEmailWithRetry","require","sendEmailWithRetry","originalEnv","process","env","beforeAll","RESEND_API_KEY","FROM_EMAIL","FROM_NAME","VERIFICATION_CODE_EXPIRY_MINUTES","MAX_VERIFICATION_ATTEMPTS","RESEND_COOLDOWN_SECONDS","MAX_RESEND_PER_HOUR","NODE_ENV","afterAll","describe","dbManager","beforeEach","clearAllMocks","createDatabaseTestManager","mockReturnValue","mockResolvedValue","afterEach","cleanup","it","signupRequest","NextRequest","method","body","JSON","stringify","email","password","name","headers","signupResponse","signupHandler","signupData","json","expect","status","toBe","success","requiresVerification","user","isEmailVerified","toHaveBeenCalledWith","stringMatching","getUserByEmail","toBeTruthy","emailCodes","getEmailCodesByUserId","id","toHaveLength","verificationCode","code","verifyRequest","verifyResponse","verifyEmailHandler","verifyData","message","toContain","redirectTo","verifiedUser","getUserById","remainingCodes","mockRejectedValue","Error","emailError","createTestUser","passwordHash","createTestEmailCode","userId","expiresAt","Date","now","attemptsUsed","toBeFalsy","error","unverifiedUser","resendRequest1","resendResponse1","resendVerificationHandler","resendData1","cooldownSeconds","not","resendRequest","resendResponse","resendData","toHaveBeenCalled","emailCode","verifyRequest1","verifyResponse1","verifyRequest2","verifyResponse2","verifyData2","verifyData1","details","toEqual","arrayContaining","objectContaining","field","verifyRequest3","verifyResponse3","verifyData3","signupRequest1","signupResponse1","signupRequest2","signupResponse2","signupData2"],"mappings":"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"}