{"version":3,"sources":["/Users/stefanbekker/projects/fancy-planties/src/lib/services/resend-email-service.ts"],"sourcesContent":["import 'server-only';\nimport { Resend } from 'resend';\nimport { EmailService, EmailConfig, EmailServiceError } from './email-service';\nimport { emailServiceMonitor } from './email-service-monitor';\n\nexport class ResendEmailService implements EmailService {\n  private resend: Resend;\n  private config: EmailConfig;\n\n  constructor(config: EmailConfig) {\n    this.resend = new Resend(config.apiKey);\n    this.config = config;\n  }\n\n  async sendVerificationEmail(email: string, code: string, name: string): Promise<boolean> {\n    const startTime = Date.now();\n    \n    try {\n      const { data, error } = await this.resend.emails.send({\n        from: `${this.config.fromName} <${this.config.fromEmail}>`,\n        to: [email],\n        subject: 'Verify your email address',\n        html: this.generateVerificationEmailTemplate(code, name),\n        text: this.generateVerificationEmailText(code, name),\n      });\n\n      const responseTime = Date.now() - startTime;\n\n      if (error) {\n        console.error('Resend API error:', error);\n        \n        // Map Resend errors to our error types\n        let emailError: EmailServiceError;\n        if (error.message?.includes('quota') || error.message?.includes('limit')) {\n          emailError = new EmailServiceError('Email quota exceeded', 'QUOTA_EXCEEDED');\n        } else if (error.message?.includes('invalid') && error.message?.includes('email')) {\n          emailError = new EmailServiceError('Invalid email address', 'INVALID_EMAIL');\n        } else {\n          emailError = new EmailServiceError(`Resend API error: ${error.message}`, 'API_ERROR');\n        }\n        \n        // Record failure in monitor\n        emailServiceMonitor.recordFailure(\n          { message: emailError.message, code: emailError.code },\n          responseTime\n        );\n        \n        throw emailError;\n      }\n\n      // Record success in monitor\n      emailServiceMonitor.recordSuccess(responseTime);\n      \n      console.log('Verification email sent successfully:', data?.id);\n      return true;\n      \n    } catch (error) {\n      const responseTime = Date.now() - startTime;\n      \n      if (error instanceof EmailServiceError) {\n        // Already recorded in monitor above\n        throw error;\n      }\n      \n      console.error('Network error sending email:', error);\n      const networkError = new EmailServiceError(\n        `Network error: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        'NETWORK_ERROR'\n      );\n      \n      // Record network error in monitor\n      emailServiceMonitor.recordFailure(\n        { message: networkError.message, code: networkError.code },\n        responseTime\n      );\n      \n      throw networkError;\n    }\n  }\n\n  private generateVerificationEmailTemplate(code: string, name: string): string {\n    return `\n      <!DOCTYPE html>\n      <html lang=\"en\">\n      <head>\n        <meta charset=\"UTF-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        <title>Verify Your Email</title>\n        <style>\n          body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            line-height: 1.6;\n            color: #333;\n            max-width: 600px;\n            margin: 0 auto;\n            padding: 20px;\n          }\n          .header {\n            text-align: center;\n            margin-bottom: 30px;\n          }\n          .logo {\n            font-size: 24px;\n            font-weight: bold;\n            color: #22c55e;\n            margin-bottom: 10px;\n          }\n          .verification-code {\n            background: #f8f9fa;\n            border: 2px solid #e9ecef;\n            border-radius: 8px;\n            padding: 20px;\n            text-align: center;\n            margin: 30px 0;\n          }\n          .code {\n            font-size: 32px;\n            font-weight: bold;\n            letter-spacing: 4px;\n            color: #22c55e;\n            font-family: 'Courier New', monospace;\n          }\n          .footer {\n            margin-top: 30px;\n            padding-top: 20px;\n            border-top: 1px solid #e9ecef;\n            font-size: 14px;\n            color: #6c757d;\n          }\n        </style>\n      </head>\n      <body>\n        <div class=\"header\">\n          <div class=\"logo\">ðŸŒ± Fancy Planties</div>\n          <h1>Verify Your Email Address</h1>\n        </div>\n        \n        <p>Hi ${name},</p>\n        \n        <p>Welcome to Fancy Planties! To complete your account setup, please verify your email address by entering the verification code below:</p>\n        \n        <div class=\"verification-code\">\n          <div class=\"code\">${code}</div>\n          <p style=\"margin: 10px 0 0 0; font-size: 14px; color: #6c757d;\">\n            This code expires in 10 minutes\n          </p>\n        </div>\n        \n        <p>If you didn't create an account with Fancy Planties, you can safely ignore this email.</p>\n        \n        <div class=\"footer\">\n          <p>This is an automated message from Fancy Planties. Please do not reply to this email.</p>\n          <p>Need help? Contact us at support@fancy-planties.cloudagrapher.com</p>\n        </div>\n      </body>\n      </html>\n    `;\n  }\n\n  private generateVerificationEmailText(code: string, name: string): string {\n    return `\nHi ${name},\n\nWelcome to Fancy Planties! To complete your account setup, please verify your email address by entering the verification code below:\n\nVerification Code: ${code}\n\nThis code expires in 10 minutes.\n\nIf you didn't create an account with Fancy Planties, you can safely ignore this email.\n\n---\nThis is an automated message from Fancy Planties. Please do not reply to this email.\nNeed help? Contact us at support@fancy-planties.cloudagrapher.com\n    `.trim();\n  }\n}\n\n// Factory function to create email service instance\nexport function createEmailService(): EmailService {\n  const config: EmailConfig = {\n    apiKey: process.env.RESEND_API_KEY!,\n    fromEmail: process.env.FROM_EMAIL || 'send.mail.fancy-planties.cloudagrapher.com',\n    fromName: process.env.FROM_NAME || 'Fancy Planties',\n  };\n\n  if (!config.apiKey) {\n    throw new Error('RESEND_API_KEY environment variable is required');\n  }\n\n  return new ResendEmailService(config);\n}"],"names":["ResendEmailService","createEmailService","config","resend","Resend","apiKey","sendVerificationEmail","email","code","name","startTime","Date","now","data","error","emails","send","from","fromName","fromEmail","to","subject","html","generateVerificationEmailTemplate","text","generateVerificationEmailText","responseTime","console","emailError","message","includes","EmailServiceError","emailServiceMonitor","recordFailure","recordSuccess","log","id","networkError","Error","trim","process","env","RESEND_API_KEY","FROM_EMAIL","FROM_NAME"],"mappings":"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"}