7b493fd38af9234ce604fbc0c44d6ee0
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: Object.getOwnPropertyDescriptor(all, name).get
    });
}
_export(exports, {
    get EmailVerificationCleanupService () {
        return EmailVerificationCleanupService;
    },
    get emailVerificationCleanupService () {
        return emailVerificationCleanupService;
    }
});
require("server-only");
const _emailverificationcodeservice = require("./email-verification-code-service");
const _emailverificationratelimiter = require("./email-verification-rate-limiter");
const _emailservicemonitor = require("./email-service-monitor");
class EmailVerificationCleanupService {
    /**
   * Run cleanup of expired verification codes and rate limit data
   */ async runCleanup() {
        if (this.isRunning) {
            throw new Error('Cleanup is already running');
        }
        this.isRunning = true;
        const startTime = Date.now();
        try {
            console.log('[CLEANUP] Starting email verification cleanup...');
            // Clean up expired verification codes
            const expiredCodes = await _emailverificationcodeservice.emailVerificationCodeService.cleanupExpiredCodes();
            console.log(`[CLEANUP] Removed ${expiredCodes} expired verification codes`);
            // Clean up rate limit data
            const rateLimitStatsBefore = _emailverificationratelimiter.emailVerificationRateLimiter.getStats();
            _emailverificationratelimiter.emailVerificationRateLimiter.cleanup();
            const rateLimitStatsAfter = _emailverificationratelimiter.emailVerificationRateLimiter.getStats();
            const rateLimitDataCleaned = rateLimitStatsBefore.verificationAttempts - rateLimitStatsAfter.verificationAttempts + (rateLimitStatsBefore.resendRequests - rateLimitStatsAfter.resendRequests) + (rateLimitStatsBefore.emailVerificationActivity - rateLimitStatsAfter.emailVerificationActivity) + (rateLimitStatsBefore.resendCooldowns - rateLimitStatsAfter.resendCooldowns);
            console.log(`[CLEANUP] Cleaned up ${rateLimitDataCleaned} rate limit entries`);
            // Check email service health
            const emailHealth = _emailservicemonitor.emailServiceMonitor.getHealthStatus();
            const emailStats = _emailservicemonitor.emailServiceMonitor.getStats();
            if (emailHealth.status !== 'healthy') {
                console.warn(`[CLEANUP] Email service health: ${emailHealth.status}`, {
                    issues: emailHealth.issues,
                    recommendations: emailHealth.recommendations
                });
            }
            const stats = {
                expiredCodes,
                rateLimitData: rateLimitDataCleaned,
                timestamp: startTime,
                emailServiceHealth: {
                    status: emailHealth.status,
                    quotaUsage: _emailservicemonitor.emailServiceMonitor.getQuotaUsagePercentage(),
                    successRate: emailStats.successRate,
                    issues: emailHealth.issues
                }
            };
            // Store cleanup stats (keep last 24 entries)
            this.cleanupStats.push(stats);
            if (this.cleanupStats.length > 24) {
                this.cleanupStats.shift();
            }
            this.lastCleanup = startTime;
            const duration = Date.now() - startTime;
            console.log(`[CLEANUP] Email verification cleanup completed in ${duration}ms`);
            return stats;
        } catch (error) {
            console.error('[CLEANUP] Email verification cleanup failed:', error);
            throw error;
        } finally{
            this.isRunning = false;
        }
    }
    /**
   * Schedule automatic cleanup to run periodically
   */ scheduleCleanup(intervalMs = 60 * 60 * 1000) {
        console.log(`[CLEANUP] Scheduling email verification cleanup every ${intervalMs / 1000} seconds`);
        const runScheduledCleanup = async ()=>{
            try {
                await this.runCleanup();
            } catch (error) {
                console.error('[CLEANUP] Scheduled cleanup failed:', error);
            }
        };
        // Run initial cleanup after a short delay
        setTimeout(runScheduledCleanup, 5000); // 5 seconds
        // Then run periodically
        setInterval(runScheduledCleanup, intervalMs);
    }
    /**
   * Run startup cleanup to clean any leftover data
   */ async runStartupCleanup() {
        console.log('[CLEANUP] Running startup cleanup...');
        try {
            const stats = await this.runCleanup();
            console.log('[CLEANUP] Startup cleanup completed successfully');
            return stats;
        } catch (error) {
            console.error('[CLEANUP] Startup cleanup failed:', error);
            throw error;
        }
    }
    /**
   * Get cleanup statistics
   */ getCleanupStats() {
        const totalExpiredCodes = this.cleanupStats.reduce((sum, stat)=>sum + stat.expiredCodes, 0);
        const totalRateLimitData = this.cleanupStats.reduce((sum, stat)=>sum + stat.rateLimitData, 0);
        return {
            lastCleanup: this.lastCleanup,
            isRunning: this.isRunning,
            recentStats: [
                ...this.cleanupStats
            ],
            totalExpiredCodes,
            totalRateLimitData
        };
    }
    /**
   * Get current system status
   */ async getSystemStatus() {
        const codeStats = await _emailverificationcodeservice.emailVerificationCodeService.getCodeStats();
        const rateLimitStats = _emailverificationratelimiter.emailVerificationRateLimiter.getStats();
        const cleanupStats = this.getCleanupStats();
        // Estimate next cleanup time (assuming hourly cleanup)
        const nextCleanupDue = cleanupStats.lastCleanup + 60 * 60 * 1000;
        return {
            verificationCodes: codeStats,
            rateLimits: rateLimitStats,
            cleanup: {
                lastCleanup: cleanupStats.lastCleanup,
                isRunning: cleanupStats.isRunning,
                nextCleanupDue
            }
        };
    }
    /**
   * Force cleanup if needed (for manual triggers)
   */ async forceCleanup() {
        if (this.isRunning) {
            throw new Error('Cleanup is already running. Please wait for it to complete.');
        }
        console.log('[CLEANUP] Force cleanup requested');
        return await this.runCleanup();
    }
    constructor(){
        this.isRunning = false;
        this.lastCleanup = 0;
        this.cleanupStats = [];
    }
}
const emailVerificationCleanupService = new EmailVerificationCleanupService();
// Auto-schedule cleanup when this module is imported
if (process.env.NODE_ENV === 'production') {
    // In production, start cleanup automatically
    emailVerificationCleanupService.scheduleCleanup();
} else {
    // In development, run less frequently to avoid noise
    emailVerificationCleanupService.scheduleCleanup(2 * 60 * 60 * 1000); // 2 hours
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9zdGVmYW5iZWtrZXIvcHJvamVjdHMvZmFuY3ktcGxhbnRpZXMvc3JjL2xpYi9zZXJ2aWNlcy9lbWFpbC12ZXJpZmljYXRpb24tY2xlYW51cC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJ3NlcnZlci1vbmx5JztcbmltcG9ydCB7IGVtYWlsVmVyaWZpY2F0aW9uQ29kZVNlcnZpY2UgfSBmcm9tICcuL2VtYWlsLXZlcmlmaWNhdGlvbi1jb2RlLXNlcnZpY2UnO1xuaW1wb3J0IHsgZW1haWxWZXJpZmljYXRpb25SYXRlTGltaXRlciB9IGZyb20gJy4vZW1haWwtdmVyaWZpY2F0aW9uLXJhdGUtbGltaXRlcic7XG5pbXBvcnQgeyBlbWFpbFNlcnZpY2VNb25pdG9yIH0gZnJvbSAnLi9lbWFpbC1zZXJ2aWNlLW1vbml0b3InO1xuXG5leHBvcnQgaW50ZXJmYWNlIENsZWFudXBTdGF0cyB7XG4gIGV4cGlyZWRDb2RlczogbnVtYmVyO1xuICByYXRlTGltaXREYXRhOiBudW1iZXI7XG4gIHRpbWVzdGFtcDogbnVtYmVyO1xuICBlbWFpbFNlcnZpY2VIZWFsdGg/OiB7XG4gICAgc3RhdHVzOiAnaGVhbHRoeScgfCAnd2FybmluZycgfCAnY3JpdGljYWwnO1xuICAgIHF1b3RhVXNhZ2U6IG51bWJlcjtcbiAgICBzdWNjZXNzUmF0ZTogbnVtYmVyO1xuICAgIGlzc3Vlczogc3RyaW5nW107XG4gIH07XG59XG5cbmV4cG9ydCBjbGFzcyBFbWFpbFZlcmlmaWNhdGlvbkNsZWFudXBTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBpc1J1bm5pbmcgPSBmYWxzZTtcbiAgcHJpdmF0ZSBsYXN0Q2xlYW51cCA9IDA7XG4gIHByaXZhdGUgY2xlYW51cFN0YXRzOiBDbGVhbnVwU3RhdHNbXSA9IFtdO1xuICBcbiAgLyoqXG4gICAqIFJ1biBjbGVhbnVwIG9mIGV4cGlyZWQgdmVyaWZpY2F0aW9uIGNvZGVzIGFuZCByYXRlIGxpbWl0IGRhdGFcbiAgICovXG4gIGFzeW5jIHJ1bkNsZWFudXAoKTogUHJvbWlzZTxDbGVhbnVwU3RhdHM+IHtcbiAgICBpZiAodGhpcy5pc1J1bm5pbmcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2xlYW51cCBpcyBhbHJlYWR5IHJ1bm5pbmcnKTtcbiAgICB9XG4gICAgXG4gICAgdGhpcy5pc1J1bm5pbmcgPSB0cnVlO1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKCdbQ0xFQU5VUF0gU3RhcnRpbmcgZW1haWwgdmVyaWZpY2F0aW9uIGNsZWFudXAuLi4nKTtcbiAgICAgIFxuICAgICAgLy8gQ2xlYW4gdXAgZXhwaXJlZCB2ZXJpZmljYXRpb24gY29kZXNcbiAgICAgIGNvbnN0IGV4cGlyZWRDb2RlcyA9IGF3YWl0IGVtYWlsVmVyaWZpY2F0aW9uQ29kZVNlcnZpY2UuY2xlYW51cEV4cGlyZWRDb2RlcygpO1xuICAgICAgY29uc29sZS5sb2coYFtDTEVBTlVQXSBSZW1vdmVkICR7ZXhwaXJlZENvZGVzfSBleHBpcmVkIHZlcmlmaWNhdGlvbiBjb2Rlc2ApO1xuICAgICAgXG4gICAgICAvLyBDbGVhbiB1cCByYXRlIGxpbWl0IGRhdGFcbiAgICAgIGNvbnN0IHJhdGVMaW1pdFN0YXRzQmVmb3JlID0gZW1haWxWZXJpZmljYXRpb25SYXRlTGltaXRlci5nZXRTdGF0cygpO1xuICAgICAgZW1haWxWZXJpZmljYXRpb25SYXRlTGltaXRlci5jbGVhbnVwKCk7XG4gICAgICBjb25zdCByYXRlTGltaXRTdGF0c0FmdGVyID0gZW1haWxWZXJpZmljYXRpb25SYXRlTGltaXRlci5nZXRTdGF0cygpO1xuICAgICAgXG4gICAgICBjb25zdCByYXRlTGltaXREYXRhQ2xlYW5lZCA9IFxuICAgICAgICAocmF0ZUxpbWl0U3RhdHNCZWZvcmUudmVyaWZpY2F0aW9uQXR0ZW1wdHMgLSByYXRlTGltaXRTdGF0c0FmdGVyLnZlcmlmaWNhdGlvbkF0dGVtcHRzKSArXG4gICAgICAgIChyYXRlTGltaXRTdGF0c0JlZm9yZS5yZXNlbmRSZXF1ZXN0cyAtIHJhdGVMaW1pdFN0YXRzQWZ0ZXIucmVzZW5kUmVxdWVzdHMpICtcbiAgICAgICAgKHJhdGVMaW1pdFN0YXRzQmVmb3JlLmVtYWlsVmVyaWZpY2F0aW9uQWN0aXZpdHkgLSByYXRlTGltaXRTdGF0c0FmdGVyLmVtYWlsVmVyaWZpY2F0aW9uQWN0aXZpdHkpICtcbiAgICAgICAgKHJhdGVMaW1pdFN0YXRzQmVmb3JlLnJlc2VuZENvb2xkb3ducyAtIHJhdGVMaW1pdFN0YXRzQWZ0ZXIucmVzZW5kQ29vbGRvd25zKTtcbiAgICAgIFxuICAgICAgY29uc29sZS5sb2coYFtDTEVBTlVQXSBDbGVhbmVkIHVwICR7cmF0ZUxpbWl0RGF0YUNsZWFuZWR9IHJhdGUgbGltaXQgZW50cmllc2ApO1xuICAgICAgXG4gICAgICAvLyBDaGVjayBlbWFpbCBzZXJ2aWNlIGhlYWx0aFxuICAgICAgY29uc3QgZW1haWxIZWFsdGggPSBlbWFpbFNlcnZpY2VNb25pdG9yLmdldEhlYWx0aFN0YXR1cygpO1xuICAgICAgY29uc3QgZW1haWxTdGF0cyA9IGVtYWlsU2VydmljZU1vbml0b3IuZ2V0U3RhdHMoKTtcbiAgICAgIFxuICAgICAgaWYgKGVtYWlsSGVhbHRoLnN0YXR1cyAhPT0gJ2hlYWx0aHknKSB7XG4gICAgICAgIGNvbnNvbGUud2FybihgW0NMRUFOVVBdIEVtYWlsIHNlcnZpY2UgaGVhbHRoOiAke2VtYWlsSGVhbHRoLnN0YXR1c31gLCB7XG4gICAgICAgICAgaXNzdWVzOiBlbWFpbEhlYWx0aC5pc3N1ZXMsXG4gICAgICAgICAgcmVjb21tZW5kYXRpb25zOiBlbWFpbEhlYWx0aC5yZWNvbW1lbmRhdGlvbnMsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgXG4gICAgICBjb25zdCBzdGF0czogQ2xlYW51cFN0YXRzID0ge1xuICAgICAgICBleHBpcmVkQ29kZXMsXG4gICAgICAgIHJhdGVMaW1pdERhdGE6IHJhdGVMaW1pdERhdGFDbGVhbmVkLFxuICAgICAgICB0aW1lc3RhbXA6IHN0YXJ0VGltZSxcbiAgICAgICAgZW1haWxTZXJ2aWNlSGVhbHRoOiB7XG4gICAgICAgICAgc3RhdHVzOiBlbWFpbEhlYWx0aC5zdGF0dXMsXG4gICAgICAgICAgcXVvdGFVc2FnZTogZW1haWxTZXJ2aWNlTW9uaXRvci5nZXRRdW90YVVzYWdlUGVyY2VudGFnZSgpLFxuICAgICAgICAgIHN1Y2Nlc3NSYXRlOiBlbWFpbFN0YXRzLnN1Y2Nlc3NSYXRlLFxuICAgICAgICAgIGlzc3VlczogZW1haWxIZWFsdGguaXNzdWVzLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICAgIFxuICAgICAgLy8gU3RvcmUgY2xlYW51cCBzdGF0cyAoa2VlcCBsYXN0IDI0IGVudHJpZXMpXG4gICAgICB0aGlzLmNsZWFudXBTdGF0cy5wdXNoKHN0YXRzKTtcbiAgICAgIGlmICh0aGlzLmNsZWFudXBTdGF0cy5sZW5ndGggPiAyNCkge1xuICAgICAgICB0aGlzLmNsZWFudXBTdGF0cy5zaGlmdCgpO1xuICAgICAgfVxuICAgICAgXG4gICAgICB0aGlzLmxhc3RDbGVhbnVwID0gc3RhcnRUaW1lO1xuICAgICAgXG4gICAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICBjb25zb2xlLmxvZyhgW0NMRUFOVVBdIEVtYWlsIHZlcmlmaWNhdGlvbiBjbGVhbnVwIGNvbXBsZXRlZCBpbiAke2R1cmF0aW9ufW1zYCk7XG4gICAgICBcbiAgICAgIHJldHVybiBzdGF0cztcbiAgICAgIFxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdbQ0xFQU5VUF0gRW1haWwgdmVyaWZpY2F0aW9uIGNsZWFudXAgZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlO1xuICAgIH1cbiAgfVxuICBcbiAgLyoqXG4gICAqIFNjaGVkdWxlIGF1dG9tYXRpYyBjbGVhbnVwIHRvIHJ1biBwZXJpb2RpY2FsbHlcbiAgICovXG4gIHNjaGVkdWxlQ2xlYW51cChpbnRlcnZhbE1zOiBudW1iZXIgPSA2MCAqIDYwICogMTAwMCk6IHZvaWQgeyAvLyBEZWZhdWx0OiAxIGhvdXJcbiAgICBjb25zb2xlLmxvZyhgW0NMRUFOVVBdIFNjaGVkdWxpbmcgZW1haWwgdmVyaWZpY2F0aW9uIGNsZWFudXAgZXZlcnkgJHtpbnRlcnZhbE1zIC8gMTAwMH0gc2Vjb25kc2ApO1xuICAgIFxuICAgIGNvbnN0IHJ1blNjaGVkdWxlZENsZWFudXAgPSBhc3luYyAoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnJ1bkNsZWFudXAoKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tDTEVBTlVQXSBTY2hlZHVsZWQgY2xlYW51cCBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgfVxuICAgIH07XG4gICAgXG4gICAgLy8gUnVuIGluaXRpYWwgY2xlYW51cCBhZnRlciBhIHNob3J0IGRlbGF5XG4gICAgc2V0VGltZW91dChydW5TY2hlZHVsZWRDbGVhbnVwLCA1MDAwKTsgLy8gNSBzZWNvbmRzXG4gICAgXG4gICAgLy8gVGhlbiBydW4gcGVyaW9kaWNhbGx5XG4gICAgc2V0SW50ZXJ2YWwocnVuU2NoZWR1bGVkQ2xlYW51cCwgaW50ZXJ2YWxNcyk7XG4gIH1cbiAgXG4gIC8qKlxuICAgKiBSdW4gc3RhcnR1cCBjbGVhbnVwIHRvIGNsZWFuIGFueSBsZWZ0b3ZlciBkYXRhXG4gICAqL1xuICBhc3luYyBydW5TdGFydHVwQ2xlYW51cCgpOiBQcm9taXNlPENsZWFudXBTdGF0cz4ge1xuICAgIGNvbnNvbGUubG9nKCdbQ0xFQU5VUF0gUnVubmluZyBzdGFydHVwIGNsZWFudXAuLi4nKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc3RhdHMgPSBhd2FpdCB0aGlzLnJ1bkNsZWFudXAoKTtcbiAgICAgIGNvbnNvbGUubG9nKCdbQ0xFQU5VUF0gU3RhcnR1cCBjbGVhbnVwIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHknKTtcbiAgICAgIHJldHVybiBzdGF0cztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignW0NMRUFOVVBdIFN0YXJ0dXAgY2xlYW51cCBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG4gIFxuICAvKipcbiAgICogR2V0IGNsZWFudXAgc3RhdGlzdGljc1xuICAgKi9cbiAgZ2V0Q2xlYW51cFN0YXRzKCk6IHtcbiAgICBsYXN0Q2xlYW51cDogbnVtYmVyO1xuICAgIGlzUnVubmluZzogYm9vbGVhbjtcbiAgICByZWNlbnRTdGF0czogQ2xlYW51cFN0YXRzW107XG4gICAgdG90YWxFeHBpcmVkQ29kZXM6IG51bWJlcjtcbiAgICB0b3RhbFJhdGVMaW1pdERhdGE6IG51bWJlcjtcbiAgfSB7XG4gICAgY29uc3QgdG90YWxFeHBpcmVkQ29kZXMgPSB0aGlzLmNsZWFudXBTdGF0cy5yZWR1Y2UoKHN1bSwgc3RhdCkgPT4gc3VtICsgc3RhdC5leHBpcmVkQ29kZXMsIDApO1xuICAgIGNvbnN0IHRvdGFsUmF0ZUxpbWl0RGF0YSA9IHRoaXMuY2xlYW51cFN0YXRzLnJlZHVjZSgoc3VtLCBzdGF0KSA9PiBzdW0gKyBzdGF0LnJhdGVMaW1pdERhdGEsIDApO1xuICAgIFxuICAgIHJldHVybiB7XG4gICAgICBsYXN0Q2xlYW51cDogdGhpcy5sYXN0Q2xlYW51cCxcbiAgICAgIGlzUnVubmluZzogdGhpcy5pc1J1bm5pbmcsXG4gICAgICByZWNlbnRTdGF0czogWy4uLnRoaXMuY2xlYW51cFN0YXRzXSxcbiAgICAgIHRvdGFsRXhwaXJlZENvZGVzLFxuICAgICAgdG90YWxSYXRlTGltaXREYXRhLFxuICAgIH07XG4gIH1cbiAgXG4gIC8qKlxuICAgKiBHZXQgY3VycmVudCBzeXN0ZW0gc3RhdHVzXG4gICAqL1xuICBhc3luYyBnZXRTeXN0ZW1TdGF0dXMoKTogUHJvbWlzZTx7XG4gICAgdmVyaWZpY2F0aW9uQ29kZXM6IHtcbiAgICAgIHRvdGFsQWN0aXZlOiBudW1iZXI7XG4gICAgICBleHBpcmVkQ291bnQ6IG51bWJlcjtcbiAgICAgIGhpZ2hBdHRlbXB0Q291bnQ6IG51bWJlcjtcbiAgICB9O1xuICAgIHJhdGVMaW1pdHM6IHtcbiAgICAgIHZlcmlmaWNhdGlvbkF0dGVtcHRzOiBudW1iZXI7XG4gICAgICByZXNlbmRSZXF1ZXN0czogbnVtYmVyO1xuICAgICAgZW1haWxWZXJpZmljYXRpb25BY3Rpdml0eTogbnVtYmVyO1xuICAgICAgcmVzZW5kQ29vbGRvd25zOiBudW1iZXI7XG4gICAgICBzZWN1cml0eUV2ZW50czogbnVtYmVyO1xuICAgIH07XG4gICAgY2xlYW51cDoge1xuICAgICAgbGFzdENsZWFudXA6IG51bWJlcjtcbiAgICAgIGlzUnVubmluZzogYm9vbGVhbjtcbiAgICAgIG5leHRDbGVhbnVwRHVlOiBudW1iZXI7XG4gICAgfTtcbiAgfT4ge1xuICAgIGNvbnN0IGNvZGVTdGF0cyA9IGF3YWl0IGVtYWlsVmVyaWZpY2F0aW9uQ29kZVNlcnZpY2UuZ2V0Q29kZVN0YXRzKCk7XG4gICAgY29uc3QgcmF0ZUxpbWl0U3RhdHMgPSBlbWFpbFZlcmlmaWNhdGlvblJhdGVMaW1pdGVyLmdldFN0YXRzKCk7XG4gICAgY29uc3QgY2xlYW51cFN0YXRzID0gdGhpcy5nZXRDbGVhbnVwU3RhdHMoKTtcbiAgICBcbiAgICAvLyBFc3RpbWF0ZSBuZXh0IGNsZWFudXAgdGltZSAoYXNzdW1pbmcgaG91cmx5IGNsZWFudXApXG4gICAgY29uc3QgbmV4dENsZWFudXBEdWUgPSBjbGVhbnVwU3RhdHMubGFzdENsZWFudXAgKyAoNjAgKiA2MCAqIDEwMDApO1xuICAgIFxuICAgIHJldHVybiB7XG4gICAgICB2ZXJpZmljYXRpb25Db2RlczogY29kZVN0YXRzLFxuICAgICAgcmF0ZUxpbWl0czogcmF0ZUxpbWl0U3RhdHMsXG4gICAgICBjbGVhbnVwOiB7XG4gICAgICAgIGxhc3RDbGVhbnVwOiBjbGVhbnVwU3RhdHMubGFzdENsZWFudXAsXG4gICAgICAgIGlzUnVubmluZzogY2xlYW51cFN0YXRzLmlzUnVubmluZyxcbiAgICAgICAgbmV4dENsZWFudXBEdWUsXG4gICAgICB9LFxuICAgIH07XG4gIH1cbiAgXG4gIC8qKlxuICAgKiBGb3JjZSBjbGVhbnVwIGlmIG5lZWRlZCAoZm9yIG1hbnVhbCB0cmlnZ2VycylcbiAgICovXG4gIGFzeW5jIGZvcmNlQ2xlYW51cCgpOiBQcm9taXNlPENsZWFudXBTdGF0cz4ge1xuICAgIGlmICh0aGlzLmlzUnVubmluZykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDbGVhbnVwIGlzIGFscmVhZHkgcnVubmluZy4gUGxlYXNlIHdhaXQgZm9yIGl0IHRvIGNvbXBsZXRlLicpO1xuICAgIH1cbiAgICBcbiAgICBjb25zb2xlLmxvZygnW0NMRUFOVVBdIEZvcmNlIGNsZWFudXAgcmVxdWVzdGVkJyk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucnVuQ2xlYW51cCgpO1xuICB9XG59XG5cbi8vIEV4cG9ydCBzaW5nbGV0b24gaW5zdGFuY2VcbmV4cG9ydCBjb25zdCBlbWFpbFZlcmlmaWNhdGlvbkNsZWFudXBTZXJ2aWNlID0gbmV3IEVtYWlsVmVyaWZpY2F0aW9uQ2xlYW51cFNlcnZpY2UoKTtcblxuLy8gQXV0by1zY2hlZHVsZSBjbGVhbnVwIHdoZW4gdGhpcyBtb2R1bGUgaXMgaW1wb3J0ZWRcbmlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nKSB7XG4gIC8vIEluIHByb2R1Y3Rpb24sIHN0YXJ0IGNsZWFudXAgYXV0b21hdGljYWxseVxuICBlbWFpbFZlcmlmaWNhdGlvbkNsZWFudXBTZXJ2aWNlLnNjaGVkdWxlQ2xlYW51cCgpO1xufSBlbHNlIHtcbiAgLy8gSW4gZGV2ZWxvcG1lbnQsIHJ1biBsZXNzIGZyZXF1ZW50bHkgdG8gYXZvaWQgbm9pc2VcbiAgZW1haWxWZXJpZmljYXRpb25DbGVhbnVwU2VydmljZS5zY2hlZHVsZUNsZWFudXAoMiAqIDYwICogNjAgKiAxMDAwKTsgLy8gMiBob3Vyc1xufSJdLCJuYW1lcyI6WyJFbWFpbFZlcmlmaWNhdGlvbkNsZWFudXBTZXJ2aWNlIiwiZW1haWxWZXJpZmljYXRpb25DbGVhbnVwU2VydmljZSIsInJ1bkNsZWFudXAiLCJpc1J1bm5pbmciLCJFcnJvciIsInN0YXJ0VGltZSIsIkRhdGUiLCJub3ciLCJjb25zb2xlIiwibG9nIiwiZXhwaXJlZENvZGVzIiwiZW1haWxWZXJpZmljYXRpb25Db2RlU2VydmljZSIsImNsZWFudXBFeHBpcmVkQ29kZXMiLCJyYXRlTGltaXRTdGF0c0JlZm9yZSIsImVtYWlsVmVyaWZpY2F0aW9uUmF0ZUxpbWl0ZXIiLCJnZXRTdGF0cyIsImNsZWFudXAiLCJyYXRlTGltaXRTdGF0c0FmdGVyIiwicmF0ZUxpbWl0RGF0YUNsZWFuZWQiLCJ2ZXJpZmljYXRpb25BdHRlbXB0cyIsInJlc2VuZFJlcXVlc3RzIiwiZW1haWxWZXJpZmljYXRpb25BY3Rpdml0eSIsInJlc2VuZENvb2xkb3ducyIsImVtYWlsSGVhbHRoIiwiZW1haWxTZXJ2aWNlTW9uaXRvciIsImdldEhlYWx0aFN0YXR1cyIsImVtYWlsU3RhdHMiLCJzdGF0dXMiLCJ3YXJuIiwiaXNzdWVzIiwicmVjb21tZW5kYXRpb25zIiwic3RhdHMiLCJyYXRlTGltaXREYXRhIiwidGltZXN0YW1wIiwiZW1haWxTZXJ2aWNlSGVhbHRoIiwicXVvdGFVc2FnZSIsImdldFF1b3RhVXNhZ2VQZXJjZW50YWdlIiwic3VjY2Vzc1JhdGUiLCJjbGVhbnVwU3RhdHMiLCJwdXNoIiwibGVuZ3RoIiwic2hpZnQiLCJsYXN0Q2xlYW51cCIsImR1cmF0aW9uIiwiZXJyb3IiLCJzY2hlZHVsZUNsZWFudXAiLCJpbnRlcnZhbE1zIiwicnVuU2NoZWR1bGVkQ2xlYW51cCIsInNldFRpbWVvdXQiLCJzZXRJbnRlcnZhbCIsInJ1blN0YXJ0dXBDbGVhbnVwIiwiZ2V0Q2xlYW51cFN0YXRzIiwidG90YWxFeHBpcmVkQ29kZXMiLCJyZWR1Y2UiLCJzdW0iLCJzdGF0IiwidG90YWxSYXRlTGltaXREYXRhIiwicmVjZW50U3RhdHMiLCJnZXRTeXN0ZW1TdGF0dXMiLCJjb2RlU3RhdHMiLCJnZXRDb2RlU3RhdHMiLCJyYXRlTGltaXRTdGF0cyIsIm5leHRDbGVhbnVwRHVlIiwidmVyaWZpY2F0aW9uQ29kZXMiLCJyYXRlTGltaXRzIiwiZm9yY2VDbGVhbnVwIiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztRQWlCYUE7ZUFBQUE7O1FBaU1BQztlQUFBQTs7O1FBbE5OOzhDQUNzQzs4Q0FDQTtxQ0FDVDtBQWM3QixNQUFNRDtJQUtYOztHQUVDLEdBQ0QsTUFBTUUsYUFBb0M7UUFDeEMsSUFBSSxJQUFJLENBQUNDLFNBQVMsRUFBRTtZQUNsQixNQUFNLElBQUlDLE1BQU07UUFDbEI7UUFFQSxJQUFJLENBQUNELFNBQVMsR0FBRztRQUNqQixNQUFNRSxZQUFZQyxLQUFLQyxHQUFHO1FBRTFCLElBQUk7WUFDRkMsUUFBUUMsR0FBRyxDQUFDO1lBRVosc0NBQXNDO1lBQ3RDLE1BQU1DLGVBQWUsTUFBTUMsMERBQTRCLENBQUNDLG1CQUFtQjtZQUMzRUosUUFBUUMsR0FBRyxDQUFDLENBQUMsa0JBQWtCLEVBQUVDLGFBQWEsMkJBQTJCLENBQUM7WUFFMUUsMkJBQTJCO1lBQzNCLE1BQU1HLHVCQUF1QkMsMERBQTRCLENBQUNDLFFBQVE7WUFDbEVELDBEQUE0QixDQUFDRSxPQUFPO1lBQ3BDLE1BQU1DLHNCQUFzQkgsMERBQTRCLENBQUNDLFFBQVE7WUFFakUsTUFBTUcsdUJBQ0osQUFBQ0wscUJBQXFCTSxvQkFBb0IsR0FBR0Ysb0JBQW9CRSxvQkFBb0IsR0FDcEZOLENBQUFBLHFCQUFxQk8sY0FBYyxHQUFHSCxvQkFBb0JHLGNBQWMsQUFBRCxJQUN2RVAsQ0FBQUEscUJBQXFCUSx5QkFBeUIsR0FBR0osb0JBQW9CSSx5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