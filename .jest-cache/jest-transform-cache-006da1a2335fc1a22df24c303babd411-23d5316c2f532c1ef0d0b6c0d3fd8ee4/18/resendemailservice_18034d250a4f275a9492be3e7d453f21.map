{"version":3,"sources":["/Users/stefanbekker/projects/fancy-planties/src/lib/services/resend-email-service.ts"],"sourcesContent":["import 'server-only';\nimport { Resend } from 'resend';\nimport { EmailService, EmailConfig, EmailServiceError } from './email-service';\nimport { emailServiceMonitor } from './email-service-monitor';\n\nexport class ResendEmailService implements EmailService {\n  private resend: Resend;\n  private config: EmailConfig;\n\n  constructor(config: EmailConfig) {\n    this.resend = new Resend(config.apiKey);\n    this.config = config;\n  }\n\n  async sendPasswordResetEmail(email: string, resetToken: string, name: string): Promise<boolean> {\n    const startTime = Date.now();\n    \n    try {\n      const resetUrl = `${process.env.NEXT_PUBLIC_APP_URL}/auth/reset-password?token=${resetToken}`;\n      \n      const { data, error } = await this.resend.emails.send({\n        from: `${this.config.fromName} <${this.config.fromEmail}>`,\n        to: [email],\n        subject: 'Reset your password',\n        html: this.generatePasswordResetEmailTemplate(resetUrl, name),\n        text: this.generatePasswordResetEmailText(resetUrl, name),\n      });\n\n      const responseTime = Date.now() - startTime;\n\n      if (error) {\n        console.error('Resend API error:', error);\n        \n        // Map Resend errors to our error types\n        let emailError: EmailServiceError;\n        if (error.message?.includes('quota') || error.message?.includes('limit')) {\n          emailError = new EmailServiceError('Email quota exceeded', 'QUOTA_EXCEEDED');\n        } else if (error.message?.includes('invalid') && error.message?.includes('email')) {\n          emailError = new EmailServiceError('Invalid email address', 'INVALID_EMAIL');\n        } else {\n          emailError = new EmailServiceError(`Resend API error: ${error.message}`, 'API_ERROR');\n        }\n        \n        // Record failure in monitor\n        emailServiceMonitor.recordFailure(\n          { message: emailError.message, code: emailError.code },\n          responseTime\n        );\n        \n        throw emailError;\n      }\n\n      // Record success in monitor\n      emailServiceMonitor.recordSuccess(responseTime);\n      \n      console.log('Password reset email sent successfully:', data?.id);\n      return true;\n      \n    } catch (error) {\n      const responseTime = Date.now() - startTime;\n      \n      if (error instanceof EmailServiceError) {\n        // Already recorded in monitor above\n        throw error;\n      }\n      \n      console.error('Network error sending password reset email:', error);\n      const networkError = new EmailServiceError(\n        `Network error: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        'NETWORK_ERROR'\n      );\n      \n      // Record network error in monitor\n      emailServiceMonitor.recordFailure(\n        { message: networkError.message, code: networkError.code },\n        responseTime\n      );\n      \n      throw networkError;\n    }\n  }\n\n  async sendVerificationEmail(email: string, code: string, name: string): Promise<boolean> {\n    const startTime = Date.now();\n    \n    try {\n      const { data, error } = await this.resend.emails.send({\n        from: `${this.config.fromName} <${this.config.fromEmail}>`,\n        to: [email],\n        subject: 'Verify your email address',\n        html: this.generateVerificationEmailTemplate(code, name),\n        text: this.generateVerificationEmailText(code, name),\n      });\n\n      const responseTime = Date.now() - startTime;\n\n      if (error) {\n        console.error('Resend API error:', error);\n        \n        // Map Resend errors to our error types\n        let emailError: EmailServiceError;\n        if (error.message?.includes('quota') || error.message?.includes('limit')) {\n          emailError = new EmailServiceError('Email quota exceeded', 'QUOTA_EXCEEDED');\n        } else if (error.message?.includes('invalid') && error.message?.includes('email')) {\n          emailError = new EmailServiceError('Invalid email address', 'INVALID_EMAIL');\n        } else {\n          emailError = new EmailServiceError(`Resend API error: ${error.message}`, 'API_ERROR');\n        }\n        \n        // Record failure in monitor\n        emailServiceMonitor.recordFailure(\n          { message: emailError.message, code: emailError.code },\n          responseTime\n        );\n        \n        throw emailError;\n      }\n\n      // Record success in monitor\n      emailServiceMonitor.recordSuccess(responseTime);\n      \n      console.log('Verification email sent successfully:', data?.id);\n      return true;\n      \n    } catch (error) {\n      const responseTime = Date.now() - startTime;\n      \n      if (error instanceof EmailServiceError) {\n        // Already recorded in monitor above\n        throw error;\n      }\n      \n      console.error('Network error sending email:', error);\n      const networkError = new EmailServiceError(\n        `Network error: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        'NETWORK_ERROR'\n      );\n      \n      // Record network error in monitor\n      emailServiceMonitor.recordFailure(\n        { message: networkError.message, code: networkError.code },\n        responseTime\n      );\n      \n      throw networkError;\n    }\n  }\n\n  private generateVerificationEmailTemplate(code: string, name: string): string {\n    return `\n      <!DOCTYPE html>\n      <html lang=\"en\">\n      <head>\n        <meta charset=\"UTF-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        <title>Verify Your Email</title>\n        <style>\n          body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            line-height: 1.6;\n            color: #333;\n            max-width: 600px;\n            margin: 0 auto;\n            padding: 20px;\n          }\n          .header {\n            text-align: center;\n            margin-bottom: 30px;\n          }\n          .logo {\n            font-size: 24px;\n            font-weight: bold;\n            color: #22c55e;\n            margin-bottom: 10px;\n          }\n          .verification-code {\n            background: #f8f9fa;\n            border: 2px solid #e9ecef;\n            border-radius: 8px;\n            padding: 20px;\n            text-align: center;\n            margin: 30px 0;\n          }\n          .code {\n            font-size: 32px;\n            font-weight: bold;\n            letter-spacing: 4px;\n            color: #22c55e;\n            font-family: 'Courier New', monospace;\n          }\n          .footer {\n            margin-top: 30px;\n            padding-top: 20px;\n            border-top: 1px solid #e9ecef;\n            font-size: 14px;\n            color: #6c757d;\n          }\n        </style>\n      </head>\n      <body>\n        <div class=\"header\">\n          <div class=\"logo\">ðŸŒ± Fancy Planties</div>\n          <h1>Verify Your Email Address</h1>\n        </div>\n        \n        <p>Hi ${name},</p>\n        \n        <p>Welcome to Fancy Planties! To complete your account setup, please verify your email address by entering the verification code below:</p>\n        \n        <div class=\"verification-code\">\n          <div class=\"code\">${code}</div>\n          <p style=\"margin: 10px 0 0 0; font-size: 14px; color: #6c757d;\">\n            This code expires in 10 minutes\n          </p>\n        </div>\n        \n        <p>If you didn't create an account with Fancy Planties, you can safely ignore this email.</p>\n        \n        <div class=\"footer\">\n          <p>This is an automated message from Fancy Planties. Please do not reply to this email.</p>\n          <p>Need help? Contact us at support@fancy-planties.cloudagrapher.com</p>\n        </div>\n      </body>\n      </html>\n    `;\n  }\n\n  private generateVerificationEmailText(code: string, name: string): string {\n    return `\nHi ${name},\n\nWelcome to Fancy Planties! To complete your account setup, please verify your email address by entering the verification code below:\n\nVerification Code: ${code}\n\nThis code expires in 10 minutes.\n\nIf you didn't create an account with Fancy Planties, you can safely ignore this email.\n\n---\nThis is an automated message from Fancy Planties. Please do not reply to this email.\nNeed help? Contact us at support@fancy-planties.cloudagrapher.com\n    `.trim();\n  }\n\n  private generatePasswordResetEmailTemplate(resetUrl: string, name: string): string {\n    return `\n      <!DOCTYPE html>\n      <html lang=\"en\">\n      <head>\n        <meta charset=\"UTF-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        <title>Reset Your Password</title>\n        <style>\n          body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            line-height: 1.6;\n            color: #333;\n            max-width: 600px;\n            margin: 0 auto;\n            padding: 20px;\n          }\n          .header {\n            text-align: center;\n            margin-bottom: 30px;\n          }\n          .logo {\n            font-size: 24px;\n            font-weight: bold;\n            color: #22c55e;\n            margin-bottom: 10px;\n          }\n          .reset-button {\n            display: inline-block;\n            background: #22c55e;\n            color: white;\n            padding: 12px 24px;\n            text-decoration: none;\n            border-radius: 6px;\n            font-weight: bold;\n            text-align: center;\n            margin: 20px 0;\n          }\n          .reset-link {\n            background: #f8f9fa;\n            border: 2px solid #e9ecef;\n            border-radius: 8px;\n            padding: 20px;\n            text-align: center;\n            margin: 30px 0;\n            word-break: break-all;\n          }\n          .footer {\n            margin-top: 30px;\n            padding-top: 20px;\n            border-top: 1px solid #e9ecef;\n            font-size: 14px;\n            color: #6c757d;\n          }\n          .warning {\n            background: #fff3cd;\n            border: 1px solid #ffeaa7;\n            border-radius: 6px;\n            padding: 15px;\n            margin: 20px 0;\n            color: #856404;\n          }\n        </style>\n      </head>\n      <body>\n        <div class=\"header\">\n          <div class=\"logo\">ðŸŒ± Fancy Planties</div>\n          <h1>Password Reset Request</h1>\n        </div>\n        \n        <p>Hi ${name},</p>\n        \n        <p>We received a request to reset your password for your Fancy Planties account. If you made this request, click the button below to reset your password:</p>\n        \n        <div style=\"text-align: center;\">\n          <a href=\"${resetUrl}\" class=\"reset-button\">Reset Your Password</a>\n        </div>\n        \n        <p>If the button doesn't work, you can copy and paste this link into your browser:</p>\n        \n        <div class=\"reset-link\">\n          <a href=\"${resetUrl}\">${resetUrl}</a>\n        </div>\n        \n        <div class=\"warning\">\n          <strong>Security Notice:</strong> This password reset link will expire in 1 hour for your security. If you didn't request this password reset, you can safely ignore this email.\n        </div>\n        \n        <p>If you're having trouble or didn't request this reset, please contact our support team.</p>\n        \n        <div class=\"footer\">\n          <p>This is an automated message from Fancy Planties. Please do not reply to this email.</p>\n          <p>Need help? Contact us at support@fancy-planties.cloudagrapher.com</p>\n        </div>\n      </body>\n      </html>\n    `;\n  }\n\n  private generatePasswordResetEmailText(resetUrl: string, name: string): string {\n    return `\nHi ${name},\n\nWe received a request to reset your password for your Fancy Planties account.\n\nTo reset your password, click this link or copy it into your browser:\n${resetUrl}\n\nThis link will expire in 1 hour for your security.\n\nIf you didn't request this password reset, you can safely ignore this email.\n\n---\nThis is an automated message from Fancy Planties. Please do not reply to this email.\nNeed help? Contact us at support@fancy-planties.cloudagrapher.com\n    `.trim();\n  }\n}\n\n// Factory function to create email service instance\nexport function createEmailService(): EmailService {\n  const config: EmailConfig = {\n    apiKey: process.env.RESEND_API_KEY!,\n    fromEmail: process.env.FROM_EMAIL || 'send.mail.fancy-planties.cloudagrapher.com',\n    fromName: process.env.FROM_NAME || 'Fancy Planties',\n  };\n\n  if (!config.apiKey) {\n    throw new Error('RESEND_API_KEY environment variable is required');\n  }\n\n  return new ResendEmailService(config);\n}"],"names":["ResendEmailService","createEmailService","config","resend","Resend","apiKey","sendPasswordResetEmail","email","resetToken","name","startTime","Date","now","resetUrl","process","env","NEXT_PUBLIC_APP_URL","data","error","emails","send","from","fromName","fromEmail","to","subject","html","generatePasswordResetEmailTemplate","text","generatePasswordResetEmailText","responseTime","console","emailError","message","includes","EmailServiceError","emailServiceMonitor","recordFailure","code","recordSuccess","log","id","networkError","Error","sendVerificationEmail","generateVerificationEmailTemplate","generateVerificationEmailText","trim","RESEND_API_KEY","FROM_EMAIL","FROM_NAME"],"mappings":";;;;;;;;;;;QAKaA;eAAAA;;QAwWGC;eAAAA;;;QA7WT;wBACgB;8BACsC;qCACzB;AAE7B,MAAMD;IAIX,YAAYE,MAAmB,CAAE;QAC/B,IAAI,CAACC,MAAM,GAAG,IAAIC,cAAM,CAACF,OAAOG,MAAM;QACtC,IAAI,CAACH,MAAM,GAAGA;IAChB;IAEA,MAAMI,uBAAuBC,KAAa,EAAEC,UAAkB,EAAEC,IAAY,EAAoB;QAC9F,MAAMC,YAAYC,KAAKC,GAAG;QAE1B,IAAI;YACF,MAAMC,WAAW,GAAGC,QAAQC,GAAG,CAACC,mBAAmB,CAAC,2BAA2B,EAAER,YAAY;YAE7F,MAAM,EAAES,IAAI,EAAEC,KAAK,EAAE,GAAG,MAAM,IAAI,CAACf,MAAM,CAACgB,MAAM,CAACC,IAAI,CAAC;gBACpDC,MAAM,GAAG,IAAI,CAACnB,MAAM,CAACoB,QAAQ,CAAC,EAAE,EAAE,IAAI,CAACpB,MAAM,CAACqB,SAAS,CAAC,CAAC,CAAC;gBAC1DC,IAAI;oBAACjB;iBAAM;gBACXkB,SAAS;gBACTC,MAAM,IAAI,CAACC,kCAAkC,CAACd,UAAUJ;gBACxDmB,MAAM,IAAI,CAACC,8BAA8B,CAAChB,UAAUJ;YACtD;YAEA,MAAMqB,eAAenB,KAAKC,GAAG,KAAKF;YAElC,IAAIQ,OAAO;gBACTa,QAAQb,KAAK,CAAC,qBAAqBA;gBAEnC,uCAAuC;gBACvC,IAAIc;gBACJ,IAAId,MAAMe,OAAO,EAAEC,SAAS,YAAYhB,MAAMe,OAAO,EAAEC,SAAS,UAAU;oBACxEF,aAAa,IAAIG,+BAAiB,CAAC,wBAAwB;gBAC7D,OAAO,IAAIjB,MAAMe,OAAO,EAAEC,SAAS,cAAchB,MAAMe,OAAO,EAAEC,SAAS,UAAU;oBACjFF,aAAa,IAAIG,+BAAiB,CAAC,yBAAyB;gBAC9D,OAAO;oBACLH,aAAa,IAAIG,+BAAiB,CAAC,CAAC,kBAAkB,EAAEjB,MAAMe,OAAO,EAAE,EAAE;gBAC3E;gBAEA,4BAA4B;gBAC5BG,wCAAmB,CAACC,aAAa,CAC/B;oBAAEJ,SAASD,WAAWC,OAAO;oBAAEK,MAAMN,WAAWM,IAAI;gBAAC,GACrDR;gBAGF,MAAME;YACR;YAEA,4BAA4B;YAC5BI,wCAAmB,CAACG,aAAa,CAACT;YAElCC,QAAQS,GAAG,CAAC,2CAA2CvB,MAAMwB;YAC7D,OAAO;QAET,EAAE,OAAOvB,OAAO;YACd,MAAMY,eAAenB,KAAKC,GAAG,KAAKF;YAElC,IAAIQ,iBAAiBiB,+BAAiB,EAAE;gBACtC,oCAAoC;gBACpC,MAAMjB;YACR;YAEAa,QAAQb,KAAK,CAAC,+CAA+CA;YAC7D,MAAMwB,eAAe,IAAIP,+BAAiB,CACxC,CAAC,eAAe,EAAEjB,iBAAiByB,QAAQzB,MAAMe,OAAO,GAAG,iBAAiB,EAC5E;YAGF,kCAAkC;YAClCG,wCAAmB,CAACC,aAAa,CAC/B;gBAAEJ,SAASS,aAAaT,OAAO;gBAAEK,MAAMI,aAAaJ,IAAI;YAAC,GACzDR;YAGF,MAAMY;QACR;IACF;IAEA,MAAME,sBAAsBrC,KAAa,EAAE+B,IAAY,EAAE7B,IAAY,EAAoB;QACvF,MAAMC,YAAYC,KAAKC,GAAG;QAE1B,IAAI;YACF,MAAM,EAAEK,IAAI,EAAEC,KAAK,EAAE,GAAG,MAAM,IAAI,CAACf,MAAM,CAACgB,MAAM,CAACC,IAAI,CAAC;gBACpDC,MAAM,GAAG,IAAI,CAACnB,MAAM,CAACoB,QAAQ,CAAC,EAAE,EAAE,IAAI,CAACpB,MAAM,CAACqB,SAAS,CAAC,CAAC,CAAC;gBAC1DC,IAAI;oBAACjB;iBAAM;gBACXkB,SAAS;gBACTC,MAAM,IAAI,CAACmB,iCAAiC,CAACP,MAAM7B;gBACnDmB,MAAM,IAAI,CAACkB,6BAA6B,CAACR,MAAM7B;YACjD;YAEA,MAAMqB,eAAenB,KAAKC,GAAG,KAAKF;YAElC,IAAIQ,OAAO;gBACTa,QAAQb,KAAK,CAAC,qBAAqBA;gBAEnC,uCAAuC;gBACvC,IAAIc;gBACJ,IAAId,MAAMe,OAAO,EAAEC,SAAS,YAAYhB,MAAMe,OAAO,EAAEC,SAAS,UAAU;oBACxEF,aAAa,IAAIG,+BAAiB,CAAC,wBAAwB;gBAC7D,OAAO,IAAIjB,MAAMe,OAAO,EAAEC,SAAS,cAAchB,MAAMe,OAAO,EAAEC,SAAS,UAAU;oBACjFF,aAAa,IAAIG,+BAAiB,CAAC,yBAAyB;gBAC9D,OAAO;oBACLH,aAAa,IAAIG,+BAAiB,CAAC,CAAC,kBAAkB,EAAEjB,MAAMe,OAAO,EAAE,EAAE;gBAC3E;gBAEA,4BAA4B;gBAC5BG,wCAAmB,CAACC,aAAa,CAC/B;oBAAEJ,SAASD,WAAWC,OAAO;oBAAEK,MAAMN,WAAWM,IAAI;gBAAC,GACrDR;gBAGF,MAAME;YACR;YAEA,4BAA4B;YAC5BI,wCAAmB,CAACG,aAAa,CAACT;YAElCC,QAAQS,GAAG,CAAC,yCAAyCvB,MAAMwB;YAC3D,OAAO;QAET,EAAE,OAAOvB,OAAO;YACd,MAAMY,eAAenB,KAAKC,GAAG,KAAKF;YAElC,IAAIQ,iBAAiBiB,+BAAiB,EAAE;gBACtC,oCAAoC;gBACpC,MAAMjB;YACR;YAEAa,QAAQb,KAAK,CAAC,gCAAgCA;YAC9C,MAAMwB,eAAe,IAAIP,+BAAiB,CACxC,CAAC,eAAe,EAAEjB,iBAAiByB,QAAQzB,MAAMe,OAAO,GAAG,iBAAiB,EAC5E;YAGF,kCAAkC;YAClCG,wCAAmB,CAACC,aAAa,CAC/B;gBAAEJ,SAASS,aAAaT,OAAO;gBAAEK,MAAMI,aAAaJ,IAAI;YAAC,GACzDR;YAGF,MAAMY;QACR;IACF;IAEQG,kCAAkCP,IAAY,EAAE7B,IAAY,EAAU;QAC5E,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;cAwDE,EAAEA,KAAK;;;;;4BAKO,EAAE6B,KAAK;;;;;;;;;;;;;;IAc/B,CAAC;IACH;IAEQQ,8BAA8BR,IAAY,EAAE7B,IAAY,EAAU;QACxE,OAAO,CAAC;GACT,EAAEA,KAAK;;;;mBAIS,EAAE6B,KAAK;;;;;;;;;IAStB,CAAC,CAACS,IAAI;IACR;IAEQpB,mCAAmCd,QAAgB,EAAEJ,IAAY,EAAU;QACjF,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;cAqEE,EAAEA,KAAK;;;;;mBAKF,EAAEI,SAAS;;;;;;mBAMX,EAAEA,SAAS,EAAE,EAAEA,SAAS;;;;;;;;;;;;;;;IAevC,CAAC;IACH;IAEQgB,+BAA+BhB,QAAgB,EAAEJ,IAAY,EAAU;QAC7E,OAAO,CAAC;GACT,EAAEA,KAAK;;;;;AAKV,EAAEI,SAAS;;;;;;;;;IASP,CAAC,CAACkC,IAAI;IACR;AACF;AAGO,SAAS9C;IACd,MAAMC,SAAsB;QAC1BG,QAAQS,QAAQC,GAAG,CAACiC,cAAc;QAClCzB,WAAWT,QAAQC,GAAG,CAACkC,UAAU,IAAI;QACrC3B,UAAUR,QAAQC,GAAG,CAACmC,SAAS,IAAI;IACrC;IAEA,IAAI,CAAChD,OAAOG,MAAM,EAAE;QAClB,MAAM,IAAIsC,MAAM;IAClB;IAEA,OAAO,IAAI3C,mBAAmBE;AAChC"}