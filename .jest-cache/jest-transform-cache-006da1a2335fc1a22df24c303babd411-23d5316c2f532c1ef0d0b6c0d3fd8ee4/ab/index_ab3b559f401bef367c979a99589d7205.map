{"version":3,"names":["MigrationUtils","cov_vnwjefgc5","f","s","_migrations","and","_drizzleorm","asc","checkDatabaseConnection","clearUserContext","closeDatabaseConnection","db","desc","eq","setUserContext","sql","withTransaction","exports","connectionString","b","process","env","DATABASE_URL","client","_postgres","default","prepare","max","idle_timeout","connect_timeout","onnotice","NODE_ENV","console","log","undefined","_postgresjs","drizzle","schema","_schema","logger","execute","error","userId","Error","callback","transaction","end"],"sources":["/Users/stefanbekker/projects/fancy-planties/src/lib/db/index.ts"],"sourcesContent":["import 'server-only';\n\nimport { drizzle } from 'drizzle-orm/postgres-js';\nimport postgres from 'postgres';\nimport { eq, and, desc, asc, sql } from 'drizzle-orm';\nimport * as schema from './schema';\n\nconst connectionString = process.env.DATABASE_URL || 'postgresql://postgres:postgres@localhost:5433/fancy_planties';\n\n// Connection configuration with pooling\nconst client = postgres(connectionString, {\n  prepare: false,\n  max: 10, // Maximum number of connections in the pool\n  idle_timeout: 20, // Close idle connections after 20 seconds\n  connect_timeout: 10, // Connection timeout in seconds\n  onnotice: process.env.NODE_ENV === 'development' ? console.log : undefined,\n});\n\nexport const db = drizzle(client, { \n  schema,\n  logger: process.env.NODE_ENV === 'development'\n});\n\n// Database connection health check\nexport async function checkDatabaseConnection(): Promise<boolean> {\n  try {\n    await db.execute(sql`SELECT 1`);\n    return true;\n  } catch (error) {\n    console.error('Database connection failed:', error);\n    return false;\n  }\n}\n\n// Set user context for RLS (Row Level Security)\nexport async function setUserContext(userId: number) {\n  try {\n    await db.execute(sql`SELECT set_current_user_id(${userId})`);\n  } catch (error) {\n    console.error('Failed to set user context:', error);\n    throw new Error('Failed to set user context');\n  }\n}\n\n// Clear user context\nexport async function clearUserContext() {\n  try {\n    await db.execute(sql`SELECT set_config('app.current_user_id', '', true)`);\n  } catch (error) {\n    console.error('Failed to clear user context:', error);\n  }\n}\n\n// Database transaction wrapper with error handling\nexport async function withTransaction<T>(\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  callback: (tx: any) => Promise<T>\n): Promise<T> {\n  try {\n    return await db.transaction(callback);\n  } catch (error) {\n    console.error('Transaction failed:', error);\n    throw error;\n  }\n}\n\n// Graceful database shutdown\nexport async function closeDatabaseConnection() {\n  try {\n    await client.end();\n    console.log('Database connection closed gracefully');\n  } catch (error) {\n    console.error('Error closing database connection:', error);\n  }\n}\n\n// Export all schema and utilities\nexport * from './schema';\nexport { eq, and, desc, asc, sql };\nexport { MigrationUtils } from './migrations';"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}