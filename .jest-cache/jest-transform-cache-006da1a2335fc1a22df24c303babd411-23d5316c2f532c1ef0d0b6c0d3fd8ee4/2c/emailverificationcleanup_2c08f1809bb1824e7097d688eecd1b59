be655870c1f0d14b41897bf2fe93b7c2
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: Object.getOwnPropertyDescriptor(all, name).get
    });
}
_export(exports, {
    get EmailVerificationCleanupService () {
        return EmailVerificationCleanupService;
    },
    get emailVerificationCleanupService () {
        return emailVerificationCleanupService;
    }
});
require("server-only");
const _emailverificationcodeservice = require("./email-verification-code-service");
const _emailverificationratelimiter = require("./email-verification-rate-limiter");
const _emailservicemonitor = require("./email-service-monitor");
class EmailVerificationCleanupService {
    /**
   * Run cleanup of expired verification codes and rate limit data
   */ async runCleanup() {
        if (this.isRunning) {
            throw new Error('Cleanup is already running');
        }
        this.isRunning = true;
        const startTime = Date.now();
        try {
            console.log('[CLEANUP] Starting email verification cleanup...');
            // Clean up expired verification codes
            const expiredCodes = await _emailverificationcodeservice.emailVerificationCodeService.cleanupExpiredCodes();
            console.log(`[CLEANUP] Removed ${expiredCodes} expired verification codes`);
            // Clean up rate limit data
            const rateLimitStatsBefore = _emailverificationratelimiter.emailVerificationRateLimiter.getStats();
            _emailverificationratelimiter.emailVerificationRateLimiter.cleanup();
            const rateLimitStatsAfter = _emailverificationratelimiter.emailVerificationRateLimiter.getStats();
            const rateLimitDataCleaned = rateLimitStatsBefore.verificationAttempts - rateLimitStatsAfter.verificationAttempts + (rateLimitStatsBefore.resendRequests - rateLimitStatsAfter.resendRequests) + (rateLimitStatsBefore.emailVerificationActivity - rateLimitStatsAfter.emailVerificationActivity) + (rateLimitStatsBefore.resendCooldowns - rateLimitStatsAfter.resendCooldowns);
            console.log(`[CLEANUP] Cleaned up ${rateLimitDataCleaned} rate limit entries`);
            // Check email service health
            const emailHealth = _emailservicemonitor.emailServiceMonitor.getHealthStatus();
            const emailStats = _emailservicemonitor.emailServiceMonitor.getStats();
            if (emailHealth.status !== 'healthy') {
                console.warn(`[CLEANUP] Email service health: ${emailHealth.status}`, {
                    issues: emailHealth.issues,
                    recommendations: emailHealth.recommendations
                });
            }
            const stats = {
                expiredCodes,
                rateLimitData: rateLimitDataCleaned,
                timestamp: startTime,
                emailServiceHealth: {
                    status: emailHealth.status,
                    quotaUsage: _emailservicemonitor.emailServiceMonitor.getQuotaUsagePercentage(),
                    successRate: emailStats.successRate,
                    issues: emailHealth.issues
                }
            };
            // Store cleanup stats (keep last 24 entries)
            this.cleanupStats.push(stats);
            if (this.cleanupStats.length > 24) {
                this.cleanupStats.shift();
            }
            this.lastCleanup = startTime;
            const duration = Date.now() - startTime;
            console.log(`[CLEANUP] Email verification cleanup completed in ${duration}ms`);
            return stats;
        } catch (error) {
            console.error('[CLEANUP] Email verification cleanup failed:', error);
            throw error;
        } finally{
            this.isRunning = false;
        }
    }
    /**
   * Schedule automatic cleanup to run periodically
   */ scheduleCleanup(intervalMs = 60 * 60 * 1000) {
        console.log(`[CLEANUP] Scheduling email verification cleanup every ${intervalMs / 1000} seconds`);
        const runScheduledCleanup = async ()=>{
            try {
                await this.runCleanup();
            } catch (error) {
                console.error('[CLEANUP] Scheduled cleanup failed:', error);
            }
        };
        // Run initial cleanup after a short delay
        setTimeout(runScheduledCleanup, 5000); // 5 seconds
        // Then run periodically
        setInterval(runScheduledCleanup, intervalMs);
    }
    /**
   * Run startup cleanup to clean any leftover data
   */ async runStartupCleanup() {
        console.log('[CLEANUP] Running startup cleanup...');
        try {
            const stats = await this.runCleanup();
            console.log('[CLEANUP] Startup cleanup completed successfully');
            return stats;
        } catch (error) {
            console.error('[CLEANUP] Startup cleanup failed:', error);
            throw error;
        }
    }
    /**
   * Get cleanup statistics
   */ getCleanupStats() {
        const totalExpiredCodes = this.cleanupStats.reduce((sum, stat)=>sum + stat.expiredCodes, 0);
        const totalRateLimitData = this.cleanupStats.reduce((sum, stat)=>sum + stat.rateLimitData, 0);
        return {
            lastCleanup: this.lastCleanup,
            isRunning: this.isRunning,
            recentStats: [
                ...this.cleanupStats
            ],
            totalExpiredCodes,
            totalRateLimitData
        };
    }
    /**
   * Get current system status
   */ async getSystemStatus() {
        const codeStats = await _emailverificationcodeservice.emailVerificationCodeService.getCodeStats();
        const rateLimitStats = _emailverificationratelimiter.emailVerificationRateLimiter.getStats();
        const cleanupStats = this.getCleanupStats();
        const emailHealth = _emailservicemonitor.emailServiceMonitor.getHealthStatus();
        const emailStats = _emailservicemonitor.emailServiceMonitor.getStats();
        // Estimate next cleanup time (assuming hourly cleanup)
        const nextCleanupDue = cleanupStats.lastCleanup + 60 * 60 * 1000;
        return {
            verificationCodes: codeStats,
            rateLimits: rateLimitStats,
            emailService: {
                health: emailHealth.status,
                quotaUsage: _emailservicemonitor.emailServiceMonitor.getQuotaUsagePercentage(),
                successRate: emailStats.successRate,
                totalSent: emailStats.totalSent,
                totalFailed: emailStats.totalFailed,
                averageResponseTime: emailStats.averageResponseTime,
                issues: emailHealth.issues,
                recommendations: emailHealth.recommendations
            },
            cleanup: {
                lastCleanup: cleanupStats.lastCleanup,
                isRunning: cleanupStats.isRunning,
                nextCleanupDue
            }
        };
    }
    /**
   * Force cleanup if needed (for manual triggers)
   */ async forceCleanup() {
        if (this.isRunning) {
            throw new Error('Cleanup is already running. Please wait for it to complete.');
        }
        console.log('[CLEANUP] Force cleanup requested');
        return await this.runCleanup();
    }
    constructor(){
        this.isRunning = false;
        this.lastCleanup = 0;
        this.cleanupStats = [];
    }
}
const emailVerificationCleanupService = new EmailVerificationCleanupService();
// Auto-schedule cleanup when this module is imported
if (process.env.NODE_ENV === 'production') {
    // In production, start cleanup automatically
    emailVerificationCleanupService.scheduleCleanup();
} else {
    // In development, run less frequently to avoid noise
    emailVerificationCleanupService.scheduleCleanup(2 * 60 * 60 * 1000); // 2 hours
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9zdGVmYW5iZWtrZXIvcHJvamVjdHMvZmFuY3ktcGxhbnRpZXMvc3JjL2xpYi9zZXJ2aWNlcy9lbWFpbC12ZXJpZmljYXRpb24tY2xlYW51cC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJ3NlcnZlci1vbmx5JztcbmltcG9ydCB7IGVtYWlsVmVyaWZpY2F0aW9uQ29kZVNlcnZpY2UgfSBmcm9tICcuL2VtYWlsLXZlcmlmaWNhdGlvbi1jb2RlLXNlcnZpY2UnO1xuaW1wb3J0IHsgZW1haWxWZXJpZmljYXRpb25SYXRlTGltaXRlciB9IGZyb20gJy4vZW1haWwtdmVyaWZpY2F0aW9uLXJhdGUtbGltaXRlcic7XG5pbXBvcnQgeyBlbWFpbFNlcnZpY2VNb25pdG9yIH0gZnJvbSAnLi9lbWFpbC1zZXJ2aWNlLW1vbml0b3InO1xuXG5leHBvcnQgaW50ZXJmYWNlIENsZWFudXBTdGF0cyB7XG4gIGV4cGlyZWRDb2RlczogbnVtYmVyO1xuICByYXRlTGltaXREYXRhOiBudW1iZXI7XG4gIHRpbWVzdGFtcDogbnVtYmVyO1xuICBlbWFpbFNlcnZpY2VIZWFsdGg/OiB7XG4gICAgc3RhdHVzOiAnaGVhbHRoeScgfCAnd2FybmluZycgfCAnY3JpdGljYWwnO1xuICAgIHF1b3RhVXNhZ2U6IG51bWJlcjtcbiAgICBzdWNjZXNzUmF0ZTogbnVtYmVyO1xuICAgIGlzc3Vlczogc3RyaW5nW107XG4gIH07XG59XG5cbmV4cG9ydCBjbGFzcyBFbWFpbFZlcmlmaWNhdGlvbkNsZWFudXBTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBpc1J1bm5pbmcgPSBmYWxzZTtcbiAgcHJpdmF0ZSBsYXN0Q2xlYW51cCA9IDA7XG4gIHByaXZhdGUgY2xlYW51cFN0YXRzOiBDbGVhbnVwU3RhdHNbXSA9IFtdO1xuICBcbiAgLyoqXG4gICAqIFJ1biBjbGVhbnVwIG9mIGV4cGlyZWQgdmVyaWZpY2F0aW9uIGNvZGVzIGFuZCByYXRlIGxpbWl0IGRhdGFcbiAgICovXG4gIGFzeW5jIHJ1bkNsZWFudXAoKTogUHJvbWlzZTxDbGVhbnVwU3RhdHM+IHtcbiAgICBpZiAodGhpcy5pc1J1bm5pbmcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2xlYW51cCBpcyBhbHJlYWR5IHJ1bm5pbmcnKTtcbiAgICB9XG4gICAgXG4gICAgdGhpcy5pc1J1bm5pbmcgPSB0cnVlO1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKCdbQ0xFQU5VUF0gU3RhcnRpbmcgZW1haWwgdmVyaWZpY2F0aW9uIGNsZWFudXAuLi4nKTtcbiAgICAgIFxuICAgICAgLy8gQ2xlYW4gdXAgZXhwaXJlZCB2ZXJpZmljYXRpb24gY29kZXNcbiAgICAgIGNvbnN0IGV4cGlyZWRDb2RlcyA9IGF3YWl0IGVtYWlsVmVyaWZpY2F0aW9uQ29kZVNlcnZpY2UuY2xlYW51cEV4cGlyZWRDb2RlcygpO1xuICAgICAgY29uc29sZS5sb2coYFtDTEVBTlVQXSBSZW1vdmVkICR7ZXhwaXJlZENvZGVzfSBleHBpcmVkIHZlcmlmaWNhdGlvbiBjb2Rlc2ApO1xuICAgICAgXG4gICAgICAvLyBDbGVhbiB1cCByYXRlIGxpbWl0IGRhdGFcbiAgICAgIGNvbnN0IHJhdGVMaW1pdFN0YXRzQmVmb3JlID0gZW1haWxWZXJpZmljYXRpb25SYXRlTGltaXRlci5nZXRTdGF0cygpO1xuICAgICAgZW1haWxWZXJpZmljYXRpb25SYXRlTGltaXRlci5jbGVhbnVwKCk7XG4gICAgICBjb25zdCByYXRlTGltaXRTdGF0c0FmdGVyID0gZW1haWxWZXJpZmljYXRpb25SYXRlTGltaXRlci5nZXRTdGF0cygpO1xuICAgICAgXG4gICAgICBjb25zdCByYXRlTGltaXREYXRhQ2xlYW5lZCA9IFxuICAgICAgICAocmF0ZUxpbWl0U3RhdHNCZWZvcmUudmVyaWZpY2F0aW9uQXR0ZW1wdHMgLSByYXRlTGltaXRTdGF0c0FmdGVyLnZlcmlmaWNhdGlvbkF0dGVtcHRzKSArXG4gICAgICAgIChyYXRlTGltaXRTdGF0c0JlZm9yZS5yZXNlbmRSZXF1ZXN0cyAtIHJhdGVMaW1pdFN0YXRzQWZ0ZXIucmVzZW5kUmVxdWVzdHMpICtcbiAgICAgICAgKHJhdGVMaW1pdFN0YXRzQmVmb3JlLmVtYWlsVmVyaWZpY2F0aW9uQWN0aXZpdHkgLSByYXRlTGltaXRTdGF0c0FmdGVyLmVtYWlsVmVyaWZpY2F0aW9uQWN0aXZpdHkpICtcbiAgICAgICAgKHJhdGVMaW1pdFN0YXRzQmVmb3JlLnJlc2VuZENvb2xkb3ducyAtIHJhdGVMaW1pdFN0YXRzQWZ0ZXIucmVzZW5kQ29vbGRvd25zKTtcbiAgICAgIFxuICAgICAgY29uc29sZS5sb2coYFtDTEVBTlVQXSBDbGVhbmVkIHVwICR7cmF0ZUxpbWl0RGF0YUNsZWFuZWR9IHJhdGUgbGltaXQgZW50cmllc2ApO1xuICAgICAgXG4gICAgICAvLyBDaGVjayBlbWFpbCBzZXJ2aWNlIGhlYWx0aFxuICAgICAgY29uc3QgZW1haWxIZWFsdGggPSBlbWFpbFNlcnZpY2VNb25pdG9yLmdldEhlYWx0aFN0YXR1cygpO1xuICAgICAgY29uc3QgZW1haWxTdGF0cyA9IGVtYWlsU2VydmljZU1vbml0b3IuZ2V0U3RhdHMoKTtcbiAgICAgIFxuICAgICAgaWYgKGVtYWlsSGVhbHRoLnN0YXR1cyAhPT0gJ2hlYWx0aHknKSB7XG4gICAgICAgIGNvbnNvbGUud2FybihgW0NMRUFOVVBdIEVtYWlsIHNlcnZpY2UgaGVhbHRoOiAke2VtYWlsSGVhbHRoLnN0YXR1c31gLCB7XG4gICAgICAgICAgaXNzdWVzOiBlbWFpbEhlYWx0aC5pc3N1ZXMsXG4gICAgICAgICAgcmVjb21tZW5kYXRpb25zOiBlbWFpbEhlYWx0aC5yZWNvbW1lbmRhdGlvbnMsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgXG4gICAgICBjb25zdCBzdGF0czogQ2xlYW51cFN0YXRzID0ge1xuICAgICAgICBleHBpcmVkQ29kZXMsXG4gICAgICAgIHJhdGVMaW1pdERhdGE6IHJhdGVMaW1pdERhdGFDbGVhbmVkLFxuICAgICAgICB0aW1lc3RhbXA6IHN0YXJ0VGltZSxcbiAgICAgICAgZW1haWxTZXJ2aWNlSGVhbHRoOiB7XG4gICAgICAgICAgc3RhdHVzOiBlbWFpbEhlYWx0aC5zdGF0dXMsXG4gICAgICAgICAgcXVvdGFVc2FnZTogZW1haWxTZXJ2aWNlTW9uaXRvci5nZXRRdW90YVVzYWdlUGVyY2VudGFnZSgpLFxuICAgICAgICAgIHN1Y2Nlc3NSYXRlOiBlbWFpbFN0YXRzLnN1Y2Nlc3NSYXRlLFxuICAgICAgICAgIGlzc3VlczogZW1haWxIZWFsdGguaXNzdWVzLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICAgIFxuICAgICAgLy8gU3RvcmUgY2xlYW51cCBzdGF0cyAoa2VlcCBsYXN0IDI0IGVudHJpZXMpXG4gICAgICB0aGlzLmNsZWFudXBTdGF0cy5wdXNoKHN0YXRzKTtcbiAgICAgIGlmICh0aGlzLmNsZWFudXBTdGF0cy5sZW5ndGggPiAyNCkge1xuICAgICAgICB0aGlzLmNsZWFudXBTdGF0cy5zaGlmdCgpO1xuICAgICAgfVxuICAgICAgXG4gICAgICB0aGlzLmxhc3RDbGVhbnVwID0gc3RhcnRUaW1lO1xuICAgICAgXG4gICAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICBjb25zb2xlLmxvZyhgW0NMRUFOVVBdIEVtYWlsIHZlcmlmaWNhdGlvbiBjbGVhbnVwIGNvbXBsZXRlZCBpbiAke2R1cmF0aW9ufW1zYCk7XG4gICAgICBcbiAgICAgIHJldHVybiBzdGF0cztcbiAgICAgIFxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdbQ0xFQU5VUF0gRW1haWwgdmVyaWZpY2F0aW9uIGNsZWFudXAgZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlO1xuICAgIH1cbiAgfVxuICBcbiAgLyoqXG4gICAqIFNjaGVkdWxlIGF1dG9tYXRpYyBjbGVhbnVwIHRvIHJ1biBwZXJpb2RpY2FsbHlcbiAgICovXG4gIHNjaGVkdWxlQ2xlYW51cChpbnRlcnZhbE1zOiBudW1iZXIgPSA2MCAqIDYwICogMTAwMCk6IHZvaWQgeyAvLyBEZWZhdWx0OiAxIGhvdXJcbiAgICBjb25zb2xlLmxvZyhgW0NMRUFOVVBdIFNjaGVkdWxpbmcgZW1haWwgdmVyaWZpY2F0aW9uIGNsZWFudXAgZXZlcnkgJHtpbnRlcnZhbE1zIC8gMTAwMH0gc2Vjb25kc2ApO1xuICAgIFxuICAgIGNvbnN0IHJ1blNjaGVkdWxlZENsZWFudXAgPSBhc3luYyAoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnJ1bkNsZWFudXAoKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tDTEVBTlVQXSBTY2hlZHVsZWQgY2xlYW51cCBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgfVxuICAgIH07XG4gICAgXG4gICAgLy8gUnVuIGluaXRpYWwgY2xlYW51cCBhZnRlciBhIHNob3J0IGRlbGF5XG4gICAgc2V0VGltZW91dChydW5TY2hlZHVsZWRDbGVhbnVwLCA1MDAwKTsgLy8gNSBzZWNvbmRzXG4gICAgXG4gICAgLy8gVGhlbiBydW4gcGVyaW9kaWNhbGx5XG4gICAgc2V0SW50ZXJ2YWwocnVuU2NoZWR1bGVkQ2xlYW51cCwgaW50ZXJ2YWxNcyk7XG4gIH1cbiAgXG4gIC8qKlxuICAgKiBSdW4gc3RhcnR1cCBjbGVhbnVwIHRvIGNsZWFuIGFueSBsZWZ0b3ZlciBkYXRhXG4gICAqL1xuICBhc3luYyBydW5TdGFydHVwQ2xlYW51cCgpOiBQcm9taXNlPENsZWFudXBTdGF0cz4ge1xuICAgIGNvbnNvbGUubG9nKCdbQ0xFQU5VUF0gUnVubmluZyBzdGFydHVwIGNsZWFudXAuLi4nKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc3RhdHMgPSBhd2FpdCB0aGlzLnJ1bkNsZWFudXAoKTtcbiAgICAgIGNvbnNvbGUubG9nKCdbQ0xFQU5VUF0gU3RhcnR1cCBjbGVhbnVwIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHknKTtcbiAgICAgIHJldHVybiBzdGF0cztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignW0NMRUFOVVBdIFN0YXJ0dXAgY2xlYW51cCBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG4gIFxuICAvKipcbiAgICogR2V0IGNsZWFudXAgc3RhdGlzdGljc1xuICAgKi9cbiAgZ2V0Q2xlYW51cFN0YXRzKCk6IHtcbiAgICBsYXN0Q2xlYW51cDogbnVtYmVyO1xuICAgIGlzUnVubmluZzogYm9vbGVhbjtcbiAgICByZWNlbnRTdGF0czogQ2xlYW51cFN0YXRzW107XG4gICAgdG90YWxFeHBpcmVkQ29kZXM6IG51bWJlcjtcbiAgICB0b3RhbFJhdGVMaW1pdERhdGE6IG51bWJlcjtcbiAgfSB7XG4gICAgY29uc3QgdG90YWxFeHBpcmVkQ29kZXMgPSB0aGlzLmNsZWFudXBTdGF0cy5yZWR1Y2UoKHN1bSwgc3RhdCkgPT4gc3VtICsgc3RhdC5leHBpcmVkQ29kZXMsIDApO1xuICAgIGNvbnN0IHRvdGFsUmF0ZUxpbWl0RGF0YSA9IHRoaXMuY2xlYW51cFN0YXRzLnJlZHVjZSgoc3VtLCBzdGF0KSA9PiBzdW0gKyBzdGF0LnJhdGVMaW1pdERhdGEsIDApO1xuICAgIFxuICAgIHJldHVybiB7XG4gICAgICBsYXN0Q2xlYW51cDogdGhpcy5sYXN0Q2xlYW51cCxcbiAgICAgIGlzUnVubmluZzogdGhpcy5pc1J1bm5pbmcsXG4gICAgICByZWNlbnRTdGF0czogWy4uLnRoaXMuY2xlYW51cFN0YXRzXSxcbiAgICAgIHRvdGFsRXhwaXJlZENvZGVzLFxuICAgICAgdG90YWxSYXRlTGltaXREYXRhLFxuICAgIH07XG4gIH1cbiAgXG4gIC8qKlxuICAgKiBHZXQgY3VycmVudCBzeXN0ZW0gc3RhdHVzXG4gICAqL1xuICBhc3luYyBnZXRTeXN0ZW1TdGF0dXMoKTogUHJvbWlzZTx7XG4gICAgdmVyaWZpY2F0aW9uQ29kZXM6IHtcbiAgICAgIHRvdGFsQWN0aXZlOiBudW1iZXI7XG4gICAgICBleHBpcmVkQ291bnQ6IG51bWJlcjtcbiAgICAgIGhpZ2hBdHRlbXB0Q291bnQ6IG51bWJlcjtcbiAgICB9O1xuICAgIHJhdGVMaW1pdHM6IHtcbiAgICAgIHZlcmlmaWNhdGlvbkF0dGVtcHRzOiBudW1iZXI7XG4gICAgICByZXNlbmRSZXF1ZXN0czogbnVtYmVyO1xuICAgICAgZW1haWxWZXJpZmljYXRpb25BY3Rpdml0eTogbnVtYmVyO1xuICAgICAgcmVzZW5kQ29vbGRvd25zOiBudW1iZXI7XG4gICAgICBzZWN1cml0eUV2ZW50czogbnVtYmVyO1xuICAgIH07XG4gICAgZW1haWxTZXJ2aWNlOiB7XG4gICAgICBoZWFsdGg6ICdoZWFsdGh5JyB8ICd3YXJuaW5nJyB8ICdjcml0aWNhbCc7XG4gICAgICBxdW90YVVzYWdlOiBudW1iZXI7XG4gICAgICBzdWNjZXNzUmF0ZTogbnVtYmVyO1xuICAgICAgdG90YWxTZW50OiBudW1iZXI7XG4gICAgICB0b3RhbEZhaWxlZDogbnVtYmVyO1xuICAgICAgYXZlcmFnZVJlc3BvbnNlVGltZTogbnVtYmVyO1xuICAgICAgaXNzdWVzOiBzdHJpbmdbXTtcbiAgICAgIHJlY29tbWVuZGF0aW9uczogc3RyaW5nW107XG4gICAgfTtcbiAgICBjbGVhbnVwOiB7XG4gICAgICBsYXN0Q2xlYW51cDogbnVtYmVyO1xuICAgICAgaXNSdW5uaW5nOiBib29sZWFuO1xuICAgICAgbmV4dENsZWFudXBEdWU6IG51bWJlcjtcbiAgICB9O1xuICB9PiB7XG4gICAgY29uc3QgY29kZVN0YXRzID0gYXdhaXQgZW1haWxWZXJpZmljYXRpb25Db2RlU2VydmljZS5nZXRDb2RlU3RhdHMoKTtcbiAgICBjb25zdCByYXRlTGltaXRTdGF0cyA9IGVtYWlsVmVyaWZpY2F0aW9uUmF0ZUxpbWl0ZXIuZ2V0U3RhdHMoKTtcbiAgICBjb25zdCBjbGVhbnVwU3RhdHMgPSB0aGlzLmdldENsZWFudXBTdGF0cygpO1xuICAgIGNvbnN0IGVtYWlsSGVhbHRoID0gZW1haWxTZXJ2aWNlTW9uaXRvci5nZXRIZWFsdGhTdGF0dXMoKTtcbiAgICBjb25zdCBlbWFpbFN0YXRzID0gZW1haWxTZXJ2aWNlTW9uaXRvci5nZXRTdGF0cygpO1xuICAgIFxuICAgIC8vIEVzdGltYXRlIG5leHQgY2xlYW51cCB0aW1lIChhc3N1bWluZyBob3VybHkgY2xlYW51cClcbiAgICBjb25zdCBuZXh0Q2xlYW51cER1ZSA9IGNsZWFudXBTdGF0cy5sYXN0Q2xlYW51cCArICg2MCAqIDYwICogMTAwMCk7XG4gICAgXG4gICAgcmV0dXJuIHtcbiAgICAgIHZlcmlmaWNhdGlvbkNvZGVzOiBjb2RlU3RhdHMsXG4gICAgICByYXRlTGltaXRzOiByYXRlTGltaXRTdGF0cyxcbiAgICAgIGVtYWlsU2VydmljZToge1xuICAgICAgICBoZWFsdGg6IGVtYWlsSGVhbHRoLnN0YXR1cyxcbiAgICAgICAgcXVvdGFVc2FnZTogZW1haWxTZXJ2aWNlTW9uaXRvci5nZXRRdW90YVVzYWdlUGVyY2VudGFnZSgpLFxuICAgICAgICBzdWNjZXNzUmF0ZTogZW1haWxTdGF0cy5zdWNjZXNzUmF0ZSxcbiAgICAgICAgdG90YWxTZW50OiBlbWFpbFN0YXRzLnRvdGFsU2VudCxcbiAgICAgICAgdG90YWxGYWlsZWQ6IGVtYWlsU3RhdHMudG90YWxGYWlsZWQsXG4gICAgICAgIGF2ZXJhZ2VSZXNwb25zZVRpbWU6IGVtYWlsU3RhdHMuYXZlcmFnZVJlc3BvbnNlVGltZSxcbiAgICAgICAgaXNzdWVzOiBlbWFpbEhlYWx0aC5pc3N1ZXMsXG4gICAgICAgIHJlY29tbWVuZGF0aW9uczogZW1haWxIZWFsdGgucmVjb21tZW5kYXRpb25zLFxuICAgICAgfSxcbiAgICAgIGNsZWFudXA6IHtcbiAgICAgICAgbGFzdENsZWFudXA6IGNsZWFudXBTdGF0cy5sYXN0Q2xlYW51cCxcbiAgICAgICAgaXNSdW5uaW5nOiBjbGVhbnVwU3RhdHMuaXNSdW5uaW5nLFxuICAgICAgICBuZXh0Q2xlYW51cER1ZSxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuICBcbiAgLyoqXG4gICAqIEZvcmNlIGNsZWFudXAgaWYgbmVlZGVkIChmb3IgbWFudWFsIHRyaWdnZXJzKVxuICAgKi9cbiAgYXN5bmMgZm9yY2VDbGVhbnVwKCk6IFByb21pc2U8Q2xlYW51cFN0YXRzPiB7XG4gICAgaWYgKHRoaXMuaXNSdW5uaW5nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NsZWFudXAgaXMgYWxyZWFkeSBydW5uaW5nLiBQbGVhc2Ugd2FpdCBmb3IgaXQgdG8gY29tcGxldGUuJyk7XG4gICAgfVxuICAgIFxuICAgIGNvbnNvbGUubG9nKCdbQ0xFQU5VUF0gRm9yY2UgY2xlYW51cCByZXF1ZXN0ZWQnKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ydW5DbGVhbnVwKCk7XG4gIH1cbn1cblxuLy8gRXhwb3J0IHNpbmdsZXRvbiBpbnN0YW5jZVxuZXhwb3J0IGNvbnN0IGVtYWlsVmVyaWZpY2F0aW9uQ2xlYW51cFNlcnZpY2UgPSBuZXcgRW1haWxWZXJpZmljYXRpb25DbGVhbnVwU2VydmljZSgpO1xuXG4vLyBBdXRvLXNjaGVkdWxlIGNsZWFudXAgd2hlbiB0aGlzIG1vZHVsZSBpcyBpbXBvcnRlZFxuaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicpIHtcbiAgLy8gSW4gcHJvZHVjdGlvbiwgc3RhcnQgY2xlYW51cCBhdXRvbWF0aWNhbGx5XG4gIGVtYWlsVmVyaWZpY2F0aW9uQ2xlYW51cFNlcnZpY2Uuc2NoZWR1bGVDbGVhbnVwKCk7XG59IGVsc2Uge1xuICAvLyBJbiBkZXZlbG9wbWVudCwgcnVuIGxlc3MgZnJlcXVlbnRseSB0byBhdm9pZCBub2lzZVxuICBlbWFpbFZlcmlmaWNhdGlvbkNsZWFudXBTZXJ2aWNlLnNjaGVkdWxlQ2xlYW51cCgyICogNjAgKiA2MCAqIDEwMDApOyAvLyAyIGhvdXJzXG59Il0sIm5hbWVzIjpbIkVtYWlsVmVyaWZpY2F0aW9uQ2xlYW51cFNlcnZpY2UiLCJlbWFpbFZlcmlmaWNhdGlvbkNsZWFudXBTZXJ2aWNlIiwicnVuQ2xlYW51cCIsImlzUnVubmluZyIsIkVycm9yIiwic3RhcnRUaW1lIiwiRGF0ZSIsIm5vdyIsImNvbnNvbGUiLCJsb2ciLCJleHBpcmVkQ29kZXMiLCJlbWFpbFZlcmlmaWNhdGlvbkNvZGVTZXJ2aWNlIiwiY2xlYW51cEV4cGlyZWRDb2RlcyIsInJhdGVMaW1pdFN0YXRzQmVmb3JlIiwiZW1haWxWZXJpZmljYXRpb25SYXRlTGltaXRlciIsImdldFN0YXRzIiwiY2xlYW51cCIsInJhdGVMaW1pdFN0YXRzQWZ0ZXIiLCJyYXRlTGltaXREYXRhQ2xlYW5lZCIsInZlcmlmaWNhdGlvbkF0dGVtcHRzIiwicmVzZW5kUmVxdWVzdHMiLCJlbWFpbFZlcmlmaWNhdGlvbkFjdGl2aXR5IiwicmVzZW5kQ29vbGRvd25zIiwiZW1haWxIZWFsdGgiLCJlbWFpbFNlcnZpY2VNb25pdG9yIiwiZ2V0SGVhbHRoU3RhdHVzIiwiZW1haWxTdGF0cyIsInN0YXR1cyIsIndhcm4iLCJpc3N1ZXMiLCJyZWNvbW1lbmRhdGlvbnMiLCJzdGF0cyIsInJhdGVMaW1pdERhdGEiLCJ0aW1lc3RhbXAiLCJlbWFpbFNlcnZpY2VIZWFsdGgiLCJxdW90YVVzYWdlIiwiZ2V0UXVvdGFVc2FnZVBlcmNlbnRhZ2UiLCJzdWNjZXNzUmF0ZSIsImNsZWFudXBTdGF0cyIsInB1c2giLCJsZW5ndGgiLCJzaGlmdCIsImxhc3RDbGVhbnVwIiwiZHVyYXRpb24iLCJlcnJvciIsInNjaGVkdWxlQ2xlYW51cCIsImludGVydmFsTXMiLCJydW5TY2hlZHVsZWRDbGVhbnVwIiwic2V0VGltZW91dCIsInNldEludGVydmFsIiwicnVuU3RhcnR1cENsZWFudXAiLCJnZXRDbGVhbnVwU3RhdHMiLCJ0b3RhbEV4cGlyZWRDb2RlcyIsInJlZHVjZSIsInN1bSIsInN0YXQiLCJ0b3RhbFJhdGVMaW1pdERhdGEiLCJyZWNlbnRTdGF0cyIsImdldFN5c3RlbVN0YXR1cyIsImNvZGVTdGF0cyIsImdldENvZGVTdGF0cyIsInJhdGVMaW1pdFN0YXRzIiwibmV4dENsZWFudXBEdWUiLCJ2ZXJpZmljYXRpb25Db2RlcyIsInJhdGVMaW1pdHMiLCJlbWFpbFNlcnZpY2UiLCJoZWFsdGgiLCJ0b3RhbFNlbnQiLCJ0b3RhbEZhaWxlZCIsImF2ZXJhZ2VSZXNwb25zZVRpbWUiLCJmb3JjZUNsZWFudXAiLCJwcm9jZXNzIiwiZW52IiwiTk9ERV9FTlYiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O1FBaUJhQTtlQUFBQTs7UUF1TkFDO2VBQUFBOzs7UUF4T047OENBQ3NDOzhDQUNBO3FDQUNUO0FBYzdCLE1BQU1EO0lBS1g7O0dBRUMsR0FDRCxNQUFNRSxhQUFvQztRQUN4QyxJQUFJLElBQUksQ0FBQ0MsU0FBUyxFQUFFO1lBQ2xCLE1BQU0sSUFBSUMsTUFBTTtRQUNsQjtRQUVBLElBQUksQ0FBQ0QsU0FBUyxHQUFHO1FBQ2pCLE1BQU1FLFlBQVlDLEtBQUtDLEdBQUc7UUFFMUIsSUFBSTtZQUNGQyxRQUFRQyxHQUFHLENBQUM7WUFFWixzQ0FBc0M7WUFDdEMsTUFBTUMsZUFBZSxNQUFNQywwREFBNEIsQ0FBQ0MsbUJBQW1CO1lBQzNFSixRQUFRQyxHQUFHLENBQUMsQ0FBQyxrQkFBa0IsRUFBRUMsYUFBYSwyQkFBMkIsQ0FBQztZQUUxRSwyQkFBMkI7WUFDM0IsTUFBTUcsdUJBQXVCQywwREFBNEIsQ0FBQ0MsUUFBUTtZQUNsRUQsMERBQTRCLENBQUNFLE9BQU87WUFDcEMsTUFBTUMsc0JBQXNCSCwwREFBNEIsQ0FBQ0MsUUFBUTtZQUVqRSxNQUFNRyx1QkFDSixBQUFDTCxxQkFBcUJNLG9CQUFvQixHQUFHRixvQkFBb0JFLG9CQUFvQixHQUNwRk4sQ0FBQUEscUJBQXFCTyxjQUFjLEdBQUdILG9CQUFvQkcsY0FBYyxBQUFELElBQ3ZFUCxDQUFBQSxxQkFBcUJRLHlCQUF5QixHQUFHSixvQkFBb0JJLHlCQUF5QixBQUFELElBQzdGUixDQUFBQSxxQkFBcUJTLGVBQWUsR0FBR0wsb0JBQW9CSyxlQUFlLEFBQUQ7WUFFNUVkLFFBQVFDLEdBQUcsQ0FBQyxDQUFDLHFCQUFxQixFQUFFUyxxQkFBcUIsbUJBQW1CLENBQUM7WUFFN0UsNkJBQTZCO1lBQzdCLE1BQU1LLGNBQWNDLHdDQUFtQixDQUFDQyxlQUFlO1lBQ3ZELE1BQU1DLGFBQWFGLHdDQUFtQixDQUFDVCxRQUFRO1lBRS9DLElBQUlRLFlBQVlJLE1BQU0sS0FBSyxXQUFXO2dCQUNwQ25CLFFBQVFvQixJQUFJLENBQUMsQ0FBQyxnQ0FBZ0MsRUFBRUwsWUFBWUksTUFBTSxFQUFFLEVBQUU7b0JBQ3BFRSxRQUFRTixZQUFZTSxNQUFNO29CQUMxQkMsaUJBQWlCUCxZQUFZTyxlQUFlO2dCQUM5QztZQUNGO1lBRUEsTUFBTUMsUUFBc0I7Z0JBQzFCckI7Z0JBQ0FzQixlQUFlZDtnQkFDZmUsV0FBVzVCO2dCQUNYNkIsb0JBQW9CO29CQUNsQlAsUUFBUUosWUFBWUksTUFBTTtvQkFDMUJRLFlBQVlYLHdDQUFtQixDQUFDWSx1QkFBdUI7b0JBQ3ZEQyxhQUFhWCxXQUFXVyxXQUFXO29CQUNuQ1IsUUFBUU4sWUFBWU0sTUFBTTtnQkFDNUI7WUFDRjtZQUVBLDZDQUE2QztZQUM3QyxJQUFJLENBQUNTLFlBQVksQ0FBQ0MsSUFBSSxDQUFDUjtZQUN2QixJQUFJLElBQUksQ0FBQ08sWUFBWSxDQUFDRSxNQUFNLEdBQUcsSUFBSTtnQkFDakMsSUFBSSxDQUFDRixZQUFZLENBQUNHLEtBQUs7WUFDekI7WUFFQSxJQUFJLENBQUNDLFdBQVcsR0FBR3JDO1lBRW5CLE1BQU1zQyxXQUFXckMsS0FBS0MsR0FBRyxLQUFLRjtZQUM5QkcsUUFBUUMsR0FBRyxDQUFDLENBQUMsa0RBQWtELEVBQUVrQyxTQUFTLEVBQUUsQ0FBQztZQUU3RSxPQUFPWjtRQUVULEVBQUUsT0FBT2EsT0FBTztZQUNkcEMsUUFBUW9DLEtBQUssQ0FBQyxnREFBZ0RBO1lBQzlELE1BQU1BO1FBQ1IsU0FBVTtZQUNSLElBQUksQ0FBQ3pDLFNBQVMsR0FBRztRQUNuQjtJQUNGO0lBRUE7O0dBRUMsR0FDRDBDLGdCQUFnQkMsYUFBcUIsS0FBSyxLQUFLLElBQUksRUFBUTtRQUN6RHRDLFFBQVFDLEdBQUcsQ0FBQyxDQUFDLHNEQUFzRCxFQUFFcUMsYUFBYSxLQUFLLFFBQVEsQ0FBQztRQUVoRyxNQUFNQyxzQkFBc0I7WUFDMUIsSUFBSTtnQkFDRixNQUFNLElBQUksQ0FBQzdDLFVBQVU7WUFDdkIsRUFBRSxPQUFPMEMsT0FBTztnQkFDZHBDLFFBQVFvQyxLQUFLLENBQUMsdUNBQXVDQTtZQUN2RDtRQUNGO1FBRUEsMENBQTBDO1FBQzFDSSxXQUFXRCxxQkFBcUIsT0FBTyxZQUFZO1FBRW5ELHdCQUF3QjtRQUN4QkUsWUFBWUYscUJBQXFCRDtJQUNuQztJQUVBOztHQUVDLEdBQ0QsTUFBTUksb0JBQTJDO1FBQy9DMUMsUUFBUUMsR0FBRyxDQUFDO1FBRVosSUFBSTtZQUNGLE1BQU1zQixRQUFRLE1BQU0sSUFBSSxDQUFDN0IsVUFBVTtZQUNuQ00sUUFBUUMsR0FBRyxDQUFDO1lBQ1osT0FBT3NCO1FBQ1QsRUFBRSxPQUFPYSxPQUFPO1lBQ2RwQyxRQUFRb0MsS0FBSyxDQUFDLHFDQUFxQ0E7WUFDbkQsTUFBTUE7UUFDUjtJQUNGO0lBRUE7O0dBRUMsR0FDRE8sa0JBTUU7UUFDQSxNQUFNQyxvQkFBb0IsSUFBSSxDQUFDZCxZQUFZLENBQUNlLE1BQU0sQ0FBQyxDQUFDQyxLQUFLQyxPQUFTRCxNQUFNQyxLQUFLN0MsWUFBWSxFQUFFO1FBQzNGLE1BQU04QyxxQkFBcUIsSUFBSSxDQUFDbEIsWUFBWSxDQUFDZSxNQUFNLENBQUMsQ0FBQ0MsS0FBS0MsT0FBU0QsTUFBTUMsS0FBS3ZCLGFBQWEsRUFBRTtRQUU3RixPQUFPO1lBQ0xVLGFBQWEsSUFBSSxDQUFDQSxXQUFXO1lBQzdCdkMsV0FBVyxJQUFJLENBQUNBLFNBQVM7WUFDekJzRCxhQUFhO21CQUFJLElBQUksQ0FBQ25CLFlBQVk7YUFBQztZQUNuQ2M7WUFDQUk7UUFDRjtJQUNGO0lBRUE7O0dBRUMsR0FDRCxNQUFNRSxrQkE0Qkg7UUFDRCxNQUFNQyxZQUFZLE1BQU1oRCwwREFBNEIsQ0FBQ2lELFlBQVk7UUFDakUsTUFBTUMsaUJBQWlCL0MsMERBQTRCLENBQUNDLFFBQVE7UUFDNUQsTUFBTXVCLGVBQWUsSUFBSSxDQUFDYSxlQUFlO1FBQ3pDLE1BQU01QixjQUFjQyx3Q0FBbUIsQ0FBQ0MsZUFBZTtRQUN2RCxNQUFNQyxhQUFhRix3Q0FBbUIsQ0FBQ1QsUUFBUTtRQUUvQyx1REFBdUQ7UUFDdkQsTUFBTStDLGlCQUFpQnhCLGFBQWFJLFdBQVcsR0FBSSxLQUFLLEtBQUs7UUFFN0QsT0FBTztZQUNMcUIsbUJBQW1CSjtZQUNuQkssWUFBWUg7WUFDWkksY0FBYztnQkFDWkMsUUFBUTNDLFlBQVlJLE1BQU07Z0JBQzFCUSxZQUFZWCx3Q0FBbUIsQ0FBQ1ksdUJBQXVCO2dCQUN2REMsYUFBYVgsV0FBV1csV0FBVztnQkFDbkM4QixXQUFXekMsV0FBV3lDLFNBQVM7Z0JBQy9CQyxhQUFhMUMsV0FBVzBDLFdBQVc7Z0JBQ25DQyxxQkFBcUIzQyxXQUFXMkMsbUJBQW1CO2dCQUNuRHhDLFFBQVFOLFlBQVlNLE1BQU07Z0JBQzFCQyxpQkFBaUJQLFlBQVlPLGVBQWU7WUFDOUM7WUFDQWQsU0FBUztnQkFDUDBCLGFBQWFKLGFBQWFJLFdBQVc7Z0JBQ3JDdkMsV0FBV21DLGFBQWFuQyxTQUFTO2dCQUNqQzJEO1lBQ0Y7UUFDRjtJQUNGO0lBRUE7O0dBRUMsR0FDRCxNQUFNUSxlQUFzQztRQUMxQyxJQUFJLElBQUksQ0FBQ25FLFNBQVMsRUFBRTtZQUNsQixNQUFNLElBQUlDLE1BQU07UUFDbEI7UUFFQUksUUFBUUMsR0FBRyxDQUFDO1FBQ1osT0FBTyxNQUFNLElBQUksQ0FBQ1AsVUFBVTtJQUM5Qjs7YUFsTlFDLFlBQVk7YUFDWnVDLGNBQWM7YUFDZEosZUFBK0IsRUFBRTs7QUFpTjNDO0FBR08sTUFBTXJDLGtDQUFrQyxJQUFJRDtBQUVuRCxxREFBcUQ7QUFDckQsSUFBSXVFLFFBQVFDLEdBQUcsQ0FBQ0MsUUFBUSxLQUFLLGNBQWM7SUFDekMsNkNBQTZDO0lBQzdDeEUsZ0NBQWdDNEMsZUFBZTtBQUNqRCxPQUFPO0lBQ0wscURBQXFEO0lBQ3JENUMsZ0NBQWdDNEMsZUFBZSxDQUFDLElBQUksS0FBSyxLQUFLLE9BQU8sVUFBVTtBQUNqRiJ9