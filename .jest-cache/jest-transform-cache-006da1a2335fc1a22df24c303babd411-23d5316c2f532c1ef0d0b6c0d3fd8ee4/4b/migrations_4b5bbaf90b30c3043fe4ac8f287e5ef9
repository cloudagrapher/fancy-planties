a4b2bbcbdc21ce844c43db8f3f614a59
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "MigrationUtils", {
    enumerable: true,
    get: function() {
        return MigrationUtils;
    }
});
require("server-only");
const _index = require("./index");
const _drizzleorm = require("drizzle-orm");
const _fs = /*#__PURE__*/ _interop_require_default(require("fs"));
const _path = /*#__PURE__*/ _interop_require_default(require("path"));
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
class MigrationUtils {
    // Run all pending migrations
    static async runMigrations() {
        try {
            console.log('Starting database migrations...');
            // Create migrations table if it doesn't exist
            await _index.db.execute((0, _drizzleorm.sql)`
        CREATE TABLE IF NOT EXISTS __drizzle_migrations (
          id SERIAL PRIMARY KEY,
          hash text NOT NULL,
          created_at bigint
        );
      `);
            console.log('Migrations completed successfully');
        } catch (error) {
            console.error('Migration failed:', error);
            throw new Error('Failed to run migrations');
        }
    }
    // Apply RLS policies
    static async applyRLSPolicies() {
        try {
            console.log('Applying Row-Level Security policies...');
            const rlsPath = _path.default.join(process.cwd(), 'drizzle', 'rls-policies.sql');
            if (_fs.default.existsSync(rlsPath)) {
                const rlsSQL = _fs.default.readFileSync(rlsPath, 'utf8');
                // Split by semicolon and filter out comments
                const statements = rlsSQL.split(';').map((stmt)=>stmt.trim()).filter((stmt)=>stmt.length > 0 && !stmt.startsWith('--') && !stmt.match(/^\/\*.*\*\/$/));
                for (const statement of statements){
                    const cleanStatement = statement.trim();
                    if (cleanStatement && !cleanStatement.startsWith('--')) {
                        try {
                            await _index.db.execute(_drizzleorm.sql.raw(cleanStatement));
                        } catch (error) {
                            // Log but don't fail on policy conflicts (they might already exist)
                            if (error instanceof Error && error.message.includes('already exists')) {
                                console.log(`Policy already exists, skipping: ${cleanStatement.substring(0, 50)}...`);
                            } else {
                                console.error(`Failed to execute statement: ${cleanStatement.substring(0, 50)}...`);
                                throw error;
                            }
                        }
                    }
                }
                console.log('RLS policies applied successfully');
            } else {
                console.warn('RLS policies file not found, skipping...');
            }
        } catch (error) {
            console.error('Failed to apply RLS policies:', error);
            throw new Error('Failed to apply RLS policies');
        }
    }
    // Rollback last migration (basic implementation)
    static async rollbackLastMigration() {
        try {
            console.log('Rolling back last migration...');
            // This is a basic implementation - in production you'd want more sophisticated rollback logic
            console.warn('Rollback functionality requires manual intervention for safety');
            console.log('Please review the migration files and manually rollback if needed');
        } catch (error) {
            console.error('Rollback failed:', error);
            throw new Error('Failed to rollback migration');
        }
    }
    // Check migration status
    static async getMigrationStatus() {
        try {
            // Get applied migrations count
            const [result] = await _index.db.execute((0, _drizzleorm.sql)`
        SELECT COUNT(*) as count FROM __drizzle_migrations
      `);
            const appliedMigrations = result?.count || 0;
            // Get pending migrations by checking the drizzle folder
            const migrationsPath = _path.default.join(process.cwd(), 'drizzle');
            const pendingMigrations = [];
            if (_fs.default.existsSync(migrationsPath)) {
                const files = _fs.default.readdirSync(migrationsPath);
                const sqlFiles = files.filter((file)=>file.endsWith('.sql') && !file.includes('rls-policies'));
                pendingMigrations.push(...sqlFiles);
            }
            return {
                appliedMigrations: Number(appliedMigrations),
                pendingMigrations
            };
        } catch (error) {
            console.error('Failed to get migration status:', error);
            throw new Error('Failed to get migration status');
        }
    }
    // Seed initial data (for development)
    static async seedInitialData() {
        try {
            console.log('Seeding initial data...');
            // Check if we already have data
            const [userCount] = await _index.db.execute((0, _drizzleorm.sql)`SELECT COUNT(*) as count FROM users`);
            if (Number(userCount?.count) > 0) {
                console.log('Database already has data, skipping seed');
                return;
            }
            // Add some common plant taxonomy data
            const commonPlants = [
                {
                    family: 'Araceae',
                    genus: 'Monstera',
                    species: 'deliciosa',
                    commonName: 'Swiss Cheese Plant',
                    careInstructions: 'Bright indirect light, water when top inch of soil is dry',
                    isVerified: true
                },
                {
                    family: 'Araceae',
                    genus: 'Pothos',
                    species: 'aureus',
                    commonName: 'Golden Pothos',
                    careInstructions: 'Low to bright indirect light, water when soil is dry',
                    isVerified: true
                },
                {
                    family: 'Asparagaceae',
                    genus: 'Sansevieria',
                    species: 'trifasciata',
                    commonName: 'Snake Plant',
                    careInstructions: 'Low light tolerant, water sparingly',
                    isVerified: true
                },
                {
                    family: 'Araceae',
                    genus: 'Philodendron',
                    species: 'hederaceum',
                    commonName: 'Heartleaf Philodendron',
                    careInstructions: 'Bright indirect light, keep soil lightly moist',
                    isVerified: true
                }
            ];
            for (const plant of commonPlants){
                await _index.db.execute((0, _drizzleorm.sql)`
          INSERT INTO plants (family, genus, species, cultivar, common_name, care_instructions, is_verified)
          VALUES (${plant.family}, ${plant.genus}, ${plant.species}, NULL, ${plant.commonName}, ${plant.careInstructions}, ${plant.isVerified})
          ON CONFLICT (family, genus, species, cultivar) DO NOTHING
        `);
            }
            console.log('Initial data seeded successfully');
        } catch (error) {
            console.error('Failed to seed initial data:', error);
            throw new Error('Failed to seed initial data');
        }
    }
    // Database health check
    static async healthCheck() {
        try {
            // Check connection
            const connected = await _index.db.execute((0, _drizzleorm.sql)`SELECT 1`).then(()=>true).catch(()=>false);
            // Check if migrations table exists
            const [migrationTable] = await _index.db.execute((0, _drizzleorm.sql)`
        SELECT EXISTS (
          SELECT FROM information_schema.tables 
          WHERE table_name = '__drizzle_migrations'
        ) as exists
      `);
            const migrationsApplied = Boolean(migrationTable?.exists) || false;
            // Check if main tables exist
            const [tablesCheck] = await _index.db.execute((0, _drizzleorm.sql)`
        SELECT 
          (SELECT COUNT(*) FROM information_schema.tables WHERE table_name IN ('users', 'plants', 'plant_instances', 'propagations', 'sessions')) as table_count
      `);
            const tablesExist = Number(tablesCheck?.table_count) === 5;
            // Check if RLS is enabled on user tables
            const [rlsCheck] = await _index.db.execute((0, _drizzleorm.sql)`
        SELECT COUNT(*) as rls_count
        FROM pg_class c
        JOIN pg_namespace n ON n.oid = c.relnamespace
        WHERE c.relrowsecurity = true 
        AND n.nspname = 'public'
        AND c.relname IN ('plant_instances', 'propagations', 'sessions')
      `);
            const rlsEnabled = Number(rlsCheck?.rls_count) === 3;
            return {
                connected,
                migrationsApplied,
                rlsEnabled,
                tablesExist
            };
        } catch (error) {
            console.error('Health check failed:', error);
            return {
                connected: false,
                migrationsApplied: false,
                rlsEnabled: false,
                tablesExist: false
            };
        }
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9zdGVmYW5iZWtrZXIvcHJvamVjdHMvZmFuY3ktcGxhbnRpZXMvc3JjL2xpYi9kYi9taWdyYXRpb25zLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnc2VydmVyLW9ubHknO1xuXG5pbXBvcnQgeyBkYiB9IGZyb20gJy4vaW5kZXgnO1xuaW1wb3J0IHsgc3FsIH0gZnJvbSAnZHJpenpsZS1vcm0nO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG4vLyBNaWdyYXRpb24gdXRpbGl0aWVzXG5leHBvcnQgY2xhc3MgTWlncmF0aW9uVXRpbHMge1xuICAvLyBSdW4gYWxsIHBlbmRpbmcgbWlncmF0aW9uc1xuICBzdGF0aWMgYXN5bmMgcnVuTWlncmF0aW9ucygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc29sZS5sb2coJ1N0YXJ0aW5nIGRhdGFiYXNlIG1pZ3JhdGlvbnMuLi4nKTtcbiAgICAgIFxuICAgICAgLy8gQ3JlYXRlIG1pZ3JhdGlvbnMgdGFibGUgaWYgaXQgZG9lc24ndCBleGlzdFxuICAgICAgYXdhaXQgZGIuZXhlY3V0ZShzcWxgXG4gICAgICAgIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIF9fZHJpenpsZV9taWdyYXRpb25zIChcbiAgICAgICAgICBpZCBTRVJJQUwgUFJJTUFSWSBLRVksXG4gICAgICAgICAgaGFzaCB0ZXh0IE5PVCBOVUxMLFxuICAgICAgICAgIGNyZWF0ZWRfYXQgYmlnaW50XG4gICAgICAgICk7XG4gICAgICBgKTtcblxuICAgICAgY29uc29sZS5sb2coJ01pZ3JhdGlvbnMgY29tcGxldGVkIHN1Y2Nlc3NmdWxseScpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdNaWdyYXRpb24gZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJ1biBtaWdyYXRpb25zJyk7XG4gICAgfVxuICB9XG5cbiAgLy8gQXBwbHkgUkxTIHBvbGljaWVzXG4gIHN0YXRpYyBhc3luYyBhcHBseVJMU1BvbGljaWVzKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zb2xlLmxvZygnQXBwbHlpbmcgUm93LUxldmVsIFNlY3VyaXR5IHBvbGljaWVzLi4uJyk7XG4gICAgICBcbiAgICAgIGNvbnN0IHJsc1BhdGggPSBwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgJ2RyaXp6bGUnLCAncmxzLXBvbGljaWVzLnNxbCcpO1xuICAgICAgXG4gICAgICBpZiAoZnMuZXhpc3RzU3luYyhybHNQYXRoKSkge1xuICAgICAgICBjb25zdCBybHNTUUwgPSBmcy5yZWFkRmlsZVN5bmMocmxzUGF0aCwgJ3V0ZjgnKTtcbiAgICAgICAgXG4gICAgICAgIC8vIFNwbGl0IGJ5IHNlbWljb2xvbiBhbmQgZmlsdGVyIG91dCBjb21tZW50c1xuICAgICAgICBjb25zdCBzdGF0ZW1lbnRzID0gcmxzU1FMXG4gICAgICAgICAgLnNwbGl0KCc7JylcbiAgICAgICAgICAubWFwKHN0bXQgPT4gc3RtdC50cmltKCkpXG4gICAgICAgICAgLmZpbHRlcihzdG10ID0+IFxuICAgICAgICAgICAgc3RtdC5sZW5ndGggPiAwICYmIFxuICAgICAgICAgICAgIXN0bXQuc3RhcnRzV2l0aCgnLS0nKSAmJiBcbiAgICAgICAgICAgICFzdG10Lm1hdGNoKC9eXFwvXFwqLipcXCpcXC8kLylcbiAgICAgICAgICApO1xuXG4gICAgICAgIGZvciAoY29uc3Qgc3RhdGVtZW50IG9mIHN0YXRlbWVudHMpIHtcbiAgICAgICAgICBjb25zdCBjbGVhblN0YXRlbWVudCA9IHN0YXRlbWVudC50cmltKCk7XG4gICAgICAgICAgaWYgKGNsZWFuU3RhdGVtZW50ICYmICFjbGVhblN0YXRlbWVudC5zdGFydHNXaXRoKCctLScpKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICBhd2FpdCBkYi5leGVjdXRlKHNxbC5yYXcoY2xlYW5TdGF0ZW1lbnQpKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgIC8vIExvZyBidXQgZG9uJ3QgZmFpbCBvbiBwb2xpY3kgY29uZmxpY3RzICh0aGV5IG1pZ2h0IGFscmVhZHkgZXhpc3QpXG4gICAgICAgICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yICYmIGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ2FscmVhZHkgZXhpc3RzJykpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgUG9saWN5IGFscmVhZHkgZXhpc3RzLCBza2lwcGluZzogJHtjbGVhblN0YXRlbWVudC5zdWJzdHJpbmcoMCwgNTApfS4uLmApO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBleGVjdXRlIHN0YXRlbWVudDogJHtjbGVhblN0YXRlbWVudC5zdWJzdHJpbmcoMCwgNTApfS4uLmApO1xuICAgICAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBjb25zb2xlLmxvZygnUkxTIHBvbGljaWVzIGFwcGxpZWQgc3VjY2Vzc2Z1bGx5Jyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLndhcm4oJ1JMUyBwb2xpY2llcyBmaWxlIG5vdCBmb3VuZCwgc2tpcHBpbmcuLi4nKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGFwcGx5IFJMUyBwb2xpY2llczonLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBhcHBseSBSTFMgcG9saWNpZXMnKTtcbiAgICB9XG4gIH1cblxuICAvLyBSb2xsYmFjayBsYXN0IG1pZ3JhdGlvbiAoYmFzaWMgaW1wbGVtZW50YXRpb24pXG4gIHN0YXRpYyBhc3luYyByb2xsYmFja0xhc3RNaWdyYXRpb24oKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKCdSb2xsaW5nIGJhY2sgbGFzdCBtaWdyYXRpb24uLi4nKTtcbiAgICAgIFxuICAgICAgLy8gVGhpcyBpcyBhIGJhc2ljIGltcGxlbWVudGF0aW9uIC0gaW4gcHJvZHVjdGlvbiB5b3UnZCB3YW50IG1vcmUgc29waGlzdGljYXRlZCByb2xsYmFjayBsb2dpY1xuICAgICAgY29uc29sZS53YXJuKCdSb2xsYmFjayBmdW5jdGlvbmFsaXR5IHJlcXVpcmVzIG1hbnVhbCBpbnRlcnZlbnRpb24gZm9yIHNhZmV0eScpO1xuICAgICAgY29uc29sZS5sb2coJ1BsZWFzZSByZXZpZXcgdGhlIG1pZ3JhdGlvbiBmaWxlcyBhbmQgbWFudWFsbHkgcm9sbGJhY2sgaWYgbmVlZGVkJyk7XG4gICAgICBcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignUm9sbGJhY2sgZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJvbGxiYWNrIG1pZ3JhdGlvbicpO1xuICAgIH1cbiAgfVxuXG4gIC8vIENoZWNrIG1pZ3JhdGlvbiBzdGF0dXNcbiAgc3RhdGljIGFzeW5jIGdldE1pZ3JhdGlvblN0YXR1cygpOiBQcm9taXNlPHtcbiAgICBhcHBsaWVkTWlncmF0aW9uczogbnVtYmVyO1xuICAgIHBlbmRpbmdNaWdyYXRpb25zOiBzdHJpbmdbXTtcbiAgfT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBHZXQgYXBwbGllZCBtaWdyYXRpb25zIGNvdW50XG4gICAgICBjb25zdCBbcmVzdWx0XSA9IGF3YWl0IGRiLmV4ZWN1dGUoc3FsYFxuICAgICAgICBTRUxFQ1QgQ09VTlQoKikgYXMgY291bnQgRlJPTSBfX2RyaXp6bGVfbWlncmF0aW9uc1xuICAgICAgYCk7XG4gICAgICBcbiAgICAgIGNvbnN0IGFwcGxpZWRNaWdyYXRpb25zID0gcmVzdWx0Py5jb3VudCB8fCAwO1xuICAgICAgXG4gICAgICAvLyBHZXQgcGVuZGluZyBtaWdyYXRpb25zIGJ5IGNoZWNraW5nIHRoZSBkcml6emxlIGZvbGRlclxuICAgICAgY29uc3QgbWlncmF0aW9uc1BhdGggPSBwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgJ2RyaXp6bGUnKTtcbiAgICAgIGNvbnN0IHBlbmRpbmdNaWdyYXRpb25zOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgXG4gICAgICBpZiAoZnMuZXhpc3RzU3luYyhtaWdyYXRpb25zUGF0aCkpIHtcbiAgICAgICAgY29uc3QgZmlsZXMgPSBmcy5yZWFkZGlyU3luYyhtaWdyYXRpb25zUGF0aCk7XG4gICAgICAgIGNvbnN0IHNxbEZpbGVzID0gZmlsZXMuZmlsdGVyKGZpbGUgPT4gZmlsZS5lbmRzV2l0aCgnLnNxbCcpICYmICFmaWxlLmluY2x1ZGVzKCdybHMtcG9saWNpZXMnKSk7XG4gICAgICAgIHBlbmRpbmdNaWdyYXRpb25zLnB1c2goLi4uc3FsRmlsZXMpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBhcHBsaWVkTWlncmF0aW9uczogTnVtYmVyKGFwcGxpZWRNaWdyYXRpb25zKSxcbiAgICAgICAgcGVuZGluZ01pZ3JhdGlvbnNcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBnZXQgbWlncmF0aW9uIHN0YXR1czonLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBnZXQgbWlncmF0aW9uIHN0YXR1cycpO1xuICAgIH1cbiAgfVxuXG4gIC8vIFNlZWQgaW5pdGlhbCBkYXRhIChmb3IgZGV2ZWxvcG1lbnQpXG4gIHN0YXRpYyBhc3luYyBzZWVkSW5pdGlhbERhdGEoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKCdTZWVkaW5nIGluaXRpYWwgZGF0YS4uLicpO1xuICAgICAgXG4gICAgICAvLyBDaGVjayBpZiB3ZSBhbHJlYWR5IGhhdmUgZGF0YVxuICAgICAgY29uc3QgW3VzZXJDb3VudF0gPSBhd2FpdCBkYi5leGVjdXRlKHNxbGBTRUxFQ1QgQ09VTlQoKikgYXMgY291bnQgRlJPTSB1c2Vyc2ApO1xuICAgICAgXG4gICAgICBpZiAoTnVtYmVyKHVzZXJDb3VudD8uY291bnQpID4gMCkge1xuICAgICAgICBjb25zb2xlLmxvZygnRGF0YWJhc2UgYWxyZWFkeSBoYXMgZGF0YSwgc2tpcHBpbmcgc2VlZCcpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIEFkZCBzb21lIGNvbW1vbiBwbGFudCB0YXhvbm9teSBkYXRhXG4gICAgICBjb25zdCBjb21tb25QbGFudHMgPSBbXG4gICAgICAgIHtcbiAgICAgICAgICBmYW1pbHk6ICdBcmFjZWFlJyxcbiAgICAgICAgICBnZW51czogJ01vbnN0ZXJhJyxcbiAgICAgICAgICBzcGVjaWVzOiAnZGVsaWNpb3NhJyxcbiAgICAgICAgICBjb21tb25OYW1lOiAnU3dpc3MgQ2hlZXNlIFBsYW50JyxcbiAgICAgICAgICBjYXJlSW5zdHJ1Y3Rpb25zOiAnQnJpZ2h0IGluZGlyZWN0IGxpZ2h0LCB3YXRlciB3aGVuIHRvcCBpbmNoIG9mIHNvaWwgaXMgZHJ5JyxcbiAgICAgICAgICBpc1ZlcmlmaWVkOiB0cnVlXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBmYW1pbHk6ICdBcmFjZWFlJyxcbiAgICAgICAgICBnZW51czogJ1BvdGhvcycsXG4gICAgICAgICAgc3BlY2llczogJ2F1cmV1cycsXG4gICAgICAgICAgY29tbW9uTmFtZTogJ0dvbGRlbiBQb3Rob3MnLFxuICAgICAgICAgIGNhcmVJbnN0cnVjdGlvbnM6ICdMb3cgdG8gYnJpZ2h0IGluZGlyZWN0IGxpZ2h0LCB3YXRlciB3aGVuIHNvaWwgaXMgZHJ5JyxcbiAgICAgICAgICBpc1ZlcmlmaWVkOiB0cnVlXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBmYW1pbHk6ICdBc3BhcmFnYWNlYWUnLFxuICAgICAgICAgIGdlbnVzOiAnU2Fuc2V2aWVyaWEnLFxuICAgICAgICAgIHNwZWNpZXM6ICd0cmlmYXNjaWF0YScsXG4gICAgICAgICAgY29tbW9uTmFtZTogJ1NuYWtlIFBsYW50JyxcbiAgICAgICAgICBjYXJlSW5zdHJ1Y3Rpb25zOiAnTG93IGxpZ2h0IHRvbGVyYW50LCB3YXRlciBzcGFyaW5nbHknLFxuICAgICAgICAgIGlzVmVyaWZpZWQ6IHRydWVcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGZhbWlseTogJ0FyYWNlYWUnLFxuICAgICAgICAgIGdlbnVzOiAnUGhpbG9kZW5kcm9uJyxcbiAgICAgICAgICBzcGVjaWVzOiAnaGVkZXJhY2V1bScsXG4gICAgICAgICAgY29tbW9uTmFtZTogJ0hlYXJ0bGVhZiBQaGlsb2RlbmRyb24nLFxuICAgICAgICAgIGNhcmVJbnN0cnVjdGlvbnM6ICdCcmlnaHQgaW5kaXJlY3QgbGlnaHQsIGtlZXAgc29pbCBsaWdodGx5IG1vaXN0JyxcbiAgICAgICAgICBpc1ZlcmlmaWVkOiB0cnVlXG4gICAgICAgIH1cbiAgICAgIF07XG5cbiAgICAgIGZvciAoY29uc3QgcGxhbnQgb2YgY29tbW9uUGxhbnRzKSB7XG4gICAgICAgIGF3YWl0IGRiLmV4ZWN1dGUoc3FsYFxuICAgICAgICAgIElOU0VSVCBJTlRPIHBsYW50cyAoZmFtaWx5LCBnZW51cywgc3BlY2llcywgY3VsdGl2YXIsIGNvbW1vbl9uYW1lLCBjYXJlX2luc3RydWN0aW9ucywgaXNfdmVyaWZpZWQpXG4gICAgICAgICAgVkFMVUVTICgke3BsYW50LmZhbWlseX0sICR7cGxhbnQuZ2VudXN9LCAke3BsYW50LnNwZWNpZXN9LCBOVUxMLCAke3BsYW50LmNvbW1vbk5hbWV9LCAke3BsYW50LmNhcmVJbnN0cnVjdGlvbnN9LCAke3BsYW50LmlzVmVyaWZpZWR9KVxuICAgICAgICAgIE9OIENPTkZMSUNUIChmYW1pbHksIGdlbnVzLCBzcGVjaWVzLCBjdWx0aXZhcikgRE8gTk9USElOR1xuICAgICAgICBgKTtcbiAgICAgIH1cblxuICAgICAgY29uc29sZS5sb2coJ0luaXRpYWwgZGF0YSBzZWVkZWQgc3VjY2Vzc2Z1bGx5Jyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBzZWVkIGluaXRpYWwgZGF0YTonLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBzZWVkIGluaXRpYWwgZGF0YScpO1xuICAgIH1cbiAgfVxuXG4gIC8vIERhdGFiYXNlIGhlYWx0aCBjaGVja1xuICBzdGF0aWMgYXN5bmMgaGVhbHRoQ2hlY2soKTogUHJvbWlzZTx7XG4gICAgY29ubmVjdGVkOiBib29sZWFuO1xuICAgIG1pZ3JhdGlvbnNBcHBsaWVkOiBib29sZWFuO1xuICAgIHJsc0VuYWJsZWQ6IGJvb2xlYW47XG4gICAgdGFibGVzRXhpc3Q6IGJvb2xlYW47XG4gIH0+IHtcbiAgICB0cnkge1xuICAgICAgLy8gQ2hlY2sgY29ubmVjdGlvblxuICAgICAgY29uc3QgY29ubmVjdGVkID0gYXdhaXQgZGIuZXhlY3V0ZShzcWxgU0VMRUNUIDFgKS50aGVuKCgpID0+IHRydWUpLmNhdGNoKCgpID0+IGZhbHNlKTtcbiAgICAgIFxuICAgICAgLy8gQ2hlY2sgaWYgbWlncmF0aW9ucyB0YWJsZSBleGlzdHNcbiAgICAgIGNvbnN0IFttaWdyYXRpb25UYWJsZV0gPSBhd2FpdCBkYi5leGVjdXRlKHNxbGBcbiAgICAgICAgU0VMRUNUIEVYSVNUUyAoXG4gICAgICAgICAgU0VMRUNUIEZST00gaW5mb3JtYXRpb25fc2NoZW1hLnRhYmxlcyBcbiAgICAgICAgICBXSEVSRSB0YWJsZV9uYW1lID0gJ19fZHJpenpsZV9taWdyYXRpb25zJ1xuICAgICAgICApIGFzIGV4aXN0c1xuICAgICAgYCk7XG4gICAgICBjb25zdCBtaWdyYXRpb25zQXBwbGllZCA9IEJvb2xlYW4obWlncmF0aW9uVGFibGU/LmV4aXN0cykgfHwgZmFsc2U7XG5cbiAgICAgIC8vIENoZWNrIGlmIG1haW4gdGFibGVzIGV4aXN0XG4gICAgICBjb25zdCBbdGFibGVzQ2hlY2tdID0gYXdhaXQgZGIuZXhlY3V0ZShzcWxgXG4gICAgICAgIFNFTEVDVCBcbiAgICAgICAgICAoU0VMRUNUIENPVU5UKCopIEZST00gaW5mb3JtYXRpb25fc2NoZW1hLnRhYmxlcyBXSEVSRSB0YWJsZV9uYW1lIElOICgndXNlcnMnLCAncGxhbnRzJywgJ3BsYW50X2luc3RhbmNlcycsICdwcm9wYWdhdGlvbnMnLCAnc2Vzc2lvbnMnKSkgYXMgdGFibGVfY291bnRcbiAgICAgIGApO1xuICAgICAgY29uc3QgdGFibGVzRXhpc3QgPSBOdW1iZXIodGFibGVzQ2hlY2s/LnRhYmxlX2NvdW50KSA9PT0gNTtcblxuICAgICAgLy8gQ2hlY2sgaWYgUkxTIGlzIGVuYWJsZWQgb24gdXNlciB0YWJsZXNcbiAgICAgIGNvbnN0IFtybHNDaGVja10gPSBhd2FpdCBkYi5leGVjdXRlKHNxbGBcbiAgICAgICAgU0VMRUNUIENPVU5UKCopIGFzIHJsc19jb3VudFxuICAgICAgICBGUk9NIHBnX2NsYXNzIGNcbiAgICAgICAgSk9JTiBwZ19uYW1lc3BhY2UgbiBPTiBuLm9pZCA9IGMucmVsbmFtZXNwYWNlXG4gICAgICAgIFdIRVJFIGMucmVscm93c2VjdXJpdHkgPSB0cnVlIFxuICAgICAgICBBTkQgbi5uc3BuYW1lID0gJ3B1YmxpYydcbiAgICAgICAgQU5EIGMucmVsbmFtZSBJTiAoJ3BsYW50X2luc3RhbmNlcycsICdwcm9wYWdhdGlvbnMnLCAnc2Vzc2lvbnMnKVxuICAgICAgYCk7XG4gICAgICBjb25zdCBybHNFbmFibGVkID0gTnVtYmVyKHJsc0NoZWNrPy5ybHNfY291bnQpID09PSAzO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBjb25uZWN0ZWQsXG4gICAgICAgIG1pZ3JhdGlvbnNBcHBsaWVkLFxuICAgICAgICBybHNFbmFibGVkLFxuICAgICAgICB0YWJsZXNFeGlzdFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignSGVhbHRoIGNoZWNrIGZhaWxlZDonLCBlcnJvcik7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBjb25uZWN0ZWQ6IGZhbHNlLFxuICAgICAgICBtaWdyYXRpb25zQXBwbGllZDogZmFsc2UsXG4gICAgICAgIHJsc0VuYWJsZWQ6IGZhbHNlLFxuICAgICAgICB0YWJsZXNFeGlzdDogZmFsc2VcbiAgICAgIH07XG4gICAgfVxuICB9XG59Il0sIm5hbWVzIjpbIk1pZ3JhdGlvblV0aWxzIiwicnVuTWlncmF0aW9ucyIsImNvbnNvbGUiLCJsb2ciLCJkYiIsImV4ZWN1dGUiLCJzcWwiLCJlcnJvciIsIkVycm9yIiwiYXBwbHlSTFNQb2xpY2llcyIsInJsc1BhdGgiLCJwYXRoIiwiam9pbiIsInByb2Nlc3MiLCJjd2QiLCJmcyIsImV4aXN0c1N5bmMiLCJybHNTUUwiLCJyZWFkRmlsZVN5bmMiLCJzdGF0ZW1lbnRzIiwic3BsaXQiLCJtYXAiLCJzdG10IiwidHJpbSIsImZpbHRlciIsImxlbmd0aCIsInN0YXJ0c1dpdGgiLCJtYXRjaCIsInN0YXRlbWVudCIsImNsZWFuU3RhdGVtZW50IiwicmF3IiwibWVzc2FnZSIsImluY2x1ZGVzIiwic3Vic3RyaW5nIiwid2FybiIsInJvbGxiYWNrTGFzdE1pZ3JhdGlvbiIsImdldE1pZ3JhdGlvblN0YXR1cyIsInJlc3VsdCIsImFwcGxpZWRNaWdyYXRpb25zIiwiY291bnQiLCJtaWdyYXRpb25zUGF0aCIsInBlbmRpbmdNaWdyYXRpb25zIiwiZmlsZXMiLCJyZWFkZGlyU3luYyIsInNxbEZpbGVzIiwiZmlsZSIsImVuZHNXaXRoIiwicHVzaCIsIk51bWJlciIsInNlZWRJbml0aWFsRGF0YSIsInVzZXJDb3VudCIsImNvbW1vblBsYW50cyIsImZhbWlseSIsImdlbnVzIiwic3BlY2llcyIsImNvbW1vbk5hbWUiLCJjYXJlSW5zdHJ1Y3Rpb25zIiwiaXNWZXJpZmllZCIsInBsYW50IiwiaGVhbHRoQ2hlY2siLCJjb25uZWN0ZWQiLCJ0aGVuIiwiY2F0Y2giLCJtaWdyYXRpb25UYWJsZSIsIm1pZ3JhdGlvbnNBcHBsaWVkIiwiQm9vbGVhbiIsImV4aXN0cyIsInRhYmxlc0NoZWNrIiwidGFibGVzRXhpc3QiLCJ0YWJsZV9jb3VudCIsInJsc0NoZWNrIiwicmxzRW5hYmxlZCIsInJsc19jb3VudCJdLCJtYXBwaW5ncyI6Ijs7OzsrQkFRYUE7OztlQUFBQTs7O1FBUk47dUJBRVk7NEJBQ0M7MkRBQ0w7NkRBQ0U7Ozs7OztBQUdWLE1BQU1BO0lBQ1gsNkJBQTZCO0lBQzdCLGFBQWFDLGdCQUErQjtRQUMxQyxJQUFJO1lBQ0ZDLFFBQVFDLEdBQUcsQ0FBQztZQUVaLDhDQUE4QztZQUM5QyxNQUFNQyxTQUFFLENBQUNDLE9BQU8sQ0FBQ0MsSUFBQUEsZUFBRyxDQUFBLENBQUM7Ozs7OztNQU1yQixDQUFDO1lBRURKLFFBQVFDLEdBQUcsQ0FBQztRQUNkLEVBQUUsT0FBT0ksT0FBTztZQUNkTCxRQUFRSyxLQUFLLENBQUMscUJBQXFCQTtZQUNuQyxNQUFNLElBQUlDLE1BQU07UUFDbEI7SUFDRjtJQUVBLHFCQUFxQjtJQUNyQixhQUFhQyxtQkFBa0M7UUFDN0MsSUFBSTtZQUNGUCxRQUFRQyxHQUFHLENBQUM7WUFFWixNQUFNTyxVQUFVQyxhQUFJLENBQUNDLElBQUksQ0FBQ0MsUUFBUUMsR0FBRyxJQUFJLFdBQVc7WUFFcEQsSUFBSUMsV0FBRSxDQUFDQyxVQUFVLENBQUNOLFVBQVU7Z0JBQzFCLE1BQU1PLFNBQVNGLFdBQUUsQ0FBQ0csWUFBWSxDQUFDUixTQUFTO2dCQUV4Qyw2Q0FBNkM7Z0JBQzdDLE1BQU1TLGFBQWFGLE9BQ2hCRyxLQUFLLENBQUMsS0FDTkMsR0FBRyxDQUFDQyxDQUFBQSxPQUFRQSxLQUFLQyxJQUFJLElBQ3JCQyxNQUFNLENBQUNGLENBQUFB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